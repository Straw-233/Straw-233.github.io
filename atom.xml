<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Straw</title>
  
  <subtitle>Straw_blog</subtitle>
  <link href="https://straw-233.github.io/atom.xml" rel="self"/>
  
  <link href="https://straw-233.github.io/"/>
  <updated>2025-03-20T02:19:25.011Z</updated>
  <id>https://straw-233.github.io/</id>
  
  <author>
    <name>Straw</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>数美滑块登录校验</title>
    <link href="https://straw-233.github.io/2025/03/12/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C/"/>
    <id>https://straw-233.github.io/2025/03/12/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C/</id>
    <published>2025-03-12T06:36:24.736Z</published>
    <updated>2025-03-20T02:19:25.011Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数美滑块登录校验"><a href="#数美滑块登录校验" class="headerlink" title="数美滑块登录校验"></a>数美滑块登录校验</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在研究各大厂商app的登录算法时，发现很多厂商用的都是数美的登录验证，于是对其展开了逆向研究。</p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/1.png" alt="1"></p><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>因为这个还在迭代更新，我们以最新的184版本为例子</p><p><a href="https://www.ishumei.com/trial/captcha.html">智能验证码体验_图片验证码_数美科技</a></p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/2.png" alt="2"></p><p>几次发包下来发现会改变的只有tb，tm，ly，rid。于是只要研究这两个就行</p><p>rid可以在发送第一次请求的时候返回，可以直接获取。</p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/3.png" alt="3"></p><p>通过请求调用发现整个加密逻辑基本上写在了这个js里面</p><h2 id="JS逆向"><a href="#JS逆向" class="headerlink" title="JS逆向"></a>JS逆向</h2><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/4.png" alt="4"></p><p>进去发现是一个ob混淆过的js，用字符串形式查找相关加密函数，锁定了加密段。</p><p>继续跟进调试发现</p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/5.png" alt="5"></p><p>继续研究是否有DES魔改，混淆过的DES根本看不出来，想办法去混淆</p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/6.png" alt="6"></p><p>有一个很好用的反ob混淆的工具，因为js代码可以虚拟执行，反混淆起来不是特别难，这里的工具能应对绝大多数基础的ob混淆。</p><p><a href="https://obf-io.deobfuscate.io/">Obfuscator.io Deobfuscator</a></p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/7.png" alt="7"></p><p>反混淆后查看对应段代码，并在github上找到对应js写的des加密代码，进行比对</p><p><img src="/../img/%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C/8.png" alt="8"></p><p><a href="https://github.com/mdsimpson/contact-form-7-to-database-extension/blob/fd4ebfd7e04ac0d06287ff9076a5350c145a403b/des.js#L4">contact-form-7-to-database-extension&#x2F;des.js at fd4ebfd7e04ac0d06287ff9076a5350c145a403b · mdsimpson&#x2F;contact-form-7-to-database-extension · GitHub</a></p><p>于是只要通过动态调试获取每次加密的时候对应的固定密钥就行（密钥会随着版本改变）</p><h2 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h2><p> 得到了加密过程与密钥，我们尝试对发包数据进行还原，来理解每个名称被混淆了的数据的含义。</p><p>tb：滑动长度<br>tm：滑动轨迹<br>ly：滑动时间</p><p>于是我们通过opencv识图读出滑动长度，然后通过随机伪造滑动轨迹以及滑动时间，最后进行加密发包，就可以通过校验。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_distance</span>(<span class="params">fg, bg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算滑动距离</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 将二进制数据解码成 OpenCV 图像</span></span><br><span class="line">    target = cv2.imdecode(np.frombuffer(fg, np.uint8), cv2.IMREAD_COLOR)</span><br><span class="line">    template = cv2.imdecode(np.frombuffer(bg, np.uint8), cv2.IMREAD_COLOR)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行模板匹配</span></span><br><span class="line">    result = cv2.matchTemplate(target, template, cv2.TM_CCORR_NORMED)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取最大匹配值的位置</span></span><br><span class="line">    _, _, _, max_loc = cv2.minMaxLoc(result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 滑动距离（X 轴位移）</span></span><br><span class="line">    distance = max_loc[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> distance</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_trajectory_1</span>(<span class="params">distance</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    # 滑动轨迹模拟、上下的抖动</span></span><br><span class="line"><span class="string">    :param distance:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ge = []</span><br><span class="line">    ge.append([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        x = <span class="number">0</span></span><br><span class="line">        y = random.randint(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        t = <span class="number">100</span> * (i + <span class="number">1</span>) + random.randint(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        ge.append([x, y, t])</span><br><span class="line">    <span class="keyword">for</span> items <span class="keyword">in</span> ge[<span class="number">1</span>:-<span class="number">5</span>]:</span><br><span class="line">        items[<span class="number">0</span>] = distance // <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> items <span class="keyword">in</span> ge[-<span class="number">5</span>:-<span class="number">1</span>]:</span><br><span class="line">        items[<span class="number">0</span>] = distance + random.randint(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">    ge[-<span class="number">1</span>][<span class="number">0</span>] = distance</span><br><span class="line">    <span class="keyword">return</span> ge, ge[-<span class="number">1</span>][<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p>（主要内容在代码里面）</p><p><img src="/..%5Cimg%5C%E6%95%B0%E7%BE%8E%E6%BB%91%E5%9D%97%E6%A0%A1%E9%AA%8C%5C9.png" alt="9"></p><p>​                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>代码中间的python调用了js的des加密函数，虽然是标准ECB模式，但是还是秉持还原，使用了他的js源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_image</span>(<span class="params">url, save_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, stream=<span class="literal">True</span>)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_content(chunk_size=<span class="number">8192</span>):</span><br><span class="line">                f.write(chunk)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;图片已保存到: <span class="subst">&#123;save_path&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;请求失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;文件写入失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_image_name</span>(<span class="params">url</span>):</span><br><span class="line">    parsed_url = urlparse(url)</span><br><span class="line">    path = parsed_url.path</span><br><span class="line">    filename = os.path.basename(path)</span><br><span class="line">    <span class="keyword">return</span> filename</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_distance</span>(<span class="params">fg, bg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算滑动距离</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 将二进制数据解码成 OpenCV 图像</span></span><br><span class="line">    target = cv2.imdecode(np.frombuffer(fg, np.uint8), cv2.IMREAD_COLOR)</span><br><span class="line">    template = cv2.imdecode(np.frombuffer(bg, np.uint8), cv2.IMREAD_COLOR)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行模板匹配</span></span><br><span class="line">    result = cv2.matchTemplate(target, template, cv2.TM_CCORR_NORMED)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取最大匹配值的位置</span></span><br><span class="line">    _, _, _, max_loc = cv2.minMaxLoc(result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 滑动距离（X 轴位移）</span></span><br><span class="line">    distance = max_loc[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> distance</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_trajectory_1</span>(<span class="params">distance</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    # 滑动轨迹模拟、上下的抖动</span></span><br><span class="line"><span class="string">    :param distance:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ge = []</span><br><span class="line">    ge.append([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        x = <span class="number">0</span></span><br><span class="line">        y = random.randint(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        t = <span class="number">100</span> * (i + <span class="number">1</span>) + random.randint(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        ge.append([x, y, t])</span><br><span class="line">    <span class="keyword">for</span> items <span class="keyword">in</span> ge[<span class="number">1</span>:-<span class="number">5</span>]:</span><br><span class="line">        items[<span class="number">0</span>] = distance // <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> items <span class="keyword">in</span> ge[-<span class="number">5</span>:-<span class="number">1</span>]:</span><br><span class="line">        items[<span class="number">0</span>] = distance + random.randint(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">    ge[-<span class="number">1</span>][<span class="number">0</span>] = distance</span><br><span class="line">    <span class="keyword">return</span> ge, ge[-<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://captcha1.fengkongcloud.cn/ca/v1/register?rversion=1.0.4&amp;data=%7B%7D&amp;sdkver=1.1.3&amp;appId=default&amp;organization=d6tpAY1oV0Kv5jRSgxQr&amp;channel=DEFAULT&amp;model=slide&amp;captchaUuid=20250305105115Bm57raYJCRpc55zYYE&amp;lang=zh-cn&amp;callback=sm_1741164621240&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">text=response.text.split(<span class="string">&#x27;(&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].rstrip(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">data = json.loads(text)</span><br><span class="line">detail = data[<span class="string">&#x27;detail&#x27;</span>]</span><br><span class="line"></span><br><span class="line">rid = detail[<span class="string">&#x27;rid&#x27;</span>]</span><br><span class="line">fg = <span class="string">&quot;https://castatic.fengkongcloud.cn&quot;</span>+detail[<span class="string">&#x27;fg&#x27;</span>]</span><br><span class="line">fg_name=get_image_name(fg)</span><br><span class="line">bg = <span class="string">&quot;https://castatic.fengkongcloud.cn&quot;</span>+detail[<span class="string">&#x27;bg&#x27;</span>]</span><br><span class="line">bg_name=get_image_name(bg)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;rid: <span class="subst">&#123;rid&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;fg: <span class="subst">&#123;fg&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;bg: <span class="subst">&#123;bg&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">download_image(fg,fg_name)</span><br><span class="line">download_image(bg,bg_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(fg_name, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    fg_data = f.read()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(bg_name, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    bg_data = f.read()</span><br><span class="line">distance = get_distance(fg_data, bg_data)</span><br><span class="line"><span class="comment"># print(distance)</span></span><br><span class="line"><span class="comment"># print(get_trajectory_1(distance//2))</span></span><br><span class="line">tb=<span class="built_in">round</span>((distance//<span class="number">2</span>)/<span class="number">300</span>,<span class="number">2</span>)</span><br><span class="line">tm,ly=get_trajectory_1(distance//<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#des加密</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;des.js&quot;</span>, <span class="string">&quot;r&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    js_code = f.read()</span><br><span class="line">ctx = execjs.<span class="built_in">compile</span>(js_code)</span><br><span class="line"><span class="built_in">print</span>(tb)</span><br><span class="line"></span><br><span class="line">tm_f= <span class="string">&quot;[&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    <span class="string">&quot;,&quot;</span>.join(</span><br><span class="line">        <span class="string">&quot;[&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;,&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, sublist)))</span><br><span class="line">        <span class="keyword">for</span> sublist <span class="keyword">in</span> tm</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(tm_f)</span><br><span class="line"><span class="built_in">print</span>(ly)</span><br><span class="line">tb = ctx.call(<span class="string">&quot;des&quot;</span>,<span class="string">&quot;59fcff86&quot;</span>,<span class="built_in">str</span>(tb),<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">tm = ctx.call(<span class="string">&quot;des&quot;</span>,<span class="string">&quot;0569c403&quot;</span>,tm_f,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">ly = ctx.call(<span class="string">&quot;des&quot;</span>,<span class="string">&quot;65986a6b&quot;</span>,<span class="built_in">str</span>(ly),<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tb:&quot;</span>+tb)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tm:&quot;</span>+tm)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ly:&quot;</span>+ly)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">params = &#123;</span><br><span class="line"><span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;184&quot;</span>,</span><br><span class="line"><span class="string">&quot;rversion&quot;</span>: <span class="string">&quot;1.0.4&quot;</span>,</span><br><span class="line"><span class="string">&quot;wz&quot;</span>: <span class="string">&quot;ufdT5h7SVes&quot;</span>,</span><br><span class="line"><span class="string">&quot;sdkver&quot;</span>: <span class="string">&quot;1.1.3&quot;</span>,</span><br><span class="line"><span class="string">&quot;ostype&quot;</span>: <span class="string">&quot;web&quot;</span>,</span><br><span class="line"><span class="string">&quot;callback&quot;</span>: <span class="string">&quot;sm_1741168009359&quot;</span>,</span><br><span class="line"><span class="string">&quot;captchaUuid&quot;</span>: <span class="string">&quot;20250319154825Jwyse6rxSRbxbBRtCa&quot;</span>,</span><br><span class="line"><span class="string">&quot;organization&quot;</span>: <span class="string">&quot;d6tpAY1oV0Kv5jRSgxQr&quot;</span>,</span><br><span class="line"><span class="string">&quot;fc&quot;</span>: <span class="string">&quot;2VKLJM6OJCc=&quot;</span>,</span><br><span class="line"><span class="string">&quot;uc&quot;</span>: <span class="string">&quot;b8IY1XIB1iA=&quot;</span>,</span><br><span class="line"><span class="string">&quot;og&quot;</span>: <span class="string">&quot;IxbGpVfruz0=&quot;</span>,</span><br><span class="line"><span class="string">&quot;jp&quot;</span>: <span class="string">&quot;Wq4jwGqOHYM=&quot;</span>,</span><br><span class="line"><span class="string">&quot;aj&quot;</span>: <span class="string">&quot;Z8JptdSbQHg=&quot;</span>,</span><br><span class="line"><span class="string">&quot;dj&quot;</span>: <span class="string">&quot;7SnISxDhfjI=&quot;</span>,</span><br><span class="line"><span class="string">&quot;gp&quot;</span>: <span class="string">&quot;7kP9OL4ZRNU=&quot;</span>,</span><br><span class="line"><span class="string">&quot;sy&quot;</span>: <span class="string">&quot;lN908/15DcI=&quot;</span>,</span><br><span class="line"><span class="string">&quot;tb&quot;</span>: tb,</span><br><span class="line"><span class="string">&quot;tm&quot;</span>: tm,</span><br><span class="line"><span class="string">&quot;ly&quot;</span>: ly,</span><br><span class="line"><span class="string">&quot;rid&quot;</span>:rid</span><br><span class="line">&#125;</span><br><span class="line">query_string = urlencode(params, safe=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">base_url = <span class="string">&quot;https://captcha1.fengkongcloud.cn/ca/v2/fverify?&quot;</span></span><br><span class="line">url2=<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span><span class="subst">&#123;query_string&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">print</span>(url2)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="built_in">print</span>(requests.get(url2).text)</span><br><span class="line"></span><br><span class="line">os.remove(fg_name)</span><br><span class="line">os.remove(bg_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">des</span> (key, message, encrypt, mode, iv) &#123;</span><br><span class="line">    <span class="comment">//declaring this locally speeds things up a bit</span></span><br><span class="line">    <span class="keyword">var</span> spfunction1 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x1010400</span>,<span class="number">0</span>,<span class="number">0x10000</span>,<span class="number">0x1010404</span>,<span class="number">0x1010004</span>,<span class="number">0x10404</span>,<span class="number">0x4</span>,<span class="number">0x10000</span>,<span class="number">0x400</span>,<span class="number">0x1010400</span>,<span class="number">0x1010404</span>,<span class="number">0x400</span>,<span class="number">0x1000404</span>,<span class="number">0x1010004</span>,<span class="number">0x1000000</span>,<span class="number">0x4</span>,<span class="number">0x404</span>,<span class="number">0x1000400</span>,<span class="number">0x1000400</span>,<span class="number">0x10400</span>,<span class="number">0x10400</span>,<span class="number">0x1010000</span>,<span class="number">0x1010000</span>,<span class="number">0x1000404</span>,<span class="number">0x10004</span>,<span class="number">0x1000004</span>,<span class="number">0x1000004</span>,<span class="number">0x10004</span>,<span class="number">0</span>,<span class="number">0x404</span>,<span class="number">0x10404</span>,<span class="number">0x1000000</span>,<span class="number">0x10000</span>,<span class="number">0x1010404</span>,<span class="number">0x4</span>,<span class="number">0x1010000</span>,<span class="number">0x1010400</span>,<span class="number">0x1000000</span>,<span class="number">0x1000000</span>,<span class="number">0x400</span>,<span class="number">0x1010004</span>,<span class="number">0x10000</span>,<span class="number">0x10400</span>,<span class="number">0x1000004</span>,<span class="number">0x400</span>,<span class="number">0x4</span>,<span class="number">0x1000404</span>,<span class="number">0x10404</span>,<span class="number">0x1010404</span>,<span class="number">0x10004</span>,<span class="number">0x1010000</span>,<span class="number">0x1000404</span>,<span class="number">0x1000004</span>,<span class="number">0x404</span>,<span class="number">0x10404</span>,<span class="number">0x1010400</span>,<span class="number">0x404</span>,<span class="number">0x1000400</span>,<span class="number">0x1000400</span>,<span class="number">0</span>,<span class="number">0x10004</span>,<span class="number">0x10400</span>,<span class="number">0</span>,<span class="number">0x1010004</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction2 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x80108020</span>,<span class="number">0x80008000</span>,<span class="number">0x8000</span>,<span class="number">0x108020</span>,<span class="number">0x100000</span>,<span class="number">0x20</span>,<span class="number">0x80100020</span>,<span class="number">0x80008020</span>,<span class="number">0x80000020</span>,<span class="number">0x80108020</span>,<span class="number">0x80108000</span>,<span class="number">0x80000000</span>,<span class="number">0x80008000</span>,<span class="number">0x100000</span>,<span class="number">0x20</span>,<span class="number">0x80100020</span>,<span class="number">0x108000</span>,<span class="number">0x100020</span>,<span class="number">0x80008020</span>,<span class="number">0</span>,<span class="number">0x80000000</span>,<span class="number">0x8000</span>,<span class="number">0x108020</span>,<span class="number">0x80100000</span>,<span class="number">0x100020</span>,<span class="number">0x80000020</span>,<span class="number">0</span>,<span class="number">0x108000</span>,<span class="number">0x8020</span>,<span class="number">0x80108000</span>,<span class="number">0x80100000</span>,<span class="number">0x8020</span>,<span class="number">0</span>,<span class="number">0x108020</span>,<span class="number">0x80100020</span>,<span class="number">0x100000</span>,<span class="number">0x80008020</span>,<span class="number">0x80100000</span>,<span class="number">0x80108000</span>,<span class="number">0x8000</span>,<span class="number">0x80100000</span>,<span class="number">0x80008000</span>,<span class="number">0x20</span>,<span class="number">0x80108020</span>,<span class="number">0x108020</span>,<span class="number">0x20</span>,<span class="number">0x8000</span>,<span class="number">0x80000000</span>,<span class="number">0x8020</span>,<span class="number">0x80108000</span>,<span class="number">0x100000</span>,<span class="number">0x80000020</span>,<span class="number">0x100020</span>,<span class="number">0x80008020</span>,<span class="number">0x80000020</span>,<span class="number">0x100020</span>,<span class="number">0x108000</span>,<span class="number">0</span>,<span class="number">0x80008000</span>,<span class="number">0x8020</span>,<span class="number">0x80000000</span>,<span class="number">0x80100020</span>,<span class="number">0x80108020</span>,<span class="number">0x108000</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction3 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x208</span>,<span class="number">0x8020200</span>,<span class="number">0</span>,<span class="number">0x8020008</span>,<span class="number">0x8000200</span>,<span class="number">0</span>,<span class="number">0x20208</span>,<span class="number">0x8000200</span>,<span class="number">0x20008</span>,<span class="number">0x8000008</span>,<span class="number">0x8000008</span>,<span class="number">0x20000</span>,<span class="number">0x8020208</span>,<span class="number">0x20008</span>,<span class="number">0x8020000</span>,<span class="number">0x208</span>,<span class="number">0x8000000</span>,<span class="number">0x8</span>,<span class="number">0x8020200</span>,<span class="number">0x200</span>,<span class="number">0x20200</span>,<span class="number">0x8020000</span>,<span class="number">0x8020008</span>,<span class="number">0x20208</span>,<span class="number">0x8000208</span>,<span class="number">0x20200</span>,<span class="number">0x20000</span>,<span class="number">0x8000208</span>,<span class="number">0x8</span>,<span class="number">0x8020208</span>,<span class="number">0x200</span>,<span class="number">0x8000000</span>,<span class="number">0x8020200</span>,<span class="number">0x8000000</span>,<span class="number">0x20008</span>,<span class="number">0x208</span>,<span class="number">0x20000</span>,<span class="number">0x8020200</span>,<span class="number">0x8000200</span>,<span class="number">0</span>,<span class="number">0x200</span>,<span class="number">0x20008</span>,<span class="number">0x8020208</span>,<span class="number">0x8000200</span>,<span class="number">0x8000008</span>,<span class="number">0x200</span>,<span class="number">0</span>,<span class="number">0x8020008</span>,<span class="number">0x8000208</span>,<span class="number">0x20000</span>,<span class="number">0x8000000</span>,<span class="number">0x8020208</span>,<span class="number">0x8</span>,<span class="number">0x20208</span>,<span class="number">0x20200</span>,<span class="number">0x8000008</span>,<span class="number">0x8020000</span>,<span class="number">0x8000208</span>,<span class="number">0x208</span>,<span class="number">0x8020000</span>,<span class="number">0x20208</span>,<span class="number">0x8</span>,<span class="number">0x8020008</span>,<span class="number">0x20200</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction4 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x802001</span>,<span class="number">0x2081</span>,<span class="number">0x2081</span>,<span class="number">0x80</span>,<span class="number">0x802080</span>,<span class="number">0x800081</span>,<span class="number">0x800001</span>,<span class="number">0x2001</span>,<span class="number">0</span>,<span class="number">0x802000</span>,<span class="number">0x802000</span>,<span class="number">0x802081</span>,<span class="number">0x81</span>,<span class="number">0</span>,<span class="number">0x800080</span>,<span class="number">0x800001</span>,<span class="number">0x1</span>,<span class="number">0x2000</span>,<span class="number">0x800000</span>,<span class="number">0x802001</span>,<span class="number">0x80</span>,<span class="number">0x800000</span>,<span class="number">0x2001</span>,<span class="number">0x2080</span>,<span class="number">0x800081</span>,<span class="number">0x1</span>,<span class="number">0x2080</span>,<span class="number">0x800080</span>,<span class="number">0x2000</span>,<span class="number">0x802080</span>,<span class="number">0x802081</span>,<span class="number">0x81</span>,<span class="number">0x800080</span>,<span class="number">0x800001</span>,<span class="number">0x802000</span>,<span class="number">0x802081</span>,<span class="number">0x81</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x802000</span>,<span class="number">0x2080</span>,<span class="number">0x800080</span>,<span class="number">0x800081</span>,<span class="number">0x1</span>,<span class="number">0x802001</span>,<span class="number">0x2081</span>,<span class="number">0x2081</span>,<span class="number">0x80</span>,<span class="number">0x802081</span>,<span class="number">0x81</span>,<span class="number">0x1</span>,<span class="number">0x2000</span>,<span class="number">0x800001</span>,<span class="number">0x2001</span>,<span class="number">0x802080</span>,<span class="number">0x800081</span>,<span class="number">0x2001</span>,<span class="number">0x2080</span>,<span class="number">0x800000</span>,<span class="number">0x802001</span>,<span class="number">0x80</span>,<span class="number">0x800000</span>,<span class="number">0x2000</span>,<span class="number">0x802080</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction5 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x100</span>,<span class="number">0x2080100</span>,<span class="number">0x2080000</span>,<span class="number">0x42000100</span>,<span class="number">0x80000</span>,<span class="number">0x100</span>,<span class="number">0x40000000</span>,<span class="number">0x2080000</span>,<span class="number">0x40080100</span>,<span class="number">0x80000</span>,<span class="number">0x2000100</span>,<span class="number">0x40080100</span>,<span class="number">0x42000100</span>,<span class="number">0x42080000</span>,<span class="number">0x80100</span>,<span class="number">0x40000000</span>,<span class="number">0x2000000</span>,<span class="number">0x40080000</span>,<span class="number">0x40080000</span>,<span class="number">0</span>,<span class="number">0x40000100</span>,<span class="number">0x42080100</span>,<span class="number">0x42080100</span>,<span class="number">0x2000100</span>,<span class="number">0x42080000</span>,<span class="number">0x40000100</span>,<span class="number">0</span>,<span class="number">0x42000000</span>,<span class="number">0x2080100</span>,<span class="number">0x2000000</span>,<span class="number">0x42000000</span>,<span class="number">0x80100</span>,<span class="number">0x80000</span>,<span class="number">0x42000100</span>,<span class="number">0x100</span>,<span class="number">0x2000000</span>,<span class="number">0x40000000</span>,<span class="number">0x2080000</span>,<span class="number">0x42000100</span>,<span class="number">0x40080100</span>,<span class="number">0x2000100</span>,<span class="number">0x40000000</span>,<span class="number">0x42080000</span>,<span class="number">0x2080100</span>,<span class="number">0x40080100</span>,<span class="number">0x100</span>,<span class="number">0x2000000</span>,<span class="number">0x42080000</span>,<span class="number">0x42080100</span>,<span class="number">0x80100</span>,<span class="number">0x42000000</span>,<span class="number">0x42080100</span>,<span class="number">0x2080000</span>,<span class="number">0</span>,<span class="number">0x40080000</span>,<span class="number">0x42000000</span>,<span class="number">0x80100</span>,<span class="number">0x2000100</span>,<span class="number">0x40000100</span>,<span class="number">0x80000</span>,<span class="number">0</span>,<span class="number">0x40080000</span>,<span class="number">0x2080100</span>,<span class="number">0x40000100</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction6 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x20000010</span>,<span class="number">0x20400000</span>,<span class="number">0x4000</span>,<span class="number">0x20404010</span>,<span class="number">0x20400000</span>,<span class="number">0x10</span>,<span class="number">0x20404010</span>,<span class="number">0x400000</span>,<span class="number">0x20004000</span>,<span class="number">0x404010</span>,<span class="number">0x400000</span>,<span class="number">0x20000010</span>,<span class="number">0x400010</span>,<span class="number">0x20004000</span>,<span class="number">0x20000000</span>,<span class="number">0x4010</span>,<span class="number">0</span>,<span class="number">0x400010</span>,<span class="number">0x20004010</span>,<span class="number">0x4000</span>,<span class="number">0x404000</span>,<span class="number">0x20004010</span>,<span class="number">0x10</span>,<span class="number">0x20400010</span>,<span class="number">0x20400010</span>,<span class="number">0</span>,<span class="number">0x404010</span>,<span class="number">0x20404000</span>,<span class="number">0x4010</span>,<span class="number">0x404000</span>,<span class="number">0x20404000</span>,<span class="number">0x20000000</span>,<span class="number">0x20004000</span>,<span class="number">0x10</span>,<span class="number">0x20400010</span>,<span class="number">0x404000</span>,<span class="number">0x20404010</span>,<span class="number">0x400000</span>,<span class="number">0x4010</span>,<span class="number">0x20000010</span>,<span class="number">0x400000</span>,<span class="number">0x20004000</span>,<span class="number">0x20000000</span>,<span class="number">0x4010</span>,<span class="number">0x20000010</span>,<span class="number">0x20404010</span>,<span class="number">0x404000</span>,<span class="number">0x20400000</span>,<span class="number">0x404010</span>,<span class="number">0x20404000</span>,<span class="number">0</span>,<span class="number">0x20400010</span>,<span class="number">0x10</span>,<span class="number">0x4000</span>,<span class="number">0x20400000</span>,<span class="number">0x404010</span>,<span class="number">0x4000</span>,<span class="number">0x400010</span>,<span class="number">0x20004010</span>,<span class="number">0</span>,<span class="number">0x20404000</span>,<span class="number">0x20000000</span>,<span class="number">0x400010</span>,<span class="number">0x20004010</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction7 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x200000</span>,<span class="number">0x4200002</span>,<span class="number">0x4000802</span>,<span class="number">0</span>,<span class="number">0x800</span>,<span class="number">0x4000802</span>,<span class="number">0x200802</span>,<span class="number">0x4200800</span>,<span class="number">0x4200802</span>,<span class="number">0x200000</span>,<span class="number">0</span>,<span class="number">0x4000002</span>,<span class="number">0x2</span>,<span class="number">0x4000000</span>,<span class="number">0x4200002</span>,<span class="number">0x802</span>,<span class="number">0x4000800</span>,<span class="number">0x200802</span>,<span class="number">0x200002</span>,<span class="number">0x4000800</span>,<span class="number">0x4000002</span>,<span class="number">0x4200000</span>,<span class="number">0x4200800</span>,<span class="number">0x200002</span>,<span class="number">0x4200000</span>,<span class="number">0x800</span>,<span class="number">0x802</span>,<span class="number">0x4200802</span>,<span class="number">0x200800</span>,<span class="number">0x2</span>,<span class="number">0x4000000</span>,<span class="number">0x200800</span>,<span class="number">0x4000000</span>,<span class="number">0x200800</span>,<span class="number">0x200000</span>,<span class="number">0x4000802</span>,<span class="number">0x4000802</span>,<span class="number">0x4200002</span>,<span class="number">0x4200002</span>,<span class="number">0x2</span>,<span class="number">0x200002</span>,<span class="number">0x4000000</span>,<span class="number">0x4000800</span>,<span class="number">0x200000</span>,<span class="number">0x4200800</span>,<span class="number">0x802</span>,<span class="number">0x200802</span>,<span class="number">0x4200800</span>,<span class="number">0x802</span>,<span class="number">0x4000002</span>,<span class="number">0x4200802</span>,<span class="number">0x4200000</span>,<span class="number">0x200800</span>,<span class="number">0</span>,<span class="number">0x2</span>,<span class="number">0x4200802</span>,<span class="number">0</span>,<span class="number">0x200802</span>,<span class="number">0x4200000</span>,<span class="number">0x800</span>,<span class="number">0x4000002</span>,<span class="number">0x4000800</span>,<span class="number">0x800</span>,<span class="number">0x200002</span>);</span><br><span class="line">    <span class="keyword">var</span> spfunction8 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0x10001040</span>,<span class="number">0x1000</span>,<span class="number">0x40000</span>,<span class="number">0x10041040</span>,<span class="number">0x10000000</span>,<span class="number">0x10001040</span>,<span class="number">0x40</span>,<span class="number">0x10000000</span>,<span class="number">0x40040</span>,<span class="number">0x10040000</span>,<span class="number">0x10041040</span>,<span class="number">0x41000</span>,<span class="number">0x10041000</span>,<span class="number">0x41040</span>,<span class="number">0x1000</span>,<span class="number">0x40</span>,<span class="number">0x10040000</span>,<span class="number">0x10000040</span>,<span class="number">0x10001000</span>,<span class="number">0x1040</span>,<span class="number">0x41000</span>,<span class="number">0x40040</span>,<span class="number">0x10040040</span>,<span class="number">0x10041000</span>,<span class="number">0x1040</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x10040040</span>,<span class="number">0x10000040</span>,<span class="number">0x10001000</span>,<span class="number">0x41040</span>,<span class="number">0x40000</span>,<span class="number">0x41040</span>,<span class="number">0x40000</span>,<span class="number">0x10041000</span>,<span class="number">0x1000</span>,<span class="number">0x40</span>,<span class="number">0x10040040</span>,<span class="number">0x1000</span>,<span class="number">0x41040</span>,<span class="number">0x10001000</span>,<span class="number">0x40</span>,<span class="number">0x10000040</span>,<span class="number">0x10040000</span>,<span class="number">0x10040040</span>,<span class="number">0x10000000</span>,<span class="number">0x40000</span>,<span class="number">0x10001040</span>,<span class="number">0</span>,<span class="number">0x10041040</span>,<span class="number">0x40040</span>,<span class="number">0x10000040</span>,<span class="number">0x10040000</span>,<span class="number">0x10001000</span>,<span class="number">0x10001040</span>,<span class="number">0</span>,<span class="number">0x10041040</span>,<span class="number">0x41000</span>,<span class="number">0x41000</span>,<span class="number">0x1040</span>,<span class="number">0x1040</span>,<span class="number">0x40040</span>,<span class="number">0x10000000</span>,<span class="number">0x10041000</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//create the 16 or 48 subkeys we will need</span></span><br><span class="line">    <span class="keyword">var</span> keys = des_createKeys (key);</span><br><span class="line">    <span class="keyword">var</span> m=<span class="number">0</span>, i, j, temp, temp2, right1, right2, left, right, looping;</span><br><span class="line">    <span class="keyword">var</span> cbcleft, cbcleft2, cbcright, cbcright2</span><br><span class="line">    <span class="keyword">var</span> endloop, loopinc;</span><br><span class="line">    <span class="keyword">var</span> len = message.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> chunk = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//set up the loops for single and triple des</span></span><br><span class="line">    <span class="keyword">var</span> iterations = keys.<span class="property">length</span> == <span class="number">32</span> ? <span class="number">3</span> : <span class="number">9</span>; <span class="comment">//single or triple des</span></span><br><span class="line">    <span class="keyword">if</span> (iterations == <span class="number">3</span>) &#123;looping = encrypt ? <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>, <span class="number">32</span>, <span class="number">2</span>) : <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">30</span>, -<span class="number">2</span>, -<span class="number">2</span>);&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;looping = encrypt ? <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>, <span class="number">32</span>, <span class="number">2</span>, <span class="number">62</span>, <span class="number">30</span>, -<span class="number">2</span>, <span class="number">64</span>, <span class="number">96</span>, <span class="number">2</span>) : <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">94</span>, <span class="number">62</span>, -<span class="number">2</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">2</span>, <span class="number">30</span>, -<span class="number">2</span>, -<span class="number">2</span>);&#125;</span><br><span class="line">  </span><br><span class="line">    message += <span class="string">&quot;\0\0\0\0\0\0\0\0&quot;</span>; <span class="comment">//pad the message out with null bytes</span></span><br><span class="line">    <span class="comment">//store the result here</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    tempresult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (mode == <span class="number">1</span>) &#123; <span class="comment">//CBC mode</span></span><br><span class="line">      cbcleft = (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | iv.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">      cbcright = (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (iv.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | iv.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">      m=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//loop through each 64 bit chunk of the message</span></span><br><span class="line">    <span class="keyword">while</span> (m &lt; len) &#123;</span><br><span class="line">      left = (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | message.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">      right = (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (message.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | message.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">  </span><br><span class="line">      <span class="comment">//for Cipher Block Chaining mode, xor the message with the previous result</span></span><br><span class="line">      <span class="keyword">if</span> (mode == <span class="number">1</span>) &#123;<span class="keyword">if</span> (encrypt) &#123;left ^= cbcleft; right ^= cbcright;&#125; <span class="keyword">else</span> &#123;cbcleft2 = cbcleft; cbcright2 = cbcright; cbcleft = left; cbcright = right;&#125;&#125;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">//first each 64 but chunk of the message must be permuted according to IP</span></span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">4</span>) ^ right) &amp; <span class="number">0x0f0f0f0f</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">4</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">16</span>) ^ right) &amp; <span class="number">0x0000ffff</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">16</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; <span class="number">2</span>) ^ left) &amp; <span class="number">0x33333333</span>; left ^= temp; right ^= (temp &lt;&lt; <span class="number">2</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; <span class="number">8</span>) ^ left) &amp; <span class="number">0x00ff00ff</span>; left ^= temp; right ^= (temp &lt;&lt; <span class="number">8</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">1</span>) ^ right) &amp; <span class="number">0x55555555</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">      left = ((left &lt;&lt; <span class="number">1</span>) | (left &gt;&gt;&gt; <span class="number">31</span>)); </span><br><span class="line">      right = ((right &lt;&lt; <span class="number">1</span>) | (right &gt;&gt;&gt; <span class="number">31</span>)); </span><br><span class="line">  </span><br><span class="line">      <span class="comment">//do this either 1 or 3 times for each chunk of the message</span></span><br><span class="line">      <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;iterations; j+=<span class="number">3</span>) &#123;</span><br><span class="line">        endloop = looping[j+<span class="number">1</span>];</span><br><span class="line">        loopinc = looping[j+<span class="number">2</span>];</span><br><span class="line">        <span class="comment">//now go through and perform the encryption or decryption  </span></span><br><span class="line">        <span class="keyword">for</span> (i=looping[j]; i!=endloop; i+=loopinc) &#123; <span class="comment">//for efficiency</span></span><br><span class="line">          right1 = right ^ keys[i]; </span><br><span class="line">          right2 = ((right &gt;&gt;&gt; <span class="number">4</span>) | (right &lt;&lt; <span class="number">28</span>)) ^ keys[i+<span class="number">1</span>];</span><br><span class="line">          <span class="comment">//the result is attained by passing these bytes through the S selection functions</span></span><br><span class="line">          temp = left;</span><br><span class="line">          left = right;</span><br><span class="line">          right = temp ^ (spfunction2[(right1 &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x3f</span>] | spfunction4[(right1 &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x3f</span>]</span><br><span class="line">                | spfunction6[(right1 &gt;&gt;&gt;  <span class="number">8</span>) &amp; <span class="number">0x3f</span>] | spfunction8[right1 &amp; <span class="number">0x3f</span>]</span><br><span class="line">                | spfunction1[(right2 &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x3f</span>] | spfunction3[(right2 &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x3f</span>]</span><br><span class="line">                | spfunction5[(right2 &gt;&gt;&gt;  <span class="number">8</span>) &amp; <span class="number">0x3f</span>] | spfunction7[right2 &amp; <span class="number">0x3f</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        temp = left; left = right; right = temp; <span class="comment">//unreverse left and right</span></span><br><span class="line">      &#125; <span class="comment">//for either 1 or 3 iterations</span></span><br><span class="line">  </span><br><span class="line">      <span class="comment">//move then each one bit to the right</span></span><br><span class="line">      left = ((left &gt;&gt;&gt; <span class="number">1</span>) | (left &lt;&lt; <span class="number">31</span>)); </span><br><span class="line">      right = ((right &gt;&gt;&gt; <span class="number">1</span>) | (right &lt;&lt; <span class="number">31</span>)); </span><br><span class="line">  </span><br><span class="line">      <span class="comment">//now perform IP-1, which is IP in the opposite direction</span></span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">1</span>) ^ right) &amp; <span class="number">0x55555555</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">1</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; <span class="number">8</span>) ^ left) &amp; <span class="number">0x00ff00ff</span>; left ^= temp; right ^= (temp &lt;&lt; <span class="number">8</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; <span class="number">2</span>) ^ left) &amp; <span class="number">0x33333333</span>; left ^= temp; right ^= (temp &lt;&lt; <span class="number">2</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">16</span>) ^ right) &amp; <span class="number">0x0000ffff</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">16</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">4</span>) ^ right) &amp; <span class="number">0x0f0f0f0f</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">4</span>);</span><br><span class="line">  </span><br><span class="line">      <span class="comment">//for Cipher Block Chaining mode, xor the message with the previous result</span></span><br><span class="line">      <span class="keyword">if</span> (mode == <span class="number">1</span>) &#123;<span class="keyword">if</span> (encrypt) &#123;cbcleft = left; cbcright = right;&#125; <span class="keyword">else</span> &#123;left ^= cbcleft2; right ^= cbcright2;&#125;&#125;</span><br><span class="line">      tempresult += <span class="title class_">String</span>.<span class="property">fromCharCode</span> ((left&gt;&gt;&gt;<span class="number">24</span>), ((left&gt;&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xff</span>), ((left&gt;&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0xff</span>), (left &amp; <span class="number">0xff</span>), (right&gt;&gt;&gt;<span class="number">24</span>), ((right&gt;&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xff</span>), ((right&gt;&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0xff</span>), (right &amp; <span class="number">0xff</span>));</span><br><span class="line">  </span><br><span class="line">      chunk += <span class="number">8</span>;</span><br><span class="line">      <span class="keyword">if</span> (chunk == <span class="number">512</span>) &#123;result += tempresult; tempresult = <span class="string">&quot;&quot;</span>; chunk = <span class="number">0</span>;&#125;</span><br><span class="line">    &#125; <span class="comment">//for every 8 characters, or 64 bits in the message</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">//return the result as an array</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">btoa</span>(result + tempresult);</span><br><span class="line">  &#125; <span class="comment">//end of des</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">//des_createKeys</span></span><br><span class="line">  <span class="comment">//this takes as input a 64 bit key (even though only 56 bits are used)</span></span><br><span class="line">  <span class="comment">//as an array of 2 integers, and returns 16 48 bit keys</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">des_createKeys</span> (key) &#123;</span><br><span class="line">    <span class="comment">//declaring this locally speeds things up a bit</span></span><br><span class="line">    pc2bytes0  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x4</span>,<span class="number">0x20000000</span>,<span class="number">0x20000004</span>,<span class="number">0x10000</span>,<span class="number">0x10004</span>,<span class="number">0x20010000</span>,<span class="number">0x20010004</span>,<span class="number">0x200</span>,<span class="number">0x204</span>,<span class="number">0x20000200</span>,<span class="number">0x20000204</span>,<span class="number">0x10200</span>,<span class="number">0x10204</span>,<span class="number">0x20010200</span>,<span class="number">0x20010204</span>);</span><br><span class="line">    pc2bytes1  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x1</span>,<span class="number">0x100000</span>,<span class="number">0x100001</span>,<span class="number">0x4000000</span>,<span class="number">0x4000001</span>,<span class="number">0x4100000</span>,<span class="number">0x4100001</span>,<span class="number">0x100</span>,<span class="number">0x101</span>,<span class="number">0x100100</span>,<span class="number">0x100101</span>,<span class="number">0x4000100</span>,<span class="number">0x4000101</span>,<span class="number">0x4100100</span>,<span class="number">0x4100101</span>);</span><br><span class="line">    pc2bytes2  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x8</span>,<span class="number">0x800</span>,<span class="number">0x808</span>,<span class="number">0x1000000</span>,<span class="number">0x1000008</span>,<span class="number">0x1000800</span>,<span class="number">0x1000808</span>,<span class="number">0</span>,<span class="number">0x8</span>,<span class="number">0x800</span>,<span class="number">0x808</span>,<span class="number">0x1000000</span>,<span class="number">0x1000008</span>,<span class="number">0x1000800</span>,<span class="number">0x1000808</span>);</span><br><span class="line">    pc2bytes3  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x200000</span>,<span class="number">0x8000000</span>,<span class="number">0x8200000</span>,<span class="number">0x2000</span>,<span class="number">0x202000</span>,<span class="number">0x8002000</span>,<span class="number">0x8202000</span>,<span class="number">0x20000</span>,<span class="number">0x220000</span>,<span class="number">0x8020000</span>,<span class="number">0x8220000</span>,<span class="number">0x22000</span>,<span class="number">0x222000</span>,<span class="number">0x8022000</span>,<span class="number">0x8222000</span>);</span><br><span class="line">    pc2bytes4  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x40000</span>,<span class="number">0x10</span>,<span class="number">0x40010</span>,<span class="number">0</span>,<span class="number">0x40000</span>,<span class="number">0x10</span>,<span class="number">0x40010</span>,<span class="number">0x1000</span>,<span class="number">0x41000</span>,<span class="number">0x1010</span>,<span class="number">0x41010</span>,<span class="number">0x1000</span>,<span class="number">0x41000</span>,<span class="number">0x1010</span>,<span class="number">0x41010</span>);</span><br><span class="line">    pc2bytes5  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x400</span>,<span class="number">0x20</span>,<span class="number">0x420</span>,<span class="number">0</span>,<span class="number">0x400</span>,<span class="number">0x20</span>,<span class="number">0x420</span>,<span class="number">0x2000000</span>,<span class="number">0x2000400</span>,<span class="number">0x2000020</span>,<span class="number">0x2000420</span>,<span class="number">0x2000000</span>,<span class="number">0x2000400</span>,<span class="number">0x2000020</span>,<span class="number">0x2000420</span>);</span><br><span class="line">    pc2bytes6  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x10000000</span>,<span class="number">0x80000</span>,<span class="number">0x10080000</span>,<span class="number">0x2</span>,<span class="number">0x10000002</span>,<span class="number">0x80002</span>,<span class="number">0x10080002</span>,<span class="number">0</span>,<span class="number">0x10000000</span>,<span class="number">0x80000</span>,<span class="number">0x10080000</span>,<span class="number">0x2</span>,<span class="number">0x10000002</span>,<span class="number">0x80002</span>,<span class="number">0x10080002</span>);</span><br><span class="line">    pc2bytes7  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x10000</span>,<span class="number">0x800</span>,<span class="number">0x10800</span>,<span class="number">0x20000000</span>,<span class="number">0x20010000</span>,<span class="number">0x20000800</span>,<span class="number">0x20010800</span>,<span class="number">0x20000</span>,<span class="number">0x30000</span>,<span class="number">0x20800</span>,<span class="number">0x30800</span>,<span class="number">0x20020000</span>,<span class="number">0x20030000</span>,<span class="number">0x20020800</span>,<span class="number">0x20030800</span>);</span><br><span class="line">    pc2bytes8  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x40000</span>,<span class="number">0</span>,<span class="number">0x40000</span>,<span class="number">0x2</span>,<span class="number">0x40002</span>,<span class="number">0x2</span>,<span class="number">0x40002</span>,<span class="number">0x2000000</span>,<span class="number">0x2040000</span>,<span class="number">0x2000000</span>,<span class="number">0x2040000</span>,<span class="number">0x2000002</span>,<span class="number">0x2040002</span>,<span class="number">0x2000002</span>,<span class="number">0x2040002</span>);</span><br><span class="line">    pc2bytes9  = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x10000000</span>,<span class="number">0x8</span>,<span class="number">0x10000008</span>,<span class="number">0</span>,<span class="number">0x10000000</span>,<span class="number">0x8</span>,<span class="number">0x10000008</span>,<span class="number">0x400</span>,<span class="number">0x10000400</span>,<span class="number">0x408</span>,<span class="number">0x10000408</span>,<span class="number">0x400</span>,<span class="number">0x10000400</span>,<span class="number">0x408</span>,<span class="number">0x10000408</span>);</span><br><span class="line">    pc2bytes10 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x20</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="number">0x100000</span>,<span class="number">0x100020</span>,<span class="number">0x100000</span>,<span class="number">0x100020</span>,<span class="number">0x2000</span>,<span class="number">0x2020</span>,<span class="number">0x2000</span>,<span class="number">0x2020</span>,<span class="number">0x102000</span>,<span class="number">0x102020</span>,<span class="number">0x102000</span>,<span class="number">0x102020</span>);</span><br><span class="line">    pc2bytes11 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x1000000</span>,<span class="number">0x200</span>,<span class="number">0x1000200</span>,<span class="number">0x200000</span>,<span class="number">0x1200000</span>,<span class="number">0x200200</span>,<span class="number">0x1200200</span>,<span class="number">0x4000000</span>,<span class="number">0x5000000</span>,<span class="number">0x4000200</span>,<span class="number">0x5000200</span>,<span class="number">0x4200000</span>,<span class="number">0x5200000</span>,<span class="number">0x4200200</span>,<span class="number">0x5200200</span>);</span><br><span class="line">    pc2bytes12 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x8000000</span>,<span class="number">0x8001000</span>,<span class="number">0x80000</span>,<span class="number">0x81000</span>,<span class="number">0x8080000</span>,<span class="number">0x8081000</span>,<span class="number">0x10</span>,<span class="number">0x1010</span>,<span class="number">0x8000010</span>,<span class="number">0x8001010</span>,<span class="number">0x80010</span>,<span class="number">0x81010</span>,<span class="number">0x8080010</span>,<span class="number">0x8081010</span>);</span><br><span class="line">    pc2bytes13 = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>,<span class="number">0x4</span>,<span class="number">0x100</span>,<span class="number">0x104</span>,<span class="number">0</span>,<span class="number">0x4</span>,<span class="number">0x100</span>,<span class="number">0x104</span>,<span class="number">0x1</span>,<span class="number">0x5</span>,<span class="number">0x101</span>,<span class="number">0x105</span>,<span class="number">0x1</span>,<span class="number">0x5</span>,<span class="number">0x101</span>,<span class="number">0x105</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//how many iterations (1 for des, 3 for triple des)</span></span><br><span class="line">    <span class="keyword">var</span> iterations = key.<span class="property">length</span> &gt;= <span class="number">24</span> ? <span class="number">3</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//stores the return keys</span></span><br><span class="line">    <span class="keyword">var</span> keys = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">32</span> * iterations);</span><br><span class="line">    <span class="comment">//now define the left shifts which need to be done</span></span><br><span class="line">    <span class="keyword">var</span> shifts = <span class="keyword">new</span> <span class="title class_">Array</span> (<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//other variables</span></span><br><span class="line">    <span class="keyword">var</span> lefttemp, righttemp, m=<span class="number">0</span>, n=<span class="number">0</span>, temp;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j=<span class="number">0</span>; j&lt;iterations; j++) &#123; <span class="comment">//either 1 or 3 iterations</span></span><br><span class="line">      left = (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | key.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">      right = (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">24</span>) | (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">16</span>) | (key.<span class="title function_">charCodeAt</span>(m++) &lt;&lt; <span class="number">8</span>) | key.<span class="title function_">charCodeAt</span>(m++);</span><br><span class="line">  </span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">4</span>) ^ right) &amp; <span class="number">0x0f0f0f0f</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">4</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; -<span class="number">16</span>) ^ left) &amp; <span class="number">0x0000ffff</span>; left ^= temp; right ^= (temp &lt;&lt; -<span class="number">16</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">2</span>) ^ right) &amp; <span class="number">0x33333333</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">2</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; -<span class="number">16</span>) ^ left) &amp; <span class="number">0x0000ffff</span>; left ^= temp; right ^= (temp &lt;&lt; -<span class="number">16</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">1</span>) ^ right) &amp; <span class="number">0x55555555</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">1</span>);</span><br><span class="line">      temp = ((right &gt;&gt;&gt; <span class="number">8</span>) ^ left) &amp; <span class="number">0x00ff00ff</span>; left ^= temp; right ^= (temp &lt;&lt; <span class="number">8</span>);</span><br><span class="line">      temp = ((left &gt;&gt;&gt; <span class="number">1</span>) ^ right) &amp; <span class="number">0x55555555</span>; right ^= temp; left ^= (temp &lt;&lt; <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">      <span class="comment">//the right side needs to be shifted and to get the last four bits of the left side</span></span><br><span class="line">      temp = (left &lt;&lt; <span class="number">8</span>) | ((right &gt;&gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x000000f0</span>);</span><br><span class="line">      <span class="comment">//left needs to be put upside down</span></span><br><span class="line">      left = (right &lt;&lt; <span class="number">24</span>) | ((right &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xff0000</span>) | ((right &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff00</span>) | ((right &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf0</span>);</span><br><span class="line">      right = temp;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">//now go through and perform these shifts on the left and right keys</span></span><br><span class="line">      <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; shifts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//shift the keys either one or two bits to the left</span></span><br><span class="line">        <span class="keyword">if</span> (shifts[i]) &#123;left = (left &lt;&lt; <span class="number">2</span>) | (left &gt;&gt;&gt; <span class="number">26</span>); right = (right &lt;&lt; <span class="number">2</span>) | (right &gt;&gt;&gt; <span class="number">26</span>);&#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;left = (left &lt;&lt; <span class="number">1</span>) | (left &gt;&gt;&gt; <span class="number">27</span>); right = (right &lt;&lt; <span class="number">1</span>) | (right &gt;&gt;&gt; <span class="number">27</span>);&#125;</span><br><span class="line">        left &amp;= <span class="number">0xfffffff0</span>; right &amp;= <span class="number">0xfffffff0</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//now apply PC-2, in such a way that E is easier when encrypting or decrypting</span></span><br><span class="line">        <span class="comment">//this conversion will look like PC-2 except only the last 6 bits of each byte are used</span></span><br><span class="line">        <span class="comment">//rather than 48 consecutive bits and the order of lines will be according to </span></span><br><span class="line">        <span class="comment">//how the S selection functions will be applied: S2, S4, S6, S8, S1, S3, S5, S7</span></span><br><span class="line">        lefttemp = pc2bytes0[left &gt;&gt;&gt; <span class="number">28</span>] | pc2bytes1[(left &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                | pc2bytes2[(left &gt;&gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>] | pc2bytes3[(left &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                | pc2bytes4[(left &gt;&gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>] | pc2bytes5[(left &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                | pc2bytes6[(left &gt;&gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">        righttemp = pc2bytes7[right &gt;&gt;&gt; <span class="number">28</span>] | pc2bytes8[(right &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                  | pc2bytes9[(right &gt;&gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>] | pc2bytes10[(right &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                  | pc2bytes11[(right &gt;&gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>] | pc2bytes12[(right &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>]</span><br><span class="line">                  | pc2bytes13[(right &gt;&gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">        temp = ((righttemp &gt;&gt;&gt; <span class="number">16</span>) ^ lefttemp) &amp; <span class="number">0x0000ffff</span>; </span><br><span class="line">        keys[n++] = lefttemp ^ temp; keys[n++] = righttemp ^ (temp &lt;&lt; <span class="number">16</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="comment">//for each iterations</span></span><br><span class="line">    <span class="comment">//return the keys we&#x27;ve created</span></span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">  &#125; <span class="comment">//end of des_createKeys</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;数美滑块登录校验&quot;&gt;&lt;a href=&quot;#数美滑块登录校验&quot; class=&quot;headerlink&quot; title=&quot;数美滑块登录校验&quot;&gt;&lt;/a&gt;数美滑块登录校验&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Vm-master</title>
    <link href="https://straw-233.github.io/2024/11/12/vm-master/"/>
    <id>https://straw-233.github.io/2024/11/12/vm-master/</id>
    <published>2024-11-12T10:51:54.351Z</published>
    <updated>2024-11-12T11:05:50.377Z</updated>
    
    <content type="html"><![CDATA[<h1 id="VM-master"><a href="#VM-master" class="headerlink" title="VM-master"></a>VM-master</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​之前出题的时候，想在github上找个好点的vm板子，但是这样的资源好少好少，就看到个外国的库写的，我用这个改编了一份简单点的，出了2024newstar新生赛的vm题。（虽然被小登非预期了，应该加个前后加减预防单字节爆破的）</p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualMachine</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> MEM_SIZE = <span class="number">256</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> NUM_REGISTERS = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> MEMORY[MEM_SIZE] = &#123;<span class="number">0</span>&#125;; <span class="comment">// 内存</span></span><br><span class="line"><span class="type">uint8_t</span> REGISTERS[NUM_REGISTERS] = &#123;<span class="number">0</span>&#125;; <span class="comment">// 寄存器</span></span><br><span class="line"><span class="type">uint8_t</span>* COMMANDS; <span class="comment">// 程序指令</span></span><br><span class="line"><span class="type">int</span> PC = <span class="number">0</span>; <span class="comment">// 程序计数器</span></span><br><span class="line"><span class="type">bool</span> ZF = <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="type">bool</span> running = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">while</span> (running) &#123;</span><br><span class="line"><span class="type">uint8_t</span> opcode = COMMANDS[PC];</span><br><span class="line"><span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x01</span>: <span class="comment">// LOAD_IMM reg, imm</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> imm = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line">REGISTERS[reg] = imm;</span><br><span class="line">PC += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x02</span>: <span class="comment">// LOAD_ADDR reg, addr</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> addr = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line"><span class="type">uint8_t</span> reg2 = COMMANDS[PC + <span class="number">3</span>];</span><br><span class="line">REGISTERS[reg1] = MEMORY[addr+REGISTERS[reg2]];</span><br><span class="line">PC += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x03</span>: <span class="comment">// STORE_ADDR addr, reg, reg</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> addr = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line"><span class="type">uint8_t</span> reg2 = COMMANDS[PC + <span class="number">3</span>];</span><br><span class="line">MEMORY[addr+REGISTERS[reg1]] = REGISTERS[reg2];</span><br><span class="line">PC += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x04</span>: <span class="comment">// ADD reg1, reg2, dest</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> reg2 = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line"><span class="type">uint8_t</span> dest = COMMANDS[PC + <span class="number">3</span>];</span><br><span class="line">REGISTERS[dest] = REGISTERS[reg1] + REGISTERS[reg2];</span><br><span class="line">PC += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x05</span>: <span class="comment">// MOD reg1, reg2, dest</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> imm = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line"><span class="type">uint8_t</span> dest = COMMANDS[PC + <span class="number">3</span>];</span><br><span class="line">REGISTERS[dest] = REGISTERS[reg1] % imm;</span><br><span class="line">PC += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x06</span>: <span class="comment">// XOR reg1, reg2, dest</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> reg2 = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line"><span class="type">uint8_t</span> dest = COMMANDS[PC + <span class="number">3</span>];</span><br><span class="line">REGISTERS[dest] = REGISTERS[reg1] ^ REGISTERS[reg2];</span><br><span class="line">PC += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x07</span>: <span class="comment">// INC reg</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line">REGISTERS[reg]++;</span><br><span class="line">PC += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x08</span>: <span class="comment">// CMP reg1, imm</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg1 = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> imm = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line">ZF = (REGISTERS[reg1] == imm);</span><br><span class="line">PC += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x09</span>: <span class="comment">// JMP addr</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> addr = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line">PC = addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x0A</span>: <span class="comment">// JZ addr</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> addr = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> (ZF) &#123;</span><br><span class="line">PC = addr;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">PC += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x0B</span>: <span class="comment">// LOAD_ADDR reg, R(addr)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> reg = COMMANDS[PC + <span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> addr = COMMANDS[PC + <span class="number">2</span>];</span><br><span class="line">REGISTERS[reg] = MEMORY[REGISTERS[addr]];</span><br><span class="line">PC += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0xFF</span>: <span class="comment">// HALT</span></span><br><span class="line">&#123;</span><br><span class="line">running = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">std::cerr &lt;&lt; <span class="string">&quot;Unknown opcode: &quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(opcode) &lt;&lt; std::endl;</span><br><span class="line">running = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> array[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) <span class="built_in">before_main</span>() &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</span><br><span class="line">array[i] = i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">srand</span>(<span class="number">0x114514</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">127</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="type">int</span> j = <span class="built_in">rand</span>() % (i + <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> temp = array[i];</span><br><span class="line">array[i] = array[j];</span><br><span class="line">array[j] = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> program[] = &#123;</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,           <span class="comment">// LOAD_IMM R0, 0   ; i = 0</span></span><br><span class="line"><span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x18</span>,            <span class="comment">// CMP R0, 0x18     ; 比较 i &lt; 24</span></span><br><span class="line"><span class="number">0x0A</span>, <span class="number">35</span>,                   <span class="comment">// JZ end_loop      ; 如果 i &gt;= 24，跳到 end_loop</span></span><br><span class="line"><span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x80</span>, <span class="number">0x00</span>,     <span class="comment">// LOAD_ADDR R1, 0x80+R0  ; flag[i]</span></span><br><span class="line"><span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,     <span class="comment">// ADD R1, R0, R1   ; R1 = flag[i] + i</span></span><br><span class="line"><span class="number">0x05</span>, <span class="number">0x01</span>, <span class="number">0x80</span>, <span class="number">0x01</span>,     <span class="comment">// MOD R1, 128, R1  ; R1 = (flag[i] + i) % 128</span></span><br><span class="line"><span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0x01</span>,           <span class="comment">// LOAD_ADDR R2, R1 ; R2 = array[(flag[i] + i) % 128]</span></span><br><span class="line"><span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>,     <span class="comment">// XOR R2, R0, R2   ; R2 = R2 ^ i</span></span><br><span class="line"><span class="number">0x03</span>, <span class="number">0x80</span>, <span class="number">0x00</span>, <span class="number">0x02</span>,     <span class="comment">// STORE_ADDR 0x80+R0, R2  ; flag[i] = R2</span></span><br><span class="line"><span class="number">0x07</span>, <span class="number">0x00</span>,                 <span class="comment">// INC R0           ; i++</span></span><br><span class="line"><span class="number">0x09</span>, <span class="number">0x03</span>,                 <span class="comment">// JMP loop         ; 回到循环开始</span></span><br><span class="line"><span class="number">0xFF</span>                        <span class="comment">// HALT             ; 停止执行</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">VirtualMachine vm;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> flag[<span class="number">25</span>];</span><br><span class="line"><span class="type">uint8_t</span> pw[<span class="number">24</span>]=&#123;<span class="number">0x28</span>,<span class="number">0x79</span>,<span class="number">0x17</span>,<span class="number">0x4</span>,<span class="number">0xc</span>,<span class="number">0x73</span>,<span class="number">0x26</span>,<span class="number">0x36</span>,<span class="number">0x50</span>,<span class="number">0x39</span>,<span class="number">0x7e</span>,<span class="number">0x24</span>,<span class="number">0x51</span>,<span class="number">0x17</span>,<span class="number">0x44</span>,<span class="number">0x25</span>,<span class="number">0x6</span>,<span class="number">0x70</span>,<span class="number">0x4d</span>,<span class="number">0x40</span>,<span class="number">0x79</span>,<span class="number">0x35</span>,<span class="number">0x73</span>,<span class="number">0x21</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[31mCongratulations on persevering until the fifth week of the Newstar CTF!!!\033[0m\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[32mWhether or not you can create this VM, I believe it can give you something.\033[0m\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[33m\033[44mPlease input your flag:\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%24s&quot;</span>,flag);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">getchar</span>() != <span class="string">&#x27;\n&#x27;</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将数组写入虚拟机内存</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</span><br><span class="line">vm.MEMORY[i] = array[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) &#123;</span><br><span class="line">vm.MEMORY[<span class="number">128</span> + i] = flag[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vm.COMMANDS = program;  <span class="comment">// 加载程序</span></span><br><span class="line">vm.<span class="built_in">run</span>();               <span class="comment">// 执行程序</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> jd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(vm.MEMORY[<span class="number">128</span> + i]==pw[i])</span><br><span class="line">&#123;</span><br><span class="line">jd++;</span><br><span class="line"><span class="comment">//printf(&quot;%d验证成功\n&quot;,jd);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(jd==<span class="number">24</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;yes&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//std::cout &lt;&lt; &quot;flag[&quot; &lt;&lt; i &lt;&lt; &quot;]: 0x&quot; &lt;&lt; std::hex &lt;&lt; static_cast&lt;int&gt;(vm.MEMORY[128 + i]) &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">//printf(&quot;%x,&quot;,vm.MEMORY[128 + i]);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>​想要出难点的话就直接多加指令case，想要不被非预期记得别单字节加密，加密使用换表。VM这坨史，就应该老老实实写opcode才行🤯。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;VM-master&quot;&gt;&lt;a href=&quot;#VM-master&quot; class=&quot;headerlink&quot; title=&quot;VM-master&quot;&gt;&lt;/a&gt;VM-master&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>浅谈ctf中的游戏逆向</title>
    <link href="https://straw-233.github.io/2024/11/11/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/"/>
    <id>https://straw-233.github.io/2024/11/11/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/</id>
    <published>2024-11-11T10:53:32.140Z</published>
    <updated>2024-11-12T10:45:07.380Z</updated>
    
    <content type="html"><![CDATA[<h1 id="浅谈ctf中的游戏逆向"><a href="#浅谈ctf中的游戏逆向" class="headerlink" title="浅谈ctf中的游戏逆向"></a>浅谈ctf中的游戏逆向</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        最近打了好几场大比赛，感觉每场都会有奇怪的游戏逆向出来，有c++写的，有python写的，有c#写的，藏flag的方式也是多种多样啊，感觉挺有意思的，来个总结也当复现赛题了。想把此篇当为游戏逆向的总章。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/%E5%A5%B6%E9%BE%99.gif" alt="奶龙"></p><h2 id="2024强网拟态-challenge"><a href="#2024强网拟态-challenge" class="headerlink" title="2024强网拟态-challenge"></a>2024强网拟态-challenge</h2><p>​一个吃豆人的游戏，github上找到了源码<a href="https://github.com/NJU-TJL/PacManX">NJU-TJL&#x2F;PacManX: 基于C++控制台（Windows平台）的一个吃豆人小游戏</a>。很精妙的设计，去了符号表，增加整个游戏逆向的难度，该题不是正常的通关游戏给flag的那种，将关键点藏到了退出函数那，也是我玩着玩着发现的。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/1.png" alt="1"></p><p>直接对exit函数进行索引找关键函数</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/2.png" alt="2"></p><p>刚好对应的是读入esc键然后执行sub_140014EB5();然后退出</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/4.png" alt="4"></p><p>这里面有个明显的字符串混淆，防止被F12直接索引到</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/5.png" alt="5"></p><p>整体重新分析一下就是</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/6.png" alt="6"></p><p>​很清晰了，在你的注册表里读flag，然后对.data文件进行解密成为一个ps1，执行后删除</p><p>​那我先把flag写注册表里，然后创个game.ps1文件，设置权限不可执行不可读，只能写入，这样运行在删除前就会报错，留下一个game.tmp</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/7.png" alt="7"></p><p>用powerdecode去混淆</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">Layer <span class="number">4</span> - Plainscript</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enenenenene</span></span> &#123;</span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        <span class="variable">$plaintextBytes</span>,</span><br><span class="line">        <span class="variable">$keyBytes</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># Initialize S and KSA</span></span><br><span class="line">    <span class="variable">$S</span> = <span class="number">0</span>..<span class="number">255</span></span><br><span class="line">    <span class="variable">$j</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> <span class="operator">-lt</span> <span class="number">256</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$S</span>[<span class="variable">$i</span>] + <span class="variable">$keyBytes</span>[<span class="variable">$i</span> % <span class="variable">$keyBytes</span><span class="type">.Length</span>]) % <span class="number">256</span></span><br><span class="line">        <span class="variable">$temp</span> = <span class="variable">$S</span>[<span class="variable">$i</span>]</span><br><span class="line">        <span class="variable">$S</span>[<span class="variable">$i</span>] = <span class="variable">$S</span>[<span class="variable">$j</span>]</span><br><span class="line">        <span class="variable">$S</span>[<span class="variable">$j</span>] = <span class="variable">$temp</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA and encryption</span></span><br><span class="line">    <span class="variable">$i</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable">$j</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable">$ciphertextBytes</span> = <span class="selector-tag">@</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> <span class="operator">-lt</span> <span class="variable">$plaintextBytes</span>.Length; <span class="variable">$k</span>++) &#123;</span><br><span class="line">        <span class="variable">$i</span> = (<span class="variable">$i</span> + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$S</span>[<span class="variable">$i</span>]) % <span class="number">256</span></span><br><span class="line">        <span class="variable">$temp</span> = <span class="variable">$S</span>[<span class="variable">$i</span>]</span><br><span class="line">        <span class="variable">$S</span>[<span class="variable">$i</span>] = <span class="variable">$S</span>[<span class="variable">$j</span>]</span><br><span class="line">        <span class="variable">$S</span>[<span class="variable">$j</span>] = <span class="variable">$temp</span></span><br><span class="line">        <span class="variable">$t</span> = (<span class="variable">$S</span>[<span class="variable">$i</span>] + <span class="variable">$S</span>[<span class="variable">$j</span>]) % <span class="number">256</span></span><br><span class="line">        <span class="variable">$ciphertextBytes</span> += (<span class="variable">$plaintextBytes</span>[<span class="variable">$k</span>] <span class="operator">-bxor</span> <span class="variable">$S</span>[<span class="variable">$t</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return ciphertext as a string</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ciphertextBytes</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enenenenene1</span></span> &#123;</span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        <span class="variable">$inputbyte</span></span><br><span class="line">    )</span><br><span class="line">    <span class="variable">$key</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x70, <span class="number">0</span>x6f, <span class="number">0</span>x77, <span class="number">0</span>x65, <span class="number">0</span>x72)</span><br><span class="line">    <span class="variable">$encryptedText</span> = <span class="selector-tag">@</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> <span class="operator">-lt</span> <span class="variable">$inputbyte</span>.Length; <span class="variable">$k</span>++) &#123;</span><br><span class="line">        <span class="variable">$encryptedText</span> = enenenenene <span class="literal">-plaintextBytes</span> <span class="variable">$inputbyte</span> <span class="literal">-keyBytes</span> <span class="variable">$key</span>;</span><br><span class="line">        <span class="variable">$key</span> = enenenenene <span class="literal">-plaintextBytes</span> <span class="variable">$key</span> <span class="literal">-keyBytes</span> <span class="variable">$encryptedText</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encryptedText</span> + <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enenenenene2</span></span> &#123;</span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        <span class="variable">$inputbyte</span></span><br><span class="line">    )</span><br><span class="line">    <span class="variable">$key</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x70, <span class="number">0</span>x30, <span class="number">0</span>x77, <span class="number">0</span>x65, <span class="number">0</span>x72)</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> <span class="operator">-lt</span> <span class="variable">$inputbyte</span>.Length; <span class="variable">$k</span>++) &#123;</span><br><span class="line">        <span class="variable">$inputbyte</span>[<span class="variable">$k</span>] = <span class="variable">$inputbyte</span>[<span class="variable">$k</span>] + <span class="variable">$key</span>[<span class="variable">$k</span> % <span class="variable">$key</span><span class="type">.Length</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$inputbyte</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enenenenene3</span></span> &#123;</span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        <span class="variable">$inputbyte</span></span><br><span class="line">    )</span><br><span class="line">    <span class="variable">$key</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x70, <span class="number">0</span>x30, <span class="number">0</span>x77, <span class="number">0</span>x33, <span class="number">0</span>x72)</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> <span class="operator">-lt</span> <span class="variable">$inputbyte</span>.Length; <span class="variable">$k</span>++) &#123;</span><br><span class="line">        <span class="variable">$inputbyte</span>[<span class="variable">$k</span>] = <span class="variable">$inputbyte</span>[<span class="variable">$k</span>] * <span class="variable">$key</span>[<span class="variable">$k</span> % <span class="variable">$key</span><span class="type">.Length</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$inputbyte</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$registryPath</span> = <span class="string">&#x27;HKCU:\Software\PacManX&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$valueName</span> = <span class="string">&#x27;MYFLAG&#x27;</span></span><br><span class="line"><span class="variable">$value</span> = <span class="built_in">Get-ItemPropertyValue</span> <span class="variable">$registryPath</span> <span class="variable">$valueName</span></span><br><span class="line"><span class="variable">$plaintext</span> = <span class="selector-tag">@</span>(<span class="variable">$value</span>) | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="variable">$input</span> = <span class="variable">$_</span></span><br><span class="line">    <span class="variable">$plaintext</span> = <span class="selector-tag">@</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$input</span>.Length; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$plaintext</span> += [<span class="built_in">int</span>][<span class="built_in">char</span>]<span class="variable">$input</span>[<span class="variable">$i</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$plaintext</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$plaintext</span>.Length <span class="operator">-ne</span> <span class="number">36</span>) &#123;</span><br><span class="line">    <span class="built_in">Set-Content</span> <span class="literal">-Path</span> <span class="string">&quot;log.txt&quot;</span> <span class="literal">-Value</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">    <span class="keyword">exit</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$encrypted1Text</span> = enENenenene2 <span class="literal">-inputbyte</span> (enenenENene2 <span class="literal">-inputbyte</span> (enenenenene3 <span class="literal">-inputbyte</span> (Enenenenene2 <span class="literal">-inputbyte</span> (enenenenene2 <span class="literal">-inputbyte</span> (enenenenene2 <span class="literal">-inputbyte</span> (enenenenene1 <span class="literal">-input</span> <span class="variable">$plaintext</span>))))))</span><br><span class="line"><span class="variable">$result</span> = <span class="selector-tag">@</span>(<span class="number">38304</span>, <span class="number">8928</span>, <span class="number">43673</span>, <span class="number">25957</span> , <span class="number">67260</span>, <span class="number">47152</span>, <span class="number">16656</span>, <span class="number">62832</span> , <span class="number">19480</span> , <span class="number">66690</span>, <span class="number">40432</span>, <span class="number">15072</span> , <span class="number">63427</span> , <span class="number">28558</span> , <span class="number">54606</span>, <span class="number">47712</span> , <span class="number">18240</span> , <span class="number">68187</span> , <span class="number">18256</span>, <span class="number">63954</span> , <span class="number">48384</span>, <span class="number">14784</span>, <span class="number">60690</span> , <span class="number">21724</span> , <span class="number">53238</span> , <span class="number">64176</span> , <span class="number">9888</span> , <span class="number">54859</span> , <span class="number">23050</span> , <span class="number">58368</span> , <span class="number">46032</span> , <span class="number">15648</span> , <span class="number">64260</span> , <span class="number">17899</span> , <span class="number">52782</span> , <span class="number">51968</span> , <span class="number">12336</span> , <span class="number">69377</span> , <span class="number">27844</span> , <span class="number">43206</span> , <span class="number">63616</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> <span class="operator">-lt</span> <span class="variable">$result</span>.Length; <span class="variable">$k</span>++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$encrypted1Text</span>[<span class="variable">$k</span>] <span class="operator">-ne</span> <span class="variable">$result</span>[<span class="variable">$k</span>]) &#123;</span><br><span class="line">        <span class="built_in">Set-Content</span> <span class="literal">-Path</span> <span class="string">&quot;log.txt&quot;</span> <span class="literal">-Value</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">        <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Set-Content</span> <span class="literal">-Path</span> <span class="string">&quot;log.txt&quot;</span> <span class="literal">-Value</span> <span class="string">&quot;RIGHT&quot;</span></span><br></pre></td></tr></table></figure><p>rc4+简单乘加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pw=[<span class="number">38304</span>, <span class="number">8928</span>, <span class="number">43673</span>, <span class="number">25957</span> , <span class="number">67260</span>, <span class="number">47152</span>, <span class="number">16656</span>, <span class="number">62832</span> , <span class="number">19480</span> , <span class="number">66690</span>, <span class="number">40432</span>, <span class="number">15072</span> , <span class="number">63427</span> , <span class="number">28558</span> , <span class="number">54606</span>, <span class="number">47712</span> , <span class="number">18240</span> , <span class="number">68187</span> , <span class="number">18256</span>, <span class="number">63954</span> , <span class="number">48384</span>, <span class="number">14784</span>, <span class="number">60690</span> , <span class="number">21724</span> , <span class="number">53238</span> , <span class="number">64176</span> , <span class="number">9888</span> , <span class="number">54859</span> , <span class="number">23050</span> , <span class="number">58368</span> , <span class="number">46032</span> , <span class="number">15648</span> , <span class="number">64260</span> , <span class="number">17899</span> , <span class="number">52782</span> , <span class="number">51968</span> , <span class="number">12336</span> , <span class="number">69377</span> , <span class="number">27844</span> , <span class="number">43206</span> , <span class="number">63616</span>]</span><br><span class="line">key=[<span class="number">0x70</span>, <span class="number">0x6f</span>, <span class="number">0x77</span>, <span class="number">0x65</span>, <span class="number">0x72</span>]</span><br><span class="line">key1=[<span class="number">0x70</span>, <span class="number">0x30</span>, <span class="number">0x77</span>, <span class="number">0x65</span>, <span class="number">0x72</span>]</span><br><span class="line">key2=[<span class="number">0x70</span>, <span class="number">0x30</span>, <span class="number">0x77</span>, <span class="number">0x33</span>, <span class="number">0x72</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pw)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">int</span>((pw[i]-<span class="number">2</span>*key1[i%<span class="number">5</span>])/key2[i%<span class="number">5</span>])-<span class="number">3</span>*key1[i%<span class="number">5</span>]),end=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pw2=[<span class="number">0x4</span>,<span class="number">0x28</span>,<span class="number">0x8</span>,<span class="number">0xca</span>,<span class="number">0xf6</span>,<span class="number">0x53</span>,<span class="number">0xc9</span>,<span class="number">0xa9</span>,<span class="number">0x4b</span>,<span class="number">0xf1</span>,<span class="number">0x17</span>,<span class="number">0xa8</span>,<span class="number">0xae</span>,<span class="number">0xfd</span>,<span class="number">0x87</span>,<span class="number">0x58</span>,<span class="number">0xea</span>,<span class="number">0xd6</span>,<span class="number">0x33</span>,<span class="number">0xd9</span>,<span class="number">0x5e</span>,<span class="number">0xa2</span>,<span class="number">0x97</span>,<span class="number">0x77</span>,<span class="number">0x7b</span>,<span class="number">0xeb</span>,<span class="number">0x3c</span>,<span class="number">0x66</span>,<span class="number">0x91</span>,<span class="number">0xa8</span>,<span class="number">0x49</span>,<span class="number">0xb4</span>,<span class="number">0xb5</span>,<span class="number">0x2c</span>,<span class="number">0x77</span>,<span class="number">0x7e</span>]</span><br><span class="line">key3=[<span class="number">0x6f</span>,<span class="number">0xe0</span>,<span class="number">0xef</span>,<span class="number">0x23</span>,<span class="number">0xe6</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4</span>(<span class="params">key, data</span>):</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_length = <span class="built_in">len</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_length]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i] </span><br><span class="line"></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    output = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i] </span><br><span class="line">        t = (S[i] + S[j]) % <span class="number">256</span></span><br><span class="line">        output.append(byte ^ S[t]) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(pw2))</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    key3=rc4(pw2,key3)</span><br><span class="line">    pw2=rc4(key3,pw2)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key3:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(i),end=<span class="string">&#x27;&#x27;</span>)  </span><br><span class="line">    <span class="built_in">print</span>()  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pw2:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">#73412036-7d8c-437b-9026-0c2ca1b7f79d</span></span><br></pre></td></tr></table></figure><h2 id="2024强网杯-斯内克"><a href="#2024强网杯-斯内克" class="headerlink" title="2024强网杯-斯内克"></a>2024强网杯-斯内克</h2><p>一道用c语言实现的简单的贪吃蛇，没找到源码，但是很简单，感觉是出题人自己写的。其实到头来是个smc。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/1.1.png" alt="1.1"></p><p>简单分析完主函数流程，我们主要看 sub_1400111FE(）  和sub_14001112C(); </p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/1.2.png" alt="1.2"></p><p>最上面会判断你的键盘输入有没有变，来决定是否进行下面操作，然后下面会根据你键盘不同的输入，进行smc段不同的操作。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/1.3.png" alt="1.3"></p><p>然后看另一个函数的另外一段</p><p>这边会对smc的那段代码进行校验，每次吃到果子对比md5的值，当还原成正确的代码段后，作为一个函数对最开始你的输入进行操作。但是md5不可逆，作者也给出了要我们求最优路径，操作数最少，果子的位置出现也是个伪随机，所以就是一道算法题。算法不会一点，cp一下carbo的代码，虽然他也是chat的。[捂嘴笑]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bits/stdc++.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;md5.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;defs.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Direction</span> &#123;</span><br><span class="line">    UP,     <span class="comment">// W</span></span><br><span class="line">    DOWN,   <span class="comment">// S</span></span><br><span class="line">    LEFT,   <span class="comment">// A</span></span><br><span class="line">    RIGHT   <span class="comment">// D</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="type">int</span> x, y;           <span class="comment">// 蛇头位置</span></span><br><span class="line">    Direction dir;      <span class="comment">// 当前方向</span></span><br><span class="line">    string path;        <span class="comment">// 路径</span></span><br><span class="line">    <span class="type">int</span> fruitIndex;     <span class="comment">// 当前要吃的果子索引</span></span><br><span class="line">    <span class="type">int</span> steps;          <span class="comment">// 步数</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">State</span>(<span class="type">int</span> x, <span class="type">int</span> y, Direction d, string p, <span class="type">int</span> f, <span class="type">int</span> s)</span><br><span class="line">            : <span class="built_in">x</span>(x), <span class="built_in">y</span>(y), <span class="built_in">dir</span>(d), <span class="built_in">path</span>(p), <span class="built_in">fruitIndex</span>(f), <span class="built_in">steps</span>(s) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> State&amp; other) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x != other.x) <span class="keyword">return</span> x &lt; other.x;</span><br><span class="line">        <span class="keyword">if</span> (y != other.y) <span class="keyword">return</span> y &lt; other.y;</span><br><span class="line">        <span class="keyword">if</span> (dir != other.dir) <span class="keyword">return</span> dir &lt; other.dir;</span><br><span class="line">        <span class="keyword">return</span> fruitIndex &lt; other.fruitIndex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SnakePathFinder</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> SIZE = <span class="number">20</span>;</span><br><span class="line">    vector&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; fruits;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isValid</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &gt;= <span class="number">0</span> &amp;&amp; x &lt; SIZE &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Direction <span class="title">getOppositeDirection</span><span class="params">(Direction dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(dir) &#123;</span><br><span class="line">            <span class="keyword">case</span> UP: <span class="keyword">return</span> DOWN;</span><br><span class="line">            <span class="keyword">case</span> DOWN: <span class="keyword">return</span> UP;</span><br><span class="line">            <span class="keyword">case</span> LEFT: <span class="keyword">return</span> RIGHT;</span><br><span class="line">            <span class="keyword">case</span> RIGHT: <span class="keyword">return</span> LEFT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> UP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">getDirectionChar</span><span class="params">(Direction dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(dir) &#123;</span><br><span class="line">            <span class="keyword">case</span> UP: <span class="keyword">return</span> <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> DOWN: <span class="keyword">return</span> <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> LEFT: <span class="keyword">return</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> RIGHT: <span class="keyword">return</span> <span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">moveInDirection</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, Direction dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(dir) &#123;</span><br><span class="line">            <span class="keyword">case</span> UP: <span class="keyword">return</span> &#123;x<span class="number">-1</span>, y&#125;;</span><br><span class="line">            <span class="keyword">case</span> DOWN: <span class="keyword">return</span> &#123;x+<span class="number">1</span>, y&#125;;</span><br><span class="line">            <span class="keyword">case</span> LEFT: <span class="keyword">return</span> &#123;x, y<span class="number">-1</span>&#125;;</span><br><span class="line">            <span class="keyword">case</span> RIGHT: <span class="keyword">return</span> &#123;x, y+<span class="number">1</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;x, y&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化后的启发式估计函数</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">estimateRemainingSteps</span><span class="params">(<span class="type">const</span> State&amp; state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state.fruitIndex &gt;= fruits.<span class="built_in">size</span>()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> totalEstimate = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> currentX = state.x;</span><br><span class="line">        <span class="type">int</span> currentY = state.y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算到所有剩余果子的最小距离之和</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = state.fruitIndex; i &lt; fruits.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="type">int</span> dx = <span class="built_in">abs</span>(currentX - fruits[i].first);</span><br><span class="line">            <span class="type">int</span> dy = <span class="built_in">abs</span>(currentY - fruits[i].second);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 考虑转向的代价</span></span><br><span class="line">            <span class="keyword">if</span> (i == state.fruitIndex) &#123;</span><br><span class="line">                <span class="type">bool</span> needHorizontalMove = (currentY != fruits[i].second);</span><br><span class="line">                <span class="type">bool</span> needVerticalMove = (currentX != fruits[i].first);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (needHorizontalMove &amp;&amp; needVerticalMove) &#123;</span><br><span class="line">                    <span class="comment">// 如果需要同时在水平和垂直方向移动，至少需要一次转向</span></span><br><span class="line">                    <span class="keyword">if</span> ((state.dir == LEFT || state.dir == RIGHT) &amp;&amp; needVerticalMove) &#123;</span><br><span class="line">                        totalEstimate += <span class="number">1</span>;  <span class="comment">// 考虑转向的代价</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((state.dir == UP || state.dir == DOWN) &amp;&amp; needHorizontalMove) &#123;</span><br><span class="line">                        totalEstimate += <span class="number">1</span>;  <span class="comment">// 考虑转向的代价</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            totalEstimate += dx + dy;  <span class="comment">// 曼哈顿距离</span></span><br><span class="line">            currentX = fruits[i].first;</span><br><span class="line">            currentY = fruits[i].second;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> totalEstimate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SnakePathFinder</span>(<span class="type">const</span> vector&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt;&amp; fruitSequence) &#123;</span><br><span class="line">        fruits = fruitSequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">findOptimalPath</span><span class="params">(<span class="type">int</span> startX, <span class="type">int</span> startY, Direction startDir)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用优先队列，按照估计的总步数排序</span></span><br><span class="line">        <span class="keyword">auto</span> cmp = [](<span class="type">const</span> State&amp; a, <span class="type">const</span> State&amp; b) &#123;</span><br><span class="line">            <span class="built_in">return</span> (a.steps + a.path.<span class="built_in">length</span>()) &gt; (b.steps + b.path.<span class="built_in">length</span>());</span><br><span class="line">        &#125;;</span><br><span class="line">        priority_queue&lt;State, vector&lt;State&gt;, <span class="keyword">decltype</span>(cmp)&gt; <span class="built_in">pq</span>(cmp);</span><br><span class="line"></span><br><span class="line">        set&lt;State&gt; visited;</span><br><span class="line">        <span class="function">State <span class="title">initial</span><span class="params">(startX, startY, startDir, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        pq.<span class="built_in">push</span>(initial);</span><br><span class="line">        visited.<span class="built_in">insert</span>(initial);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(!pq.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            State current = pq.<span class="built_in">top</span>();</span><br><span class="line">            pq.<span class="built_in">pop</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果所有果子都被吃掉</span></span><br><span class="line">            <span class="keyword">if</span>(current.fruitIndex &gt;= fruits.<span class="built_in">size</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> current.path;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果到达当前目标果子</span></span><br><span class="line">            <span class="keyword">if</span>(current.x == fruits[current.fruitIndex].first &amp;&amp;</span><br><span class="line">               current.y == fruits[current.fruitIndex].second) &#123;</span><br><span class="line">                State nextState = current;</span><br><span class="line">                nextState.fruitIndex++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(visited.<span class="built_in">find</span>(nextState) == visited.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                    pq.<span class="built_in">push</span>(nextState);</span><br><span class="line">                    visited.<span class="built_in">insert</span>(nextState);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试所有可能的方向</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                Direction newDir = <span class="built_in">static_cast</span>&lt;Direction&gt;(i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 不能直接调头</span></span><br><span class="line">                <span class="keyword">if</span>(newDir == <span class="built_in">getOppositeDirection</span>(current.dir)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">auto</span> [newX, newY] = <span class="built_in">moveInDirection</span>(current.x, current.y, newDir);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isValid</span>(newX, newY)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                string newPath = current.path;</span><br><span class="line">                <span class="keyword">if</span>(newDir != current.dir) &#123;</span><br><span class="line">                    newPath += <span class="built_in">getDirectionChar</span>(newDir);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function">State <span class="title">newState</span><span class="params">(newX, newY, newDir, newPath,</span></span></span><br><span class="line"><span class="params"><span class="function">                               current.fruitIndex, current.steps + <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(visited.<span class="built_in">find</span>(newState) == visited.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                    pq.<span class="built_in">push</span>(newState);</span><br><span class="line">                    visited.<span class="built_in">insert</span>(newState);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No path found&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> map_data_orig[<span class="number">1152</span>] = &#123;</span><br><span class="line">        <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0xB0</span>, <span class="number">0x38</span>, <span class="number">0x6D</span>,</span><br><span class="line">        <span class="number">0xEE</span>, <span class="number">0x3F</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x09</span>, <span class="number">0x6A</span>, <span class="number">0xF0</span>, <span class="number">0x38</span>, <span class="number">0x2C</span>, <span class="number">0x79</span>, <span class="number">0xF6</span>, <span class="number">0x34</span>, <span class="number">0xE9</span>, <span class="number">0x89</span>, <span class="number">0x38</span>,</span><br><span class="line">        <span class="number">0xAC</span>, <span class="number">0x7F</span>, <span class="number">0x35</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x6D</span>, <span class="number">0x77</span>, <span class="number">0xF6</span>, <span class="number">0xB6</span>, <span class="number">0x38</span>, <span class="number">0x6D</span>, <span class="number">0x78</span>, <span class="number">0xF6</span>, <span class="number">0xB6</span>,</span><br><span class="line">        <span class="number">0x2B</span>, <span class="number">0x18</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3B</span>, <span class="number">0x81</span>, <span class="number">0x81</span>, <span class="number">0x81</span>, <span class="number">0x81</span>, <span class="number">0xEF</span>, <span class="number">0x4E</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0x7D</span>, <span class="number">0xF6</span>,</span><br><span class="line">        <span class="number">0x33</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, <span class="number">0xE8</span>, <span class="number">0xF6</span>, <span class="number">0x2B</span>, <span class="number">0x27</span>,</span><br><span class="line">        <span class="number">0xA3</span>, <span class="number">0x1D</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x38</span>, <span class="number">0x89</span>,</span><br><span class="line">        <span class="number">0xE3</span>, <span class="number">0xC3</span>, <span class="number">0xCA</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0xB0</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x38</span>,</span><br><span class="line">        <span class="number">0xB3</span>, <span class="number">0x67</span>, <span class="number">0xE3</span>, <span class="number">0x16</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xD4</span>, <span class="number">0xB0</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="number">0x38</span>, <span class="number">0xB6</span>, <span class="number">0xD3</span>, <span class="number">0xB6</span>, <span class="number">0xA9</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xE4</span>, <span class="number">0xB0</span>, <span class="number">0xF8</span>,</span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0x38</span>, <span class="number">0x89</span>, <span class="number">0xD8</span>, <span class="number">0xC7</span>, <span class="number">0x33</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xB4</span>, <span class="number">0x2B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0xED</span>, <span class="number">0xB5</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x2B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xC4</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0xED</span>, <span class="number">0xB5</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xD4</span>, <span class="number">0x2B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xD4</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0xED</span>, <span class="number">0xB5</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xE4</span>, <span class="number">0x2B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xE4</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0xED</span>, <span class="number">0xB5</span>, <span class="number">0xD4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xB0</span>, <span class="number">0xEC</span>, <span class="number">0xFE</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0x6F</span>, <span class="number">0x14</span>, <span class="number">0x4C</span>, <span class="number">0xEC</span>, <span class="number">0xFE</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x2F</span>, <span class="number">0xC0</span>, <span class="number">0x2C</span>, <span class="number">0xEC</span>, <span class="number">0xFE</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xCC</span>, <span class="number">0x6C</span>, <span class="number">0xFE</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB6</span>, <span class="number">0x24</span>, <span class="number">0xCC</span>, <span class="number">0x72</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xB4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xC4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0xD2</span>, <span class="number">0xF4</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>, <span class="number">0xC4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF9</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x04</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>,</span><br><span class="line">        <span class="number">0xC4</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xE9</span>, <span class="number">0xF4</span>, <span class="number">0xCC</span>, <span class="number">0xE2</span>, <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0xE1</span>, <span class="number">0x4C</span>, <span class="number">0xF9</span>, <span class="number">0xED</span>,</span><br><span class="line">        <span class="number">0x38</span>, <span class="number">0xF8</span>, <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0xF8</span>, <span class="number">0xE4</span>, <span class="number">0xE0</span>, <span class="number">0xA8</span>, <span class="number">0x4C</span>, <span class="number">0xC1</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xB4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>,</span><br><span class="line">        <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF6</span>, <span class="number">0x4C</span>, <span class="number">0x69</span>, <span class="number">0xF4</span>, <span class="number">0xE4</span>, <span class="number">0x40</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0xD2</span>, <span class="number">0xF4</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF9</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x04</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xE9</span>, <span class="number">0xF4</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x64</span>, <span class="number">0xCC</span>, <span class="number">0xE2</span>, <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0xE1</span>,</span><br><span class="line">        <span class="number">0x4C</span>, <span class="number">0xF9</span>, <span class="number">0xED</span>, <span class="number">0x38</span>, <span class="number">0xF8</span>, <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0xF8</span>, <span class="number">0xE4</span>, <span class="number">0xE0</span>, <span class="number">0xA8</span>, <span class="number">0x4C</span>, <span class="number">0xC1</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xC4</span>, <span class="number">0x2C</span>,</span><br><span class="line">        <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x2F</span>, <span class="number">0x2F</span>, <span class="number">0x2F</span>, <span class="number">0xB0</span>, <span class="number">0xEC</span>, <span class="number">0x00</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x6F</span>, <span class="number">0x14</span>, <span class="number">0x4C</span>, <span class="number">0xEC</span>, <span class="number">0x00</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x2F</span>, <span class="number">0xC0</span>, <span class="number">0x2C</span>, <span class="number">0xEC</span>, <span class="number">0x00</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xCC</span>, <span class="number">0x6C</span>, <span class="number">0x00</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB6</span>, <span class="number">0x24</span>, <span class="number">0xCC</span>, <span class="number">0x72</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xD4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0xD2</span>, <span class="number">0xF4</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0xF9</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x04</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>,</span><br><span class="line">        <span class="number">0x4A</span>, <span class="number">0xE1</span>, <span class="number">0xE4</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xE9</span>, <span class="number">0xF4</span>, <span class="number">0xCC</span>, <span class="number">0xE2</span>, <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0xE1</span>, <span class="number">0x4C</span>,</span><br><span class="line">        <span class="number">0xF9</span>, <span class="number">0xED</span>, <span class="number">0x38</span>, <span class="number">0xF8</span>, <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0xF8</span>, <span class="number">0xE4</span>, <span class="number">0xE0</span>, <span class="number">0xA8</span>, <span class="number">0x4C</span>, <span class="number">0xC1</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0xE4</span>,</span><br><span class="line">        <span class="number">0x79</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>,</span><br><span class="line">        <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF6</span>, <span class="number">0x4C</span>, <span class="number">0x69</span>, <span class="number">0xF4</span>, <span class="number">0xE4</span>, <span class="number">0x40</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0x3B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xE4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0xD2</span>, <span class="number">0xF4</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0x4C</span>, <span class="number">0xF9</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x04</span>, <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0x5B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>,</span><br><span class="line">        <span class="number">0x4A</span>, <span class="number">0xE1</span>, <span class="number">0xD4</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x05</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xE9</span>, <span class="number">0xF4</span>, <span class="number">0xD0</span>, <span class="number">0x62</span>, <span class="number">0x64</span>, <span class="number">0xCC</span>, <span class="number">0xE2</span>, <span class="number">0xE4</span>,</span><br><span class="line">        <span class="number">0x4C</span>, <span class="number">0xE1</span>, <span class="number">0x4C</span>, <span class="number">0xF9</span>, <span class="number">0xED</span>, <span class="number">0x38</span>, <span class="number">0xF8</span>, <span class="number">0x4C</span>, <span class="number">0xE8</span>, <span class="number">0xF4</span>, <span class="number">0xF8</span>, <span class="number">0xE4</span>, <span class="number">0xE0</span>, <span class="number">0xA8</span>, <span class="number">0x4C</span>, <span class="number">0xC1</span>,</span><br><span class="line">        <span class="number">0xE3</span>, <span class="number">0x60</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x2F</span>, <span class="number">0x2F</span>, <span class="number">0x2F</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>,</span><br><span class="line">        <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xB4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xD4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>,</span><br><span class="line">        <span class="number">0x4C</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xB4</span>, <span class="number">0x2C</span>,</span><br><span class="line">        <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xE4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>,</span><br><span class="line">        <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xC4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xE4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xB4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>,</span><br><span class="line">        <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>, <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xD4</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>,</span><br><span class="line">        <span class="number">0xD0</span>, <span class="number">0x2B</span>, <span class="number">0xF4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x50</span>, <span class="number">0xD4</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x85</span>, <span class="number">0x37</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>,</span><br><span class="line">        <span class="number">0x42</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3D</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x52</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xBE</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x62</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x51</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x6F</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3D</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x7F</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0x5B</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x12</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x8D</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x22</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x65</span>, <span class="number">0xA0</span>,</span><br><span class="line">        <span class="number">0xEC</span>, <span class="number">0x32</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xA7</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xBF</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x4D</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xCF</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xAC</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xDF</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xF8</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xEF</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0xB4</span>, <span class="number">0x06</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xFF</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xE9</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x8F</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x3B</span>,</span><br><span class="line">        <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0x9F</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xA3</span>, <span class="number">0xA0</span>, <span class="number">0xEC</span>, <span class="number">0xAF</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x31</span>, <span class="number">0xB0</span>, <span class="number">0xEC</span>,</span><br><span class="line">        <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x6F</span>, <span class="number">0x14</span>, <span class="number">0x4C</span>, <span class="number">0xEC</span>, <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>,</span><br><span class="line">        <span class="number">0x2F</span>, <span class="number">0xC0</span>, <span class="number">0x2C</span>, <span class="number">0xEC</span>, <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xCC</span>, <span class="number">0x6C</span>, <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB5</span>, <span class="number">0x68</span>,</span><br><span class="line">        <span class="number">0xE6</span>, <span class="number">0x38</span>, <span class="number">0xCA</span>, <span class="number">0xEC</span>, <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x24</span>, <span class="number">0x1B</span>, <span class="number">0xF8</span>, <span class="number">0x04</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0xCA</span>, <span class="number">0x6D</span>,</span><br><span class="line">        <span class="number">0xF5</span>, <span class="number">0xC4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x24</span>, <span class="number">0x1B</span>, <span class="number">0x7D</span>, <span class="number">0x85</span>, <span class="number">0x42</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0xB4</span>, <span class="number">0x63</span>, <span class="number">0xD0</span>, <span class="number">0xF7</span>, <span class="number">0xF4</span>,</span><br><span class="line">        <span class="number">0xD3</span>, <span class="number">0xC0</span>, <span class="number">0x6F</span>, <span class="number">0xF4</span>, <span class="number">0x6F</span>, <span class="number">0x00</span>, <span class="number">0xBB</span>, <span class="number">0xC4</span>, <span class="number">0x38</span>, <span class="number">0x4C</span>, <span class="number">0x3F</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">uint8 *map_data;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> tmp_map[<span class="number">1152</span>]=&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">charArrayToHex</span><span class="params">(uint8* input, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    std::stringstream hexStream;</span><br><span class="line">    hexStream &lt;&lt; std::hex &lt;&lt; std::<span class="built_in">setfill</span>(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        hexStream &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(input[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexStream.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">1152</span>;</span><br><span class="line"></span><br><span class="line">    map_data = (uint8 *) <span class="built_in">malloc</span>(n);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rounds = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        rounds++;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">srand</span>(<span class="number">0xDEADBEEF</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(map_data, map_data_orig, n);</span><br><span class="line">        <span class="comment">// 测试用例</span></span><br><span class="line">        vector&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt; fruits;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; rounds; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> y = <span class="built_in">rand</span>() % <span class="number">20</span>;</span><br><span class="line">            <span class="type">int</span> x = <span class="built_in">rand</span>() % <span class="number">20</span>;</span><br><span class="line">            fruits.<span class="built_in">push_back</span>(&#123;x, y&#125;);</span><br><span class="line"><span class="comment">//            cout &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; y &lt;&lt; &quot;\n&quot;;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">SnakePathFinder <span class="title">pathFinder</span><span class="params">(fruits)</span></span>;</span><br><span class="line"></span><br><span class="line">        vector&lt;uint8&gt; v;</span><br><span class="line"></span><br><span class="line">        v.<span class="built_in">push_back</span>(<span class="number">0x11</span>);</span><br><span class="line">        v.<span class="built_in">push_back</span>(<span class="number">0x12</span>);</span><br><span class="line"></span><br><span class="line">        string path = pathFinder.<span class="built_in">findOptimalPath</span>(<span class="number">10</span>, <span class="number">10</span>, RIGHT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> p : path) &#123;</span><br><span class="line">            <span class="keyword">if</span>(p == <span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    map_data[i] += <span class="number">30</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(p == <span class="string">&#x27;A&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    tmp_map[i] = map_data[i];</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    map_data[i] = tmp_map[(i+<span class="number">6</span>)%n];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(p == <span class="string">&#x27;S&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">                    map_data[i]=(map_data[i]&gt;&gt;<span class="number">5</span>)|(map_data[i]&lt;&lt;<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(p == <span class="string">&#x27;W&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">                    map_data[i]-=<span class="number">102</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MD5 md5 = <span class="built_in">MD5</span>(map_data, n);</span><br><span class="line">        string hexd = md5.<span class="built_in">toStr</span>();</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;round:&quot;</span> &lt;&lt; rounds &lt;&lt; <span class="string">&quot; way: &quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot; md5: &quot;</span> &lt;&lt; hexd &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hexd == <span class="string">&quot;9c06c08f882d7981e91d663364ce5e2e&quot;</span>) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;found it&quot;</span> &lt;&lt;  <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            cout &lt;&lt; <span class="built_in">charArrayToHex</span>(map_data, n);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;nop\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rounds &gt; <span class="number">1000</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当吃到第十个果子的时候就出了，得到正确的代码片段，就是一个魔改xtea</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> enc[<span class="number">4</span>] = &#123;<span class="number">0x98d9a098</span>,</span><br><span class="line">                           <span class="number">0x711b97ba</span>,</span><br><span class="line">                           <span class="number">0x2f44819b</span>,</span><br><span class="line">                           <span class="number">0xdf37b855</span>&#125;;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key[<span class="number">4</span>] = &#123;<span class="number">0x63313357</span>,</span><br><span class="line">                           <span class="number">0x2e336d30</span>,</span><br><span class="line">                           <span class="number">0x51203220</span>,</span><br><span class="line">                           <span class="number">0x38734257</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">long</span> sum = <span class="number">0</span>, delta = <span class="number">0x9E3779B9</span>;</span><br><span class="line">    enc[<span class="number">2</span>] ^= enc[<span class="number">1</span>];</span><br><span class="line">    enc[<span class="number">3</span>] ^= enc[<span class="number">0</span>];</span><br><span class="line">    enc[<span class="number">1</span>] ^= enc[<span class="number">3</span>];</span><br><span class="line">    enc[<span class="number">0</span>] ^= enc[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i += <span class="number">2</span>) &#123;</span><br><span class="line">        sum = (<span class="number">32</span> * delta * (i / <span class="number">2</span> + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">32</span>; j++) &#123;</span><br><span class="line">            enc[i + <span class="number">1</span>] -= (((enc[i] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * enc[i])) + enc[i]) ^ (key[((sum &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>)] + sum);<span class="comment">//容易魔改</span></span><br><span class="line">            sum -= delta;</span><br><span class="line">            enc[i] -= (((enc[i + <span class="number">1</span>] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * enc[i + <span class="number">1</span>])) + enc[i + <span class="number">1</span>]) ^ (key[(sum &amp; <span class="number">3</span>)] + sum);<span class="comment">//容易魔改</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (enc[i] &gt;&gt; (j * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// flag&#123;G0@d_Snake&#125;</span></span><br></pre></td></tr></table></figure><h2 id="DLS2XLS"><a href="#DLS2XLS" class="headerlink" title="DLS2XLS"></a>DLS2XLS</h2><p>​一个罗总正在玩的一个很老的游戏，他给了我几个游戏数据要我还原数据，还给了我一个老外写的一个数据转换的exe，但是是用c#写的，直接逆c#了。</p><p>​程序要先读入一个cfg的格式文件，然后再还原dfs，逆向这个程序找到关键代码段。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/2.1.png" alt="2.1"></p><p>可以发现dfs文件具有一个0x89字节的文件头，然后后面12字节都是一段总的数据，用来和cfg进行对比匹配。</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/2.2.png" alt="2.2"></p><p>然后根据cfg文件里的数据类型，分成一个m*n的表格，进行数据的转换。</p><p>由此可以推出游戏数据格式</p><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/2.3.png" alt="2.3"></p><p>数据都是以int小端序输入的</p><p>红色：每段数据的大小</p><p>蓝色：每段数据有几个类型</p><p>绿色：一共有多少这样的数据</p><p>于是可以模仿那个程序写个脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> fnmatch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_cfg_file</span>(<span class="params">directory, filename</span>):</span><br><span class="line">    filename = filename.lower()</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory): </span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> fnmatch.fnmatch(file.lower(), <span class="string">f&quot;<span class="subst">&#123;filename&#125;</span>.cfg&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> os.path.join(root, file)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_dfs_file</span>(<span class="params">directory, filename</span>):</span><br><span class="line">    filename = filename.lower()</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory): </span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> fnmatch.fnmatch(file.lower(), <span class="string">f&quot;<span class="subst">&#123;filename&#125;</span>.dfs&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> os.path.join(root, file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_line</span>(<span class="params">file_path,i</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.readlines()</span><br><span class="line">            <span class="keyword">return</span> content[i]</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;读取cfg文件时发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_dfs_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">            <span class="keyword">return</span> content</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;读取dfs文件时发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">an_cfg</span>(<span class="params">text</span>):</span><br><span class="line">    result = []</span><br><span class="line">    </span><br><span class="line">    types = text.split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> data_type <span class="keyword">in</span> types:</span><br><span class="line">        <span class="keyword">if</span> data_type.startswith(<span class="string">&#x27;int32&#x27;</span>):</span><br><span class="line">            result.append(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">elif</span> data_type.startswith(<span class="string">&#x27;int16&#x27;</span>):</span><br><span class="line">            result.append(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">elif</span> data_type.startswith(<span class="string">&#x27;int8&#x27;</span>):</span><br><span class="line">            result.append(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> data_type.startswith(<span class="string">&#x27;wstring&#x27;</span>):</span><br><span class="line">            <span class="comment"># 解析出 wstring 后的数字部分</span></span><br><span class="line">            length = <span class="built_in">int</span>(data_type.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">            result.append(length)</span><br><span class="line">        <span class="keyword">elif</span> data_type.startswith(<span class="string">&#x27;string&#x27;</span>):</span><br><span class="line">            <span class="comment"># 解析出 string 后的数字部分</span></span><br><span class="line">            length = <span class="built_in">int</span>(data_type.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">            result.append(length)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;Text_SkillTable&quot;</span><span class="comment">#文件名</span></span><br><span class="line">current_directory = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfgdirectory = current_directory+<span class="string">&#x27;\cfg&#x27;</span> </span><br><span class="line">cfg_file_path = find_cfg_file(cfgdirectory, filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg_file_path:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;找到cfg文件：<span class="subst">&#123;cfg_file_path&#125;</span>&quot;</span>)</span><br><span class="line">    cfg_content = read_file_line(cfg_file_path,-<span class="number">1</span>)<span class="comment">#读入数据类型</span></span><br><span class="line">    cfg_top =read_file_line(cfg_file_path,-<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(cfg_content,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">type</span>=an_cfg(cfg_content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;size =&quot;</span>,<span class="built_in">sum</span>(<span class="built_in">type</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;未找到对应的.cfg 文件&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">dfsdirectory = current_directory+<span class="string">&#x27;\dfs&#x27;</span> </span><br><span class="line">dfs_file_path = find_dfs_file(dfsdirectory, filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> dfs_file_path:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;找到dfs文件：<span class="subst">&#123;dfs_file_path&#125;</span>&quot;</span>)</span><br><span class="line">    dfs_content = read_dfs_file(dfs_file_path)</span><br><span class="line">    d_size=<span class="built_in">int</span>.from_bytes(dfs_content[<span class="number">0x89</span>:<span class="number">0x8c</span>],<span class="string">&quot;little&quot;</span>)</span><br><span class="line">    col=<span class="built_in">int</span>.from_bytes(dfs_content[<span class="number">0x8d</span>:<span class="number">0x90</span>],<span class="string">&quot;little&quot;</span>)</span><br><span class="line">    n=<span class="built_in">int</span>.from_bytes(dfs_content[<span class="number">0x91</span>:<span class="number">0x94</span>],<span class="string">&quot;little&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;size =&quot;</span>,d_size)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;col =&quot;</span>,col)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;n =&quot;</span>,n)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;未找到对应的.dfs 文件&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(d_size!=<span class="built_in">sum</span>(<span class="built_in">type</span>)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;dfs文件与cfg文件不匹配&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(<span class="built_in">type</span>)==col):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;尝试解密...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;一共&#123;&#125;列&quot;</span>.<span class="built_in">format</span>(col))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(cfg_top)</span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">                text=dfs_content[<span class="number">0x95</span>+o*d_size:<span class="number">0x95</span>+(o+<span class="number">1</span>)*d_size]</span><br><span class="line">                <span class="comment"># print(text)</span></span><br><span class="line">                tmp=<span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">type</span>:</span><br><span class="line">                    <span class="keyword">if</span> t&lt;=<span class="number">8</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="built_in">int</span>.from_bytes(text[tmp:tmp+t],<span class="string">&quot;little&quot;</span>),end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        t=d_size-tmp</span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, t-<span class="number">2</span>, <span class="number">2</span>):</span><br><span class="line">                            <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>.from_bytes(text[tmp+i:tmp+i+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>)),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>()</span><br><span class="line">                    tmp=tmp+t</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;成功匹配开始解密...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cfg_top)</span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    text=dfs_content[<span class="number">0x95</span>+o*d_size:<span class="number">0x95</span>+(o+<span class="number">1</span>)*d_size]</span><br><span class="line">    <span class="comment"># print(text)</span></span><br><span class="line">    tmp=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">type</span>:</span><br><span class="line">        <span class="keyword">if</span> t&lt;=<span class="number">8</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">int</span>.from_bytes(text[tmp:tmp+t],<span class="string">&quot;little&quot;</span>),end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, t-<span class="number">2</span>, <span class="number">2</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>.from_bytes(text[tmp+i:tmp+i+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>)),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>,end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">        tmp=tmp+t</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure><p><img src="/../img/%E6%B5%85%E8%B0%88%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/2.4.png" alt="2.4"></p><p>​用python简单还原了一下，感觉还是有许多数据匹配不上，做了个尝试解密的，感觉肯定是老罗给的数据结构文件有问题</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​游戏逆向也是逆向的一大类，还未总结的python系列与unity系列都是逆向的大头，成型的结构和开发系统，会让逆向更难啊。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;浅谈ctf中的游戏逆向&quot;&gt;&lt;a href=&quot;#浅谈ctf中的游戏逆向&quot; class=&quot;headerlink&quot; title=&quot;浅谈ctf中的游戏逆向&quot;&gt;&lt;/a&gt;浅谈ctf中的游戏逆向&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;head</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>swift-re常见的加密解密</title>
    <link href="https://straw-233.github.io/2024/10/09/swift-re%E5%B8%B8%E8%A7%81%E7%9A%84%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/"/>
    <id>https://straw-233.github.io/2024/10/09/swift-re%E5%B8%B8%E8%A7%81%E7%9A%84%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/</id>
    <published>2024-10-09T12:29:28.255Z</published>
    <updated>2024-10-13T10:41:57.709Z</updated>
    
    <content type="html"><![CDATA[<h1 id="swift-re常见的加密解密"><a href="#swift-re常见的加密解密" class="headerlink" title="swift-re常见的加密解密"></a>swift-re常见的加密解密</h1><p>在xcode里用swift写了点加密解密，以后都放着这里了。。</p><h2 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RC4</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> state <span class="operator">=</span> [<span class="type">UInt8</span>](repeating: <span class="number">0</span>, count: <span class="number">256</span>)</span><br><span class="line">    <span class="keyword">init</span>(<span class="params">key</span>: [<span class="type">UInt8</span>]) &#123;</span><br><span class="line">        <span class="keyword">var</span> j:<span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="number">256</span> &#123;</span><br><span class="line">            state[i] <span class="operator">=</span> <span class="type">UInt8</span>(i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="number">256</span> &#123;</span><br><span class="line">            j <span class="operator">=</span> (j <span class="operator">+</span> <span class="type">Int</span>(state[i]) <span class="operator">+</span> <span class="type">Int</span>(key[i <span class="operator">%</span> key.count])) <span class="operator">%</span> <span class="number">256</span></span><br><span class="line">            state.swapAt(i, j)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">encrypt</span>(<span class="params">data</span>: <span class="keyword">inout</span> [<span class="type">UInt8</span>])&#123;</span><br><span class="line">        <span class="keyword">var</span> x: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> y: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span>data.count &#123;</span><br><span class="line">            x <span class="operator">=</span> (x <span class="operator">+</span> <span class="number">1</span>) <span class="operator">%</span> <span class="number">256</span></span><br><span class="line">            y <span class="operator">=</span> (y <span class="operator">+</span> <span class="type">Int</span>(state[x])) <span class="operator">%</span> <span class="number">256</span></span><br><span class="line">            <span class="keyword">let</span> temp <span class="operator">=</span> state[x]</span><br><span class="line">            state[x]<span class="operator">=</span>state[y]</span><br><span class="line">            state[y]<span class="operator">=</span>temp</span><br><span class="line">            <span class="keyword">let</span> t <span class="operator">=</span> state[(<span class="type">Int</span>(state[x]) <span class="operator">+</span> <span class="type">Int</span>(state[y])) <span class="operator">%</span> <span class="number">256</span>]</span><br><span class="line">            data[i] <span class="operator">=</span> data[i] <span class="operator">^</span> t</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> key: [<span class="type">UInt8</span>] <span class="operator">=</span> <span class="type">Array</span>(<span class="string">&quot;qwq&quot;</span>.utf8)</span><br><span class="line"><span class="keyword">let</span> rc4<span class="operator">=</span><span class="type">RC4</span>(key: key)</span><br><span class="line"><span class="keyword">var</span> text: [<span class="type">UInt8</span>] <span class="operator">=</span> <span class="type">Array</span>(<span class="string">&quot;straw&quot;</span>.utf8)</span><br><span class="line">rc4.encrypt(data: <span class="operator">&amp;</span>text)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span>text.count&#123;</span><br><span class="line">    <span class="keyword">var</span> texthex<span class="operator">=</span><span class="type">String</span>(format: <span class="string">&quot;0x%02x&quot;</span>, text[i])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(texthex)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="TEA"><a href="#TEA" class="headerlink" title="TEA"></a>TEA</h2><h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">var</span> flag: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;liufeiyu&quot;</span></span><br><span class="line"><span class="keyword">var</span> hexArray:[<span class="type">UInt8</span>?]<span class="operator">=</span>[]</span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> flag&#123;</span><br><span class="line">    hexArray.append(ch.asciiValue)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> v0:<span class="type">UInt32</span></span><br><span class="line"><span class="keyword">var</span> v1:<span class="type">UInt32</span></span><br><span class="line"><span class="keyword">var</span> sum:<span class="type">UInt32</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="comment">//print(hexArray)</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">I32Array</span>:[<span class="type">UInt32</span>]<span class="operator">=</span>[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">stride</span>(from: <span class="number">0</span>, to: hexArray.count, by: <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> byte1 <span class="operator">=</span> <span class="type">UInt32</span>(hexArray[i]<span class="operator">!</span>)</span><br><span class="line">    <span class="keyword">let</span> byte2 <span class="operator">=</span> <span class="type">UInt32</span>(hexArray[i <span class="operator">+</span> <span class="number">1</span>]<span class="operator">!</span>) <span class="operator">&lt;&lt;</span> <span class="number">8</span></span><br><span class="line">    <span class="keyword">let</span> byte3 <span class="operator">=</span> <span class="type">UInt32</span>(hexArray[i <span class="operator">+</span> <span class="number">2</span>]<span class="operator">!</span>) <span class="operator">&lt;&lt;</span> <span class="number">16</span></span><br><span class="line">    <span class="keyword">let</span> byte4 <span class="operator">=</span> <span class="type">UInt32</span>(hexArray[i <span class="operator">+</span> <span class="number">3</span>]<span class="operator">!</span>) <span class="operator">&lt;&lt;</span> <span class="number">24</span></span><br><span class="line">    <span class="type">I32Array</span>.append(byte1 <span class="operator">|</span> byte2 <span class="operator">|</span> byte3 <span class="operator">|</span> byte4)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="type">I32Array</span>)</span><br><span class="line"><span class="keyword">let</span> key: [<span class="type">UInt32</span>] <span class="operator">=</span> [<span class="number">0x1</span>,<span class="number">0x1</span>,<span class="number">0x4</span>,<span class="number">0x5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="type">I32Array</span>.count<span class="operator">/</span><span class="number">2</span>&#123;</span><br><span class="line">    v0<span class="operator">=</span><span class="type">I32Array</span>[<span class="number">2</span><span class="operator">*</span>i]</span><br><span class="line">    v1<span class="operator">=</span><span class="type">I32Array</span>[<span class="number">2</span><span class="operator">*</span>i<span class="operator">+</span><span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="number">32</span> &#123;</span><br><span class="line">        sum <span class="operator">=</span> <span class="type">UInt32</span>((<span class="type">UInt64</span>(sum) <span class="operator">+</span> <span class="type">UInt64</span>(<span class="number">0x9e3779b9</span>)) <span class="operator">&amp;</span> <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        v0 <span class="operator">&amp;+=</span> <span class="type">UInt32</span>((((<span class="type">UInt64</span>(v1) <span class="operator">&lt;&lt;</span> <span class="number">4</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">0</span>])) <span class="operator">^</span> (<span class="type">UInt64</span>(v1) <span class="operator">+</span> <span class="type">UInt64</span>(sum)) <span class="operator">^</span> ((<span class="type">UInt64</span>(v1) <span class="operator">&gt;&gt;</span> <span class="number">5</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">1</span>])))<span class="operator">&amp;</span><span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        v1 <span class="operator">&amp;+=</span> <span class="type">UInt32</span>((((<span class="type">UInt64</span>(v0) <span class="operator">&lt;&lt;</span> <span class="number">4</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">2</span>])) <span class="operator">^</span> (<span class="type">UInt64</span>(v0) <span class="operator">+</span> <span class="type">UInt64</span>(sum)) <span class="operator">^</span> ((<span class="type">UInt64</span>(v0) <span class="operator">&gt;&gt;</span> <span class="number">5</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">3</span>])))<span class="operator">&amp;</span><span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">I32Array</span>[<span class="number">2</span><span class="operator">*</span>i]<span class="operator">=</span>v0</span><br><span class="line">    <span class="type">I32Array</span>[<span class="number">2</span><span class="operator">*</span>i<span class="operator">+</span><span class="number">1</span>]<span class="operator">=</span>v1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="type">I32Array</span>)</span><br></pre></td></tr></table></figure><p>还没包装，等后面有时间包装一下</p><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">let</span> key: [<span class="type">UInt32</span>] <span class="operator">=</span> [<span class="number">0x1</span>,<span class="number">0x1</span>,<span class="number">0x4</span>,<span class="number">0x5</span>]</span><br><span class="line"><span class="keyword">var</span> pw: [<span class="type">UInt32</span>] <span class="operator">=</span> [<span class="number">0x5f031f51</span>,<span class="number">0xae732304</span>,<span class="number">0xa6bdef67</span>,<span class="number">0x15c0218b</span>,<span class="number">0x4ec46f64</span>,<span class="number">0x8bfccb46</span>,<span class="number">0x90eebc4a</span>,<span class="number">0xa9aa0c03</span> ]</span><br><span class="line"><span class="keyword">var</span> v0:<span class="type">UInt32</span></span><br><span class="line"><span class="keyword">var</span> v1:<span class="type">UInt32</span></span><br><span class="line"><span class="keyword">var</span> sum:<span class="type">UInt32</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span>pw.count<span class="operator">/</span><span class="number">2</span>&#123;</span><br><span class="line">    v0<span class="operator">=</span>pw[<span class="number">2</span><span class="operator">*</span>i]</span><br><span class="line">    v1<span class="operator">=</span>pw[<span class="number">2</span><span class="operator">*</span>i<span class="operator">+</span><span class="number">1</span>];</span><br><span class="line">    sum<span class="operator">=</span><span class="type">UInt32</span>(<span class="type">UInt64</span>(<span class="number">32</span><span class="operator">*</span><span class="number">0x9E3779B9</span>)<span class="operator">&amp;</span><span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="number">32</span> &#123;</span><br><span class="line">        v1 <span class="operator">&amp;-=</span> <span class="type">UInt32</span>((((<span class="type">UInt64</span>(v0) <span class="operator">&lt;&lt;</span> <span class="number">4</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">2</span>])) <span class="operator">^</span> (<span class="type">UInt64</span>(v0) <span class="operator">+</span> <span class="type">UInt64</span>(sum)) <span class="operator">^</span> ((<span class="type">UInt64</span>(v0) <span class="operator">&gt;&gt;</span> <span class="number">5</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">3</span>])))<span class="operator">&amp;</span><span class="number">0xFFFFFFFF</span>)</span><br><span class="line"><span class="comment">//        print(v1)</span></span><br><span class="line">        v0 <span class="operator">&amp;-=</span> <span class="type">UInt32</span>((((<span class="type">UInt64</span>(v1) <span class="operator">&lt;&lt;</span> <span class="number">4</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">0</span>])) <span class="operator">^</span> (<span class="type">UInt64</span>(v1) <span class="operator">+</span> <span class="type">UInt64</span>(sum)) <span class="operator">^</span> ((<span class="type">UInt64</span>(v1) <span class="operator">&gt;&gt;</span> <span class="number">5</span>) <span class="operator">+</span> <span class="type">UInt64</span>(key[<span class="number">1</span>])))<span class="operator">&amp;</span><span class="number">0xFFFFFFFF</span>)</span><br><span class="line"><span class="comment">//        print(v0)</span></span><br><span class="line">        sum <span class="operator">=</span> <span class="type">UInt32</span>((<span class="type">UInt64</span>(sum) <span class="operator">+</span> <span class="type">UInt64</span>(<span class="number">0x61C88647</span>)) <span class="operator">&amp;</span> <span class="number">0xFFFFFFFF</span>)</span><br><span class="line"><span class="comment">//        print(sum)</span></span><br><span class="line">            &#125;</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">3</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> v0hex<span class="operator">=</span><span class="type">String</span>(format: <span class="string">&quot;%c&quot;</span>, (v0<span class="operator">&gt;&gt;</span>(j<span class="operator">*</span><span class="number">8</span>))<span class="operator">&amp;</span><span class="number">0xff</span>)</span><br><span class="line">        <span class="built_in">print</span>(v0hex,terminator: <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">0</span><span class="operator">...</span><span class="number">3</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> v1hex<span class="operator">=</span><span class="type">String</span>(format: <span class="string">&quot;%c&quot;</span>, (v1<span class="operator">&gt;&gt;</span>(j<span class="operator">*</span><span class="number">8</span>))<span class="operator">&amp;</span><span class="number">0xff</span>)</span><br><span class="line">        <span class="built_in">print</span>(v1hex,terminator: <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>被swift的检测恶心了，数据溢出或者类型不匹配直接报错，必须全加一遍类型修正。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;swift-re常见的加密解密&quot;&gt;&lt;a href=&quot;#swift-re常见的加密解密&quot; class=&quot;headerlink&quot; title=&quot;swift-re常见的加密解密&quot;&gt;&lt;/a&gt;swift-re常见的加密解密&lt;/h1&gt;&lt;p&gt;在xcode里用swift写了点加密</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>vm--插曲</title>
    <link href="https://straw-233.github.io/2024/07/17/vm/"/>
    <id>https://straw-233.github.io/2024/07/17/vm/</id>
    <published>2024-07-17T05:24:15.369Z</published>
    <updated>2024-07-18T07:20:39.509Z</updated>
    
    <content type="html"><![CDATA[<h1 id="VM"><a href="#VM" class="headerlink" title="VM"></a>VM</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>一个虚拟机指令集，相当于自己写了个虚拟机，执行自己写的指令，来实现程序的运行，我觉得有点套中套的味道了</p><h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><p>分析代码能力，<strong>扎实的汇编基础</strong>，chatgpt的熟练使用</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>简单学习一下vm，以WcyVM(nctf2018)为例</p><p><img src="/../img/vm/1.png" alt="1"></p><p>这就是一个经典的vm题目，下面的一堆case就分别代表不同的指令集，上面的v4，v5就代表不同的寄存器，用来存储和操作数据，那么我们首先需要做什么呢？</p><h3 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h3><p><img src="/../img/vm/2.png" alt="2"></p><p>opcode也就是操作码，用来判断这个程序是根据什么顺序运行的，有些题的opcode是只有操作的，但是有些题的opcode还会有带上参数什么的，这题就是</p><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p><img src="/../img/vm/3.png" alt="3"></p><h3 id="操作分析"><a href="#操作分析" class="headerlink" title="操作分析"></a>操作分析</h3><h4 id="case-0x8"><a href="#case-0x8" class="headerlink" title="case 0x8"></a>case 0x8</h4><p><img src="/../img/vm/4.png" alt="4"></p><p><img src="/../img/vm/5.png" alt="5"></p><p>传入R和数据，a2值传入a1，相当于mov指令</p><h4 id="case-0x9"><a href="#case-0x9" class="headerlink" title="case 0x9"></a>case 0x9</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_40096D(v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], &amp;v4[<span class="number">4</span>], v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_40096D</span><span class="params">(_DWORD *a1, _DWORD **a2, _QWORD *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a1 = *(*a2)++;</span><br><span class="line">  result = a3;</span><br><span class="line">  *a3 += <span class="number">8LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入R和栈，a2传入a1，a2++，相当于pop指令</p><h4 id="case-0xa"><a href="#case-0xa" class="headerlink" title="case 0xa"></a>case 0xa</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400927(v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], &amp;v4[<span class="number">4</span>], v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_400927</span><span class="params">(_DWORD *a1, _QWORD *a2, _QWORD *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a2 -= <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)*a2 = *a1;</span><br><span class="line">  result = a3;</span><br><span class="line">  *a3 += <span class="number">8LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入R和栈，a2-4，a1传入a2，相当于push指令</p><h4 id="case-0xb，0xc"><a href="#case-0xb，0xc" class="headerlink" title="case 0xb，0xc"></a>case 0xb，0xc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_4009B3(v4[<span class="number">0</span>], v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_4009B3</span><span class="params">(<span class="type">int</span> *a1, _QWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a1 = getchar();</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 += <span class="number">4LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_4009E5</span><span class="params">(<span class="type">int</span> *a1, _QWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">putchar</span>(*a1);</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 += <span class="number">4LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入R0，R0&#x3D;getchar()，R0&#x3D;putchar()操作</p><h4 id="case-0xd"><a href="#case-0xd" class="headerlink" title="case 0xd"></a>case 0xd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400B5D(&amp;v1, v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">8</span>) - <span class="number">1</span>], v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_400B5D</span><span class="params">(_DWORD *a1, _DWORD *a2, _DWORD *a3, _QWORD *a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *a2 == *a3 )</span><br><span class="line">    v4 = <span class="number">0x80</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">  *a1 |= v4;</span><br><span class="line">  <span class="keyword">if</span> ( *a3 &gt;= *a2 )</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">64</span>;</span><br><span class="line">  *a1 |= v5;</span><br><span class="line">  <span class="keyword">if</span> ( *a2 &gt;= *a3 )</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v6 = <span class="number">32</span>;</span><br><span class="line">  *a1 |= v6;</span><br><span class="line">  result = a4;</span><br><span class="line">  *a4 += <span class="number">12LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比较难的部分，但不是很关键的部分</p><p>传入了两个R和v1，进行了比较，只有相等了才能使v1&#x3D;80然后接下来下面的操作</p><h4 id="case-0xe"><a href="#case-0xe" class="headerlink" title="case 0xe"></a>case 0xe</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400A34(v5, *(<span class="type">unsigned</span> <span class="type">int</span> *)(v5[<span class="number">0</span>] + <span class="number">4</span>), dest);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_400A34</span><span class="params">(_QWORD *a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = a1;</span><br><span class="line">  *a1 = a3 + <span class="number">4LL</span> * a2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入了数据和dest，使v5发生改变，相当于是一个跳转指令，jmp</p><h4 id="case-0xf，0x10"><a href="#case-0xf，0x10" class="headerlink" title="case 0xf，0x10"></a>case 0xf，0x10</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400AAF(v1, v5, *(<span class="type">unsigned</span> <span class="type">int</span> *)(v5[<span class="number">0</span>] + <span class="number">4</span>), dest);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 *__fastcall <span class="title function_">sub_400AAF</span><span class="params">(<span class="type">char</span> a1, __int64 *a2, <span class="type">unsigned</span> <span class="type">int</span> a3, __int64 a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (a1 &amp; <span class="number">0x80</span>) != <span class="number">0</span> )</span><br><span class="line">    v4 = *a2 + <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4 = a4 + <span class="number">4LL</span> * a3;</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 = v4;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 *__fastcall <span class="title function_">sub_400A61</span><span class="params">(<span class="type">char</span> a1, __int64 *a2, <span class="type">unsigned</span> <span class="type">int</span> a3, __int64 a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (a1 &amp; <span class="number">0x80</span>) != <span class="number">0</span> )</span><br><span class="line">    v4 = a4 + <span class="number">4LL</span> * a3;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4 = *a2 + <span class="number">8</span>;</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 = v4;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入数据和dest和v1，两个代码的if和else反一下，其实就是一个是jz，一个是jnz</p><h4 id="case-0x11，0x12"><a href="#case-0x11，0x12" class="headerlink" title="case 0x11，0x12"></a>case 0x11，0x12</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400AFD(v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_400AFD</span><span class="params">(_DWORD *a1, _QWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  ++*a1;</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 += <span class="number">8LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">sub_400B2D</span><span class="params">(_DWORD *a1, _QWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  --*a1;</span><br><span class="line">  result = a2;</span><br><span class="line">  *a2 += <span class="number">8LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只传入了R，很简单的+1，-1操作，inc，dec</p><h4 id="case-0x13，0x14，0x15，0x16，0x17，0x1D"><a href="#case-0x13，0x14，0x15，0x16，0x17，0x1D" class="headerlink" title="case 0x13，0x14，0x15，0x16，0x17，0x1D"></a>case 0x13，0x14，0x15，0x16，0x17，0x1D</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400C0E((_DWORD *)v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], *(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">8</span>), v5);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400C43((_DWORD *)v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], (_DWORD *)v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">8</span>) - <span class="number">1</span>], v5);</span><br></pre></td></tr></table></figure><p>很简单的+，-，&amp;，|，*操作，看好是传入数据还是R就行</p><h4 id="case-0x19，0x1A，0x1B，0x1C"><a href="#case-0x19，0x1A，0x1B，0x1C" class="headerlink" title="case 0x19，0x1A，0x1B，0x1C"></a>case 0x19，0x1A，0x1B，0x1C</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_400889((_DWORD *)v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">4</span>) - <span class="number">1</span>], v4[*(_DWORD *)(v5[<span class="number">0</span>] + <span class="number">8</span>) - <span class="number">1</span>], v5);</span><br></pre></td></tr></table></figure><p>各种类型的mov操作，地址啥的</p><h3 id="opcode——汇编还原"><a href="#opcode——汇编还原" class="headerlink" title="opcode——汇编还原"></a>opcode——汇编还原</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">opcode = [</span><br><span class="line">    <span class="number">0x00000008</span>, <span class="number">0x00000001</span>, <span class="number">0x00000000</span>, </span><br><span class="line">    <span class="number">0x00000008</span>, <span class="number">0x00000003</span>, <span class="number">0x00000046</span>, </span><br><span class="line">    <span class="number">0x0000000E</span>, <span class="number">0x00000015</span>, </span><br><span class="line">    <span class="number">0x0000000A</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x00000009</span>, <span class="number">0x00000002</span>, </span><br><span class="line">    <span class="number">0x0000000B</span>, </span><br><span class="line">    <span class="number">0x0000000A</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x0000000A</span>, <span class="number">0x00000002</span>, </span><br><span class="line">    <span class="number">0x00000009</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x00000011</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x0000000D</span>, <span class="number">0x00000001</span>, <span class="number">0x00000003</span>, </span><br><span class="line">    <span class="number">0x0000000F</span>, <span class="number">0x00000008</span>, </span><br><span class="line">    <span class="number">0x00000008</span>, <span class="number">0x00000001</span>, <span class="number">0x00000000</span>, </span><br><span class="line">    <span class="number">0x00000008</span>, <span class="number">0x00000003</span>, <span class="number">0x00000047</span>, </span><br><span class="line">    <span class="number">0x0000000E</span>, <span class="number">0x00000046</span>, </span><br><span class="line">    <span class="number">0x0000000A</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x0000001A</span>, <span class="number">0x00000002</span>, <span class="number">0x00000006</span>, </span><br><span class="line">    <span class="number">0x0000001D</span>, <span class="number">0x00000001</span>, <span class="number">0x00000004</span>, </span><br><span class="line">    <span class="number">0x00000014</span>, <span class="number">0x00000002</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x00000019</span>, <span class="number">0x00000001</span>, <span class="number">0x00000002</span>, </span><br><span class="line">    <span class="number">0x0000001B</span>, <span class="number">0x00000001</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x0000001D</span>, <span class="number">0x00000001</span>, <span class="number">0x0000006E</span>, </span><br><span class="line">    <span class="number">0x00000013</span>, <span class="number">0x00000001</span>, <span class="number">0x00000063</span>, </span><br><span class="line">    <span class="number">0x00000015</span>, <span class="number">0x00000001</span>, <span class="number">0x00000074</span>, </span><br><span class="line">    <span class="number">0x00000013</span>, <span class="number">0x00000001</span>, <span class="number">0x00000066</span>, </span><br><span class="line">    <span class="number">0x0000001C</span>, <span class="number">0x00000002</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x00000009</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x00000011</span>, <span class="number">0x00000001</span>, </span><br><span class="line">    <span class="number">0x0000000D</span>, <span class="number">0x00000001</span>, <span class="number">0x00000003</span>, </span><br><span class="line">    <span class="number">0x0000000F</span>, <span class="number">0x00000022</span>, <span class="number">0x00000064</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm</span>(<span class="params">i, c</span>):</span><br><span class="line">    <span class="keyword">if</span> c == <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mov R&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">9</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;pop R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xa</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;push R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xb</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;R0=getchar()&quot;</span>)</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xc</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;R0=putchar()&quot;</span>)</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xd</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;cmp R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        jnz &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i+<span class="number">3</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        mov a, 80&quot;</span>)</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xe</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;jmp &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0xf</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i +<span class="string">&quot;and a, 80&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        test a a&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        jnz &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]))</span><br><span class="line">        i+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x10</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i +<span class="string">&quot;and a, 80&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        test a a&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;        jz &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]))</span><br><span class="line">        i+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x11</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;inc R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x12</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;dec R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x13</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;add R&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x14</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;sub R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x15</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;xor R&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x16</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;and R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x17</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;or R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x19</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mov R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x1A</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mov R&#123;&#125; R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x1B</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mov R&#123;&#125; [R&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x1C</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mov [R&#123;&#125;] R&#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]-<span class="number">1</span>))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">0x1D</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;_%02X:\t&quot;</span> % i + <span class="string">&quot;mul R&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(opcode[i+<span class="number">1</span>]-<span class="number">1</span>,opcode[i+<span class="number">2</span>]))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(i&lt;<span class="built_in">len</span>(opcode)-<span class="number">1</span>):</span><br><span class="line">    i=disasm(i,opcode[i])</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">_00:    mov R0 0</span><br><span class="line">_03:    mov R2 70</span><br><span class="line">_06:    jmp 21</span><br><span class="line"></span><br><span class="line">_08:    push R0</span><br><span class="line">_0A:    pop R1</span><br><span class="line">_0C:    R0=getchar()</span><br><span class="line">_0D:    push R0</span><br><span class="line">_0F:    push R1</span><br><span class="line">_11:    pop R0</span><br><span class="line">_13:    inc R0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_15:    cmp R0 R2</span><br><span class="line">        jnz 24</span><br><span class="line">        mov a, 80</span><br><span class="line">_18:    and a, 80</span><br><span class="line">        test a a</span><br><span class="line">        jnz 8</span><br><span class="line">_1A:    mov R0 0</span><br><span class="line">_1D:    mov R2 71</span><br><span class="line">_20:    jmp 70</span><br><span class="line"></span><br><span class="line">_22:    push R0</span><br><span class="line">_24:    mov R1 R5</span><br><span class="line">_27:    mul R0 4</span><br><span class="line">_2A:    sub R1 R0</span><br><span class="line">_2D:    mov R0 R1</span><br><span class="line">_30:    mov R0 [R0]</span><br><span class="line">_33:    mul R0 110</span><br><span class="line">_36:    add R0 99</span><br><span class="line">_39:    xor R0 116</span><br><span class="line">_3C:    add R0 102</span><br><span class="line">_3F:    mov [R1] R0</span><br><span class="line">_42:    pop R0</span><br><span class="line">_44:    inc R0</span><br><span class="line"></span><br><span class="line">_46:    cmp R0 R2</span><br><span class="line">        jnz 73</span><br><span class="line">        mov a, 80</span><br><span class="line">_49:    and a, 80</span><br><span class="line">        test a a</span><br><span class="line">        jnz 34</span><br></pre></td></tr></table></figure><p>因为比较长，看不懂的话直接交给gpt处理，当然其实重要的代码就这么点</p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">R0 = 0         // 初始化 R0 为 0</span><br><span class="line">R2 = 70        // 初始化 R2 为 70</span><br><span class="line">跳转到 标签1</span><br><span class="line"></span><br><span class="line">标签0:</span><br><span class="line">压栈(R0)       // 将 R0 的值压入栈</span><br><span class="line">R1 = 弹栈()     // 从栈中弹出一个值到 R1</span><br><span class="line">R0 = 获取字符() // 从输入中读取一个字符到 R0</span><br><span class="line">压栈(R0)       // 将 R0 的值压入栈</span><br><span class="line">压栈(R1)       // 将 R1 的值压入栈</span><br><span class="line">R0 = 弹栈()     // 从栈中弹出一个值到 R0</span><br><span class="line">R0 = R0 + 1    // 将 R0 增加 1</span><br><span class="line"></span><br><span class="line">标签1:</span><br><span class="line">如果 (R0 != R2) &#123; // 比较 R0 和 R2</span><br><span class="line">    a = 80        // 如果不相等，将 a 设置为 80</span><br><span class="line">&#125;</span><br><span class="line">a = a &amp; 80      // 执行 a 和 80 的按位与操作</span><br><span class="line">如果 (a != 0) &#123;   // 测试 a 是否为非零</span><br><span class="line">    跳转到 标签0 // 如果非零，跳转到 标签0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">R0 = 0         // 初始化 R0 为 0</span><br><span class="line">R2 = 71        // 初始化 R2 为 71</span><br><span class="line">跳转到 标签2</span><br><span class="line"></span><br><span class="line">标签3:</span><br><span class="line">压栈(R0)       // 将 R0 的值压入栈</span><br><span class="line">R1 = 5         // 设置 R1 为 5</span><br><span class="line">R0 = R0 * 4    // 将 R0 乘以 4</span><br><span class="line">R1 = R1 - R0   // 将 R0 从 R1 中减去</span><br><span class="line">R0 = R1        // 将结果赋给 R0</span><br><span class="line">R0 = 内存[R0]  // 访问地址为 R0 的内存</span><br><span class="line">R0 = R0 * 110  // 将 R0 乘以 110</span><br><span class="line">R0 = R0 + 99   // 将 R0 加 99</span><br><span class="line">R0 = R0 ^ 116  // 将 R0 与 116 进行异或操作</span><br><span class="line">R0 = R0 + 102  // 将 R0 加 102</span><br><span class="line">内存[R1] = R0  // 将结果存储回地址为 R1 的内存</span><br><span class="line">R0 = 弹栈()     // 从栈中弹出一个值到 R0</span><br><span class="line">R0 = R0 + 1    // 将 R0 增加 1</span><br><span class="line"></span><br><span class="line">标签2:</span><br><span class="line">如果 (R0 != R2) &#123; // 比较 R0 和 R2</span><br><span class="line">    a = 80        // 如果不相等，将 a 设置为 80</span><br><span class="line">&#125;</span><br><span class="line">a = a &amp; 80      // 执行 a 和 80 的按位与操作</span><br><span class="line">如果 (a != 0) &#123;   // 测试 a 是否为非零</span><br><span class="line">    跳转到 标签3 // 如果非零，跳转到 标签3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最重要的加密就在label3里面</p><p>找到密文就可以写解密脚本了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"><span class="type">int</span> s[]=&#123;</span><br><span class="line"><span class="number">0x36D3</span>, <span class="number">0x2AFF</span>, <span class="number">0x2ACB</span>, <span class="number">0x2B95</span>, <span class="number">0x2B95</span>, <span class="number">0x2B95</span>, <span class="number">0x169F</span>, <span class="number">0x186D</span>,</span><br><span class="line"><span class="number">0x18D7</span>, <span class="number">0x1611</span>, <span class="number">0x18D7</span>, <span class="number">0x2B95</span>, <span class="number">0x2C23</span>, <span class="number">0x2CA9</span>, <span class="number">0x1611</span>, <span class="number">0x1611</span>,</span><br><span class="line"><span class="number">0x18D7</span>, <span class="number">0x2AFF</span>, <span class="number">0x1849</span>, <span class="number">0x18FB</span>, <span class="number">0x2ACB</span>, <span class="number">0x2A71</span>, <span class="number">0x1735</span>, <span class="number">0x18D7</span>,</span><br><span class="line"><span class="number">0x1611</span>, <span class="number">0x2ACB</span>, <span class="number">0x15DD</span>, <span class="number">0x18D7</span>, <span class="number">0x2C23</span>, <span class="number">0x169F</span>, <span class="number">0x15DD</span>, <span class="number">0x2B95</span>,</span><br><span class="line"><span class="number">0x169F</span>, <span class="number">0x156B</span>, <span class="number">0x186D</span>, <span class="number">0x2AFF</span>, <span class="number">0x1611</span>, <span class="number">0x1611</span>, <span class="number">0x15DD</span>, <span class="number">0x2AFF</span>,</span><br><span class="line"><span class="number">0x2C23</span>, <span class="number">0x2ACB</span>, <span class="number">0x15DD</span>, <span class="number">0x15DD</span>, <span class="number">0x186D</span>, <span class="number">0x1849</span>, <span class="number">0x2B95</span>, <span class="number">0x156B</span>,</span><br><span class="line"><span class="number">0x1735</span>, <span class="number">0x18FB</span>, <span class="number">0x18FB</span>, <span class="number">0x2A71</span>, <span class="number">0x2AFF</span>, <span class="number">0x1735</span>, <span class="number">0x2C23</span>, <span class="number">0x15DD</span>,</span><br><span class="line"><span class="number">0x18D7</span>, <span class="number">0x2A71</span>, <span class="number">0x18D7</span>, <span class="number">0x18D7</span>, <span class="number">0x2C23</span>, <span class="number">0x2AFF</span>, <span class="number">0x156B</span>, <span class="number">0x2C23</span>,</span><br><span class="line"><span class="number">0x169F</span>, <span class="number">0x35AF</span>, <span class="number">0x2CA9</span>, <span class="number">0x32B5</span>, <span class="number">0x2AFF</span>, <span class="number">0x3039</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> c;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">69</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">c=(((s[i]<span class="number">-102</span>)^<span class="number">116</span>)<span class="number">-99</span>)/<span class="number">110</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//nctf&#123;3e1ce77b70e4cb9941d6800aec022c813d03e70a274ba96c722fed72783dddac&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;VM&quot;&gt;&lt;a href=&quot;#VM&quot; class=&quot;headerlink&quot; title=&quot;VM&quot;&gt;&lt;/a&gt;VM&lt;/h1&gt;&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;一个虚</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ios学习篇(3)-ios常见加密</title>
    <link href="https://straw-233.github.io/2024/07/04/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(3)-ios%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86/"/>
    <id>https://straw-233.github.io/2024/07/04/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(3)-ios%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86/</id>
    <published>2024-07-04T13:34:00.184Z</published>
    <updated>2024-07-04T15:07:02.398Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ios常见加密"><a href="#ios常见加密" class="headerlink" title="ios常见加密"></a>ios常见加密</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​在学习篇(1)中有提及过CCCrypt，最近在学习登录加密算法的时候发现ios的加密大部分都是调用函数库的，现在来总结一下现在遇到的比较多见的加密。</p><h2 id="CC-MD5"><a href="#CC-MD5" class="headerlink" title="CC_MD5"></a>CC_MD5</h2><p>​最简单也是最常用的</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">NSString</span> *)stringWithMD5&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *cStr = [<span class="keyword">self</span> UTF8String];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">    CC_MD5( cStr, strlen(cStr), digest ); <span class="comment">// This is the md5 call</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableString</span> *output = [<span class="built_in">NSMutableString</span> stringWithCapacity:CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i++)</span><br><span class="line">        [output appendFormat:<span class="string">@&quot;%02x&quot;</span>, digest[i]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC-SHA1…"><a href="#CC-SHA1…" class="headerlink" title="CC_SHA1…"></a>CC_SHA1…</h2><p>​与MD5一样也比较多见</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">NSString</span> *)stringWithSha1Encode&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *cstr = [<span class="keyword">self</span> cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithBytes:cstr length:<span class="keyword">self</span>.length];</span><br><span class="line">    <span class="comment">//使用对应的CC_SHA1,CC_SHA256,CC_SHA384,CC_SHA512的长度分别是20,32,48,64</span></span><br><span class="line">    uint8_t digest[CC_SHA1_DIGEST_LENGTH];</span><br><span class="line">    <span class="comment">//使用对应的CC_SHA256,CC_SHA384,CC_SHA512</span></span><br><span class="line">    CC_SHA1(data.bytes, (CC_LONG)data.length, digest);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span>* output = [<span class="built_in">NSMutableString</span> stringWithCapacity:CC_SHA1_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; CC_SHA1_DIGEST_LENGTH; i++)</span><br><span class="line">        [output appendFormat:<span class="string">@&quot;%02x&quot;</span>, digest[i]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​两个加密所用到的参数也只有三个，原文，原文长度，密文，非常的好认</p><h2 id="CCCrypt"><a href="#CCCrypt" class="headerlink" title="CCCrypt"></a>CCCrypt</h2><p>​这个就比较难了，包含了许多分组对称加密</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CCCryptorStatus CCCrypt(</span><br><span class="line">    CCOperation op,         <span class="comment">/* kCCEncrypt, etc. */</span></span><br><span class="line">    CCAlgorithm alg,        <span class="comment">/* kCCAlgorithmAES128, etc. */</span></span><br><span class="line">    CCOptions options,      <span class="comment">/* kCCOptionPKCS7Padding, etc. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">void</span> *key,</span><br><span class="line">    size_t keyLength,</span><br><span class="line">    <span class="keyword">const</span> <span class="type">void</span> *iv,         <span class="comment">/* optional initialization vector */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">void</span> *dataIn,     <span class="comment">/* optional per op and alg */</span></span><br><span class="line">    size_t dataInLength,</span><br><span class="line">    <span class="type">void</span> *dataOut,          <span class="comment">/* data RETURNED here */</span></span><br><span class="line">    size_t dataOutAvailable,</span><br><span class="line">    size_t *dataOutMoved)</span><br></pre></td></tr></table></figure><h3 id="CCOperation-op"><a href="#CCOperation-op" class="headerlink" title="CCOperation op"></a>CCOperation op</h3><p>​很简单，加密kCCEncrypt，解密kCCDecrypt</p><h3 id="CCAlgorithm-alg"><a href="#CCAlgorithm-alg" class="headerlink" title="CCAlgorithm alg"></a>CCAlgorithm alg</h3><p>​选择加密算法</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kCCAlgorithmAES128 = <span class="number">0</span>,</span><br><span class="line">    kCCAlgorithmAES = <span class="number">0</span>,</span><br><span class="line">    kCCAlgorithmDES,</span><br><span class="line">    kCCAlgorithm3DES,       </span><br><span class="line">    kCCAlgorithmCAST,       </span><br><span class="line">    kCCAlgorithmRC4,</span><br><span class="line">    kCCAlgorithmRC2,   </span><br><span class="line">    kCCAlgorithmBlowfish    </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> uint32_t CCAlgorithm;</span><br></pre></td></tr></table></figure><h3 id="CCOptions-options"><a href="#CCOptions-options" class="headerlink" title="CCOptions options"></a>CCOptions options</h3><p>​选择是否填充，默认是CBC模式</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">/* options for block ciphers */</span></span><br><span class="line">    kCCOptionPKCS7Padding   = <span class="number">0x0001</span>,</span><br><span class="line">    kCCOptionECBMode        = <span class="number">0x0002</span></span><br><span class="line">    <span class="comment">/* stream ciphers currently have no options */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> uint32_t CCOptions;</span><br></pre></td></tr></table></figure><h3 id="const-void-key"><a href="#const-void-key" class="headerlink" title="const void *key"></a>const void *key</h3><p>​传入的密钥，经过从cstring utf8转成字节类型</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> keyPtr[kCCKeySizeAES256 + <span class="number">1</span>];<span class="comment">//选择aes256加密，所以key长度应该是kCCKeySizeAES256，32位</span></span><br><span class="line">bzero(keyPtr, <span class="keyword">sizeof</span>(keyPtr));<span class="comment">//清零</span></span><br><span class="line">[key getCString:keyPtr maxLength:<span class="keyword">sizeof</span>(keyPtr) encoding:<span class="built_in">NSUTF8StringEncoding</span>];<span class="comment">//秘钥key转成cString</span></span><br></pre></td></tr></table></figure><p>​需要注意的是如果这里申请的空间不够，加解密会出现问题的，传入的密钥过长，会自动截取，密钥长度不够，自动补全</p><h3 id="size-t-keyLength"><a href="#size-t-keyLength" class="headerlink" title="size_t keyLength"></a>size_t keyLength</h3><p>​这里是真正决定密钥长度的地方，可选列表是下面这些</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kCCKeySizeAES128          = <span class="number">16</span>,</span><br><span class="line">    kCCKeySizeAES192          = <span class="number">24</span>,</span><br><span class="line">    kCCKeySizeAES256          = <span class="number">32</span>,</span><br><span class="line">    kCCKeySizeDES             = <span class="number">8</span>,</span><br><span class="line">    kCCKeySize3DES            = <span class="number">24</span>,</span><br><span class="line">    kCCKeySizeMinCAST         = <span class="number">5</span>,</span><br><span class="line">    kCCKeySizeMaxCAST         = <span class="number">16</span>,</span><br><span class="line">    kCCKeySizeMinRC4          = <span class="number">1</span>,</span><br><span class="line">    kCCKeySizeMaxRC4          = <span class="number">512</span>,</span><br><span class="line">    kCCKeySizeMinRC2          = <span class="number">1</span>,</span><br><span class="line">    kCCKeySizeMaxRC2          = <span class="number">128</span>,</span><br><span class="line">    kCCKeySizeMinBlowfish     = <span class="number">8</span>,</span><br><span class="line">    kCCKeySizeMaxBlowfish     = <span class="number">56</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="const-void-iv"><a href="#const-void-iv" class="headerlink" title="const void *iv"></a>const void *iv</h3><p>​偏移</p><h3 id="const-void-dataIn-size-t-dataInLength"><a href="#const-void-dataIn-size-t-dataInLength" class="headerlink" title="const void *dataIn,size_t dataInLength"></a>const void *dataIn,size_t dataInLength</h3><p>​明文和明文长度</p><h3 id="void-dataOut-size-t-dataOutAvailable-size-t-dataOutMoved"><a href="#void-dataOut-size-t-dataOutAvailable-size-t-dataOutMoved" class="headerlink" title="void *dataOut,size_t dataOutAvailable,size_t *dataOutMoved"></a>void *dataOut,size_t dataOutAvailable,size_t *dataOutMoved</h3><p>​密文，密文块，被写入密文的密文块长度</p><h2 id="SecKeyEncrypt"><a href="#SecKeyEncrypt" class="headerlink" title="SecKeyEncrypt"></a>SecKeyEncrypt</h2><p>​用在RSA加密中会比较多</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecKeyEncrypt(key, kSecPaddingPKCS1,(<span class="keyword">const</span> uint8_t *)[buffer bytes],[buffer length],cipherBuffer,&amp;cipherBufferSize);</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​主要了解了加密函数，以及对应的参数，我们就可以使用frida-trace去跟踪app登录时的调用函数，使用修改frida的handlers脚本，来获取明文密文，来分析加密过程。</p><h2 id="例子-喜某某雅的登录加密算法"><a href="#例子-喜某某雅的登录加密算法" class="headerlink" title="例子-喜某某雅的登录加密算法"></a>例子-喜某某雅的登录加密算法</h2><p>​首先我们使用Charles对手机进行代理抓包，抓取登录时的发包与响应</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(3)-ios%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86/%E6%8A%93%E5%8C%85.png" alt="抓包"></p><p>​然后我们尝试使用修改追踪脚本的方式，查找我们的输入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Auto-generated by Frida. Please modify to match the signature of SecKeyEncrypt.</span></span><br><span class="line"><span class="comment"> * This stub is currently auto-generated from manpages when available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For full API reference, see: https://frida.re/docs/javascript-api/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called synchronously when about to call SecKeyEncrypt.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@this</span> &#123;<span class="type">object</span>&#125; - Object allowing you to store state for use in onLeave.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">log</span> - Call this function with a string to be presented to the user.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">array</span>&#125; <span class="variable">args</span> - Function arguments represented as an array of NativePointer objects.</span></span><br><span class="line"><span class="comment">   * For example use args[0].readUtf8String() if the first argument is a pointer to a C string encoded as UTF-8.</span></span><br><span class="line"><span class="comment">   * It is also possible to modify arguments by assigning a NativePointer object to an element of this array.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">object</span>&#125; <span class="variable">state</span> - Object allowing you to keep state across function calls.</span></span><br><span class="line"><span class="comment">   * Only one JavaScript function will execute at a time, so do not worry about race-conditions.</span></span><br><span class="line"><span class="comment">   * However, do not use this to store function arguments across onEnter/onLeave, but instead</span></span><br><span class="line"><span class="comment">   * use &quot;this&quot; which is an object for keeping state local to an invocation.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onEnter</span>(<span class="params">log, args, state</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt()&#x27;</span>);</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() key:&#x27;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>]));</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() padding:&#x27;</span> + (args[<span class="number">1</span>]).<span class="title function_">toInt32</span>());</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() plainText:&#x27;</span> + (args[<span class="number">2</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() plainTextSize:&#x27;</span> + (args[<span class="number">3</span>]).<span class="title function_">toInt32</span>());</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">args4</span>=args[<span class="number">4</span>];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">args5</span>=args[<span class="number">5</span>];</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called synchronously when about to return from SecKeyEncrypt.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * See onEnter for details.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@this</span> &#123;<span class="type">object</span>&#125; - Object allowing you to access state stored in onEnter.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">log</span> - Call this function with a string to be presented to the user.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">NativePointer</span>&#125; <span class="variable">retval</span> - Return value represented as a NativePointer object.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">object</span>&#125; <span class="variable">state</span> - Object allowing you to keep state across function calls.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onLeave</span>(<span class="params">log, retval, state</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() cipherText:&#x27;</span>+<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args4</span>));</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;SecKeyEncrypt() cipherTextSize:&#x27;</span>+(<span class="variable language_">this</span>.<span class="property">args5</span>).<span class="title function_">readInt</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Auto-generated by Frida. Please modify to match the signature of CC_SHA1.</span></span><br><span class="line"><span class="comment"> * This stub is currently auto-generated from manpages when available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For full API reference, see: https://frida.re/docs/javascript-api/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called synchronously when about to call CC_SHA1.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@this</span> &#123;<span class="type">object</span>&#125; - Object allowing you to store state for use in onLeave.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">log</span> - Call this function with a string to be presented to the user.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">array</span>&#125; <span class="variable">args</span> - Function arguments represented as an array of NativePointer objects.</span></span><br><span class="line"><span class="comment">   * For example use args[0].readUtf8String() if the first argument is a pointer to a C string encoded as UTF-8.</span></span><br><span class="line"><span class="comment">   * It is also possible to modify arguments by assigning a NativePointer object to an element of this array.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">object</span>&#125; <span class="variable">state</span> - Object allowing you to keep state across function calls.</span></span><br><span class="line"><span class="comment">   * Only one JavaScript function will execute at a time, so do not worry about race-conditions.</span></span><br><span class="line"><span class="comment">   * However, do not use this to store function arguments across onEnter/onLeave, but instead</span></span><br><span class="line"><span class="comment">   * use &quot;this&quot; which is an object for keeping state local to an invocation.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onEnter</span>(<span class="params">log, args, state</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;CC_SHA1() onEnter:&#x27;</span> + args[<span class="number">0</span>].<span class="title function_">readCString</span>(args[<span class="number">1</span>].<span class="title function_">toInt32</span>()));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">args2</span> =args[<span class="number">2</span>];</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called synchronously when about to return from CC_SHA1.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * See onEnter for details.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@this</span> &#123;<span class="type">object</span>&#125; - Object allowing you to access state stored in onEnter.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">function</span>&#125; <span class="variable">log</span> - Call this function with a string to be presented to the user.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">NativePointer</span>&#125; <span class="variable">retval</span> - Return value represented as a NativePointer object.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">object</span>&#125; <span class="variable">state</span> - Object allowing you to keep state across function calls.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onLeave</span>(<span class="params">log, retval, state</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;CC_SHA1() onLeave:&#x27;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args2</span>,&#123;<span class="attr">length</span>:<span class="number">20</span>&#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>利用frida-trace -U -i CCCrypt -i CC_MD5 -i  CC_SHA1 -i SecKeyEncrypt -f com.gemd.iting跟踪，登录账号</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(3)-ios%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86/%E9%AA%8C%E8%AF%81.png" alt="验证"></p><p>我们可以轻松看出我们输入的账号（手机号）与密码数据先进行了一次RSA加密，然后再进行了一次SHA1加密，</p><p>然后发现SHA1的明文是好多进行了RSA加密后的数据，包括账号密码，SHA1的返回值就是我们的signature签名，而RSA加密的数据以base64的方式显示出来</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(3)-ios%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86/base64.png" alt="base64"></p><p>（该图为前一次发包，数据不一样，只提供加密逻辑）</p><p>至此我们只要获取RSA的密钥即可破解登录检验的加密算法</p><p><img src="/../img/%E5%B7%B2%E8%80%81%E5%AE%9E.jpg" alt="已老实"></p><p>参考链接：</p><p><a href="https://www.jianshu.com/p/93466b31f675">https://www.jianshu.com/p/93466b31f675</a></p><p><a href="https://www.cnblogs.com/francisblogs/p/7447330.html">iOS常用加密之RSA加密解密 - Francis01 - 博客园 (cnblogs.com)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ios常见加密&quot;&gt;&lt;a href=&quot;#ios常见加密&quot; class=&quot;headerlink&quot; title=&quot;ios常见加密&quot;&gt;&lt;/a&gt;ios常见加密&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>maimaidx导分查分器研究</title>
    <link href="https://straw-233.github.io/2024/06/30/maimaidx%E5%AF%BC%E5%88%86%E6%9F%A5%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/"/>
    <id>https://straw-233.github.io/2024/06/30/maimaidx%E5%AF%BC%E5%88%86%E6%9F%A5%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/</id>
    <published>2024-06-30T07:10:05.866Z</published>
    <updated>2024-06-30T08:31:28.362Z</updated>
    
    <content type="html"><![CDATA[<h1 id="maimaidx导分查分器研究"><a href="#maimaidx导分查分器研究" class="headerlink" title="maimaidx导分查分器研究"></a>maimaidx导分查分器研究</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​原因是一个maimai菜鸡+残疾人，习惯了使用break一键导分，而在突然的某一天break寄了以后，突发奇想，想搞一个本地的break进行自己本地的一键导分一键查分。进行作为一个学逆向的，搞这种web和爬虫的东西从头学起真的很难，为什么我不是web仔？？</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/0.png" alt="0"></p><h2 id="手机下的抓包"><a href="#手机下的抓包" class="headerlink" title="手机下的抓包"></a>手机下的抓包</h2><p>​因为之前有某o的导入抽卡数据的经验，这边尝试用手机上的抓包工具stream进行对maimai官方的网页抓包的，结果直接好像被ban了，可能是微信检测出来了。。。</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/1.png" alt="1"></p><h2 id="windows下的抓包"><a href="#windows下的抓包" class="headerlink" title="windows下的抓包"></a>windows下的抓包</h2><p>​因为在微信中访问网页是用微信自带的浏览器进行访问的，无法进行F12查看源码，所以我们用抓包工具进行抓包，再进行重发包访问。</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/2.png" alt="2"></p><p>最有用的还是这个userid</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/3.png" alt="3"></p><p>用hackbar进行重发包，改个Cookie的数据就可以让网页正常在浏览器中显示了</p><p>然后做一个简单python脚本进行爬虫，将有用的网页的源码dump下来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">session = requests.Session()</span><br><span class="line">url1 = <span class="string">&#x27;https://maimai.wahlap.com/maimai-mobile/record/musicGenre/search/?genre=99&amp;diff=0&#x27;</span></span><br><span class="line">url2 = <span class="string">&#x27;https://maimai.wahlap.com/maimai-mobile/record/musicGenre/search/?genre=99&amp;diff=1&#x27;</span></span><br><span class="line">url3 = <span class="string">&#x27;https://maimai.wahlap.com/maimai-mobile/record/musicGenre/search/?genre=99&amp;diff=2&#x27;</span></span><br><span class="line">url4 = <span class="string">&#x27;https://maimai.wahlap.com/maimai-mobile/record/musicGenre/search/?genre=99&amp;diff=3&#x27;</span></span><br><span class="line">url5 = <span class="string">&#x27;https://maimai.wahlap.com/maimai-mobile/record/musicGenre/search/?genre=99&amp;diff=4&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;maimai.wahlap.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 NetType/WIFI MicroMessenger/7.0.20.1781(0x6700143B) WindowsWechat(0x63090b11) XWEB/8555 Flue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Sec-Fetch-Site&#x27;</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Sec-Fetch-Mode&#x27;</span>: <span class="string">&#x27;navigate&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Sec-Fetch-User&#x27;</span>: <span class="string">&#x27;?1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Sec-Fetch-Dest&#x27;</span>: <span class="string">&#x27;document&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, br&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;_t=053aec723085f36dd132b8af227c0658; userId=2352886346959880;&#x27;</span><span class="comment">#每个人的都不一样</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response_basic = session.get(url=url1, headers=headers)</span><br><span class="line">response_advance = session.get(url=url2, headers=headers)</span><br><span class="line">response_expert = session.get(url=url3, headers=headers)</span><br><span class="line">response_master = session.get(url=url4, headers=headers)</span><br><span class="line">response_rema = session.get(url=url5, headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;登录失败，请重试。&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> response_basic.text:</span><br><span class="line">    <span class="comment"># 打开一个记事本文件并写入响应文本</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_basic.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response_basic.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;basic表已保存&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;登录失败，请重试。未写入basic表。&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;登录失败，请重试。&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> response_advance.text:</span><br><span class="line">    <span class="comment"># 打开一个记事本文件并写入响应文本</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_advance.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response_advance.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;advance表已保存&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;登录失败，请重试。未写入advance表。&quot;</span>)    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;登录失败，请重试。&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> response_expert.text:</span><br><span class="line">    <span class="comment"># 打开一个记事本文件并写入响应文本</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_expert.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response_expert.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;expert表已保存&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;登录失败，请重试。未写入expert表。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;登录失败，请重试。&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> response_master.text:</span><br><span class="line">    <span class="comment"># 打开一个记事本文件并写入响应文本</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_master.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response_master.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;master表已保存&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;登录失败，请重试。未写入master表。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;登录失败，请重试。&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> response_rema.text:</span><br><span class="line">    <span class="comment"># 打开一个记事本文件并写入响应文本</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_rema.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response_rema.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rema表已保存&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;登录失败，请重试。未写入rema表。&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/4.png" alt="4"></p><p>dump下来5个等级的网页源码</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/5.png" alt="5"></p><p>找到要处理的数据，写个脚本用BeautifulSoup抓取有用的数据并处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;info_rema.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    data = file.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用BeautifulSoup解析HTML</span></span><br><span class="line">soup = BeautifulSoup(data, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个函数来提取信息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_music_info</span>(<span class="params">div</span>):</span><br><span class="line">    level = div.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;music_lv_block&#x27;</span>).text.strip()</span><br><span class="line">    name = div.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;music_name_block&#x27;</span>).text.strip()</span><br><span class="line">    score_block = div.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;music_score_block w_112 t_r f_l f_12&#x27;</span>)</span><br><span class="line">    score = score_block.text.strip() <span class="keyword">if</span> score_block <span class="keyword">else</span> <span class="string">&#x27;未进行游玩&#x27;</span></span><br><span class="line">    details_block = div.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;music_score_block w_190 t_r f_l f_12&#x27;</span>)</span><br><span class="line">    details = details_block.text.strip() <span class="keyword">if</span> details_block <span class="keyword">else</span> <span class="string">&#x27;未进行游玩&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">        <span class="string">&#x27;score&#x27;</span>: score,</span><br><span class="line">        <span class="string">&#x27;details&#x27;</span>: details,</span><br><span class="line">        <span class="string">&#x27;level&#x27;</span>: level</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有相关的div</span></span><br><span class="line">divs = soup.find_all(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;w_450 m_15 p_r f_0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取每个div的信息</span></span><br><span class="line">music_info_list = [extract_music_info(div) <span class="keyword">for</span> div <span class="keyword">in</span> divs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印提取的信息</span></span><br><span class="line"><span class="keyword">for</span> info <span class="keyword">in</span> music_info_list:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;歌曲名: <span class="subst">&#123;info[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;等级：<span class="subst">&#123;info[<span class="string">&#x27;level&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;成绩: <span class="subst">&#123;info[<span class="string">&#x27;score&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;分数: <span class="subst">&#123;info[<span class="string">&#x27;details&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/6.png" alt="6"></p><p>效果如图</p><p>其实只要将dump下来的源码直接交给水鱼，他也能导入你的成绩</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html</a></p><p>​研究了一遍微信开发者文档，因为微信自带的浏览器有一个自动网页授权，通过OAuth2.0机制实现的，原理大概是先将用户信息发给maimai官网，然后返回一个暂时的userid，然后再setcookie这个userid进行访问你的账号网页。</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/7.png" alt="7"></p><p>​关键就在于这个动态userid的获取了，如果能通过某种方法能稳定获得这个，那么一键查询所有人的账号分数岂不是易如反掌？然而问了好多人，查了好多资料，还是不知道这个方法是什么。。。</p><h2 id="代理抓包"><a href="#代理抓包" class="headerlink" title="代理抓包"></a>代理抓包</h2><p>​最后还是回归最原始的代理抓包方法。</p><p>​传统的代理的原理大概是:</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/8.png" alt="8"></p><p>​我自己使用charles与手机连接，然后抓取的网页源码</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/9.png" alt="9"></p><p>​当然其他玩家已经有很完善的导入网页了，大家可以去看看<a href="https://maimai.bakapiano.com/">https://maimai.bakapiano.com</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​因为在学ios逆向，首先要学点基础，虽然我也不知道为什么要学这个。。。总而言之，如果能成功搞懂userid的加密解密传输过程，说不定就可以不需要代理，实现一键导入！</p><p><img src="/../img/maimaidx%E5%AF%BC%E5%88%86%E5%99%A8%E7%A0%94%E7%A9%B6/%E7%AC%91.jpg" alt="笑"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;maimaidx导分查分器研究&quot;&gt;&lt;a href=&quot;#maimaidx导分查分器研究&quot; class=&quot;headerlink&quot; title=&quot;maimaidx导分查分器研究&quot;&gt;&lt;/a&gt;maimaidx导分查分器研究&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>分组加密及模式</title>
    <link href="https://straw-233.github.io/2024/05/27/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E6%A8%A1%E5%BC%8F/"/>
    <id>https://straw-233.github.io/2024/05/27/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E6%A8%A1%E5%BC%8F/</id>
    <published>2024-05-27T13:38:45.253Z</published>
    <updated>2024-05-27T13:43:29.284Z</updated>
    
    <content type="html"><![CDATA[<h1 id="分组加密及模式"><a href="#分组加密及模式" class="headerlink" title="分组加密及模式"></a>分组加密及模式</h1><p>最近感觉做了很多分组加密的题，每次解密的模式都是赛博厨子一个一个试过来的，逻辑啥的也有点不理解，在比赛里最头疼的就是这种比较难的加密了，主要不知道为什么错，想一步一步分析步骤，又很难看，最终还是得归总一下。</p><p><img src="/../img/%E9%BE%9F%E9%BE%9F.gif" alt="龟龟"></p><h2 id="常见分组加密"><a href="#常见分组加密" class="headerlink" title="常见分组加密"></a>常见分组加密</h2><p>AES,DES,blowfish,sm4……(比赛里现在只遇到这些，以后遇到了会继续补充)</p><h2 id="KEY"><a href="#KEY" class="headerlink" title="KEY"></a>KEY</h2><p>密钥是加密中最关键的一个东西，也是解密中不可获取的东西，以下为各种分组加密的表：</p><table><thead><tr><th>加密方式</th><th>AES</th><th>DES</th><th>Blowfish</th><th>SM4</th></tr></thead><tbody><tr><td>密钥长度(位&#x3D;8bits)</td><td>16&#x2F;24&#x2F;32</td><td>8</td><td>4—56</td><td>16</td></tr><tr><td>重复次数</td><td>10&#x2F;12&#x2F;14</td><td>16</td><td>16</td><td>32</td></tr><tr><td>分组长度(位)</td><td>16</td><td>8</td><td>8</td><td>16</td></tr></tbody></table><p>牢记这些能有效帮助我们判断或者是确认加密类型。</p><h2 id="IV"><a href="#IV" class="headerlink" title="IV"></a>IV</h2><p>IV（Initialization Vector）是许多任务作模式中用于将加密随机化的一个位块，由此即使同样的明文被多次加密也会产生不同的密文，避免了较慢的重新产生密钥的过程。是区别ECB模式和CBC模式的关键。<strong>IV的长度一般和分组长度相同。</strong></p><h2 id="ECB模式"><a href="#ECB模式" class="headerlink" title="ECB模式"></a>ECB模式</h2><p>最简单的加密模式即为电子密码本（Electronic codebook，ECB）模式。需要加密的消息按照块密码的块大小被分为数个块，并对每个块进行独立加密。</p><p>在这种工作模式下，一个明文组只能固定地被加密成一个对应的密文组，一个密文组也只能固定地被解密成对应的密文组。他们彼此是一一对应的。设想我们有一个厚厚的密码本，每次加密时，我们只需要从密码本中查出明文所对应的密文就可以。这也是电码本模式名称的由来。对于短消息，ECB模式是比较适用的。但对于长消息，ECB模式就不太安全了。</p><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/ecb%E6%A8%A1%E5%BC%8F.png" alt="ecb模式"></p><p>最简单的EBC模式，解密只需找密文密钥。</p><h2 id="CBC模式"><a href="#CBC模式" class="headerlink" title="CBC模式"></a>CBC模式</h2><p>密码分组链接（CBC，Cipher-block chaining）模式。在CBC模式中，每个明文块先与前一个密文块进行异或后，再进行加密。在这种方法中，每个密文块都依赖于它前面的所有明文块。同时，为了保证每条消息的唯一性，在第一个块中需要使用初始化向量iv。</p><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/cbc%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="cbc加解密"></p><p>其实是EBC模式的异或升级版，开局的异或交给了初始化向量，所以一般iv的长度跟分组长度相同。</p><p><strong>加密是先异或再加密，解密是先异或再解密。</strong></p><p>解密的话需要知道密文密钥还有iv。</p><h2 id="Padding"><a href="#Padding" class="headerlink" title="Padding"></a>Padding</h2><p>有的模式，经典的AES-CBC，AES-ECB（经常被填充搞红温过），支持对非128比特整的数据进行加密，有的模式不支持。填充是用各种可以恢复的方法把数据流填充为128bits&#x3D;16位。</p><h2 id="CFB模式"><a href="#CFB模式" class="headerlink" title="CFB模式"></a>CFB模式</h2><p>密文反馈(CFB,Cipher feedback)模式类似于CBC,可以将块密码变为自同步的流密码，这个模式可以对非128比特的数据进行加密。</p><p>在CFB模式中，加密的基本过程如下：</p><ul><li>初始向量（IV）被加密，生成一个伪随机的分组输出。</li><li>这个输出与明文的一部分（可以是一个比特，也可以是多个比特）进行异或运算，生成密文。</li><li>生成的密文部分作为下一个分组的输入新IV，继续进行加密。</li></ul><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/cfb%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="cfb加解密"></p><p>CFB模式的结构和一次性密码本非常相似。一次性密码本是通过“明文”与“随机比特序列”进行XOR运算来生成“密文”的。而CFB模式则是通过将“明文分组”与“密码算法的输出”进行XOR运算来生成“密文分组”的。在通过 XOR来进行加密这一点上，两者是非常相似的。</p><p><strong>CFB模式中由密码算法所生成的比特序列称为密钥流。在CFB模式中，密码算法相对于用来生成密钥流的伪随机数生成器，而初始化向量相当于伪随机数生成器的“种子”。</strong></p><p>在CFB模式中，明文数据可以被逐比特加密，因此可以将CFB模式看作是一种使用分组密码来实现流密码的方式。</p><h2 id="OFB模式"><a href="#OFB模式" class="headerlink" title="OFB模式"></a>OFB模式</h2><p>OFB模式是先用块加密器生成密钥流，然后将密钥流和明文流异或得到密文流，解密过程是重新异或一次。</p><p><strong>可以一次计算出所有的密钥流，每次加解密只需要做异或操作。</strong></p><p>这个就相对简单。</p><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/ofb%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="ofb加解密"></p><h2 id="CTR模式"><a href="#CTR模式" class="headerlink" title="CTR模式"></a>CTR模式</h2><p>CTR模式是使用随机数等方式产生一个IV，经过计数器累加+1后拼接成一个串，对这个串进行加密，然后和明文做异或操作。</p><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/ctr%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="ctr加解密"></p><p><strong>一般这个随机数产生的iv会放在加密后密文的最前面16位单独成一个组，或者是告诉你随机数的值，不然解密的话根本无法解密。</strong></p><h2 id="GCM模式"><a href="#GCM模式" class="headerlink" title="GCM模式"></a>GCM模式</h2><p>GCM是<a href="https://link.juejin.cn/?target=https://zh.wikipedia.org/zh-cn/%E8%AE%A4%E8%AF%81%E5%8A%A0%E5%AF%86">认证加密</a>模式中的一种，一般只在AES中见到，它结合了两者的特点(GCM中的G就是指GMAC，C就是指CTR)，能同时确保数据的保密性、完整性及真实性，另外，它还可以提供附加消息的完整性校验，加密流程如下图:</p><p><img src="/../img/%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86%E5%8F%8A%E6%A8%A1%E5%BC%8F/GCM%E5%8A%A0%E5%AF%86.png" alt="GCM加密"></p><p>GCM可以提供对消息的加密和完整性校验，另外，它还可以提供附加消息的完整性校验。在实际应用场景中，有些信息是我们不需要保密，但信息的接收者需要确认它的真实性的，例如源IP，源端口，目的IP，IV，等等。因此，我们可以将这一部分作为附加消息加入到MAC值的计算当中。下图的Ek表示用对称秘钥k对输入做AES运算。最后，密文接收者会收到密文、IV（计数器CTR的初始值）、MAC值。</p><p>主要参考：</p><p><a href="https://a-little-cat.github.io/2017/12/14/SM4.html">https://a-little-cat.github.io/2017/12/14/SM4.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;分组加密及模式&quot;&gt;&lt;a href=&quot;#分组加密及模式&quot; class=&quot;headerlink&quot; title=&quot;分组加密及模式&quot;&gt;&lt;/a&gt;分组加密及模式&lt;/h1&gt;&lt;p&gt;最近感觉做了很多分组加密的题，每次解密的模式都是赛博厨子一个一个试过来的，逻辑啥的也有点不理解，在比</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>2024CISCN初赛 Reverse复现</title>
    <link href="https://straw-233.github.io/2024/05/27/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9B/"/>
    <id>https://straw-233.github.io/2024/05/27/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9B/</id>
    <published>2024-05-27T05:11:52.350Z</published>
    <updated>2024-05-27T05:18:32.895Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2024CISCN初赛-Reverse"><a href="#2024CISCN初赛-Reverse" class="headerlink" title="2024CISCN初赛 Reverse"></a>2024CISCN初赛 Reverse</h1><p>最近太忙了，终于等pycc搞完，有点时间，进行赛后复现一下</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526160836214.png" alt="image-20240526160836214"></p><p>可惜了差道Goreverse，还需再练练，除了安卓其他题都出的挺好的</p><h2 id="asm-re"><a href="#asm-re" class="headerlink" title="asm_re"></a>asm_re</h2><p>汇编看得太慢了，不太熟练，直接取巧提取一下放ida里解析了</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240425201336487.png" alt="image-20240425201336487"></p><p>一个简单的*+^操作，当时还奇怪为什么是int类型的密文，现在知道了，第一天的签到</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">int</span> pw[<span class="number">38</span>]=&#123;<span class="number">0x00001FD7</span>, <span class="number">0x000021B7</span>, <span class="number">0x00001E47</span>, <span class="number">0x00002027</span>, <span class="number">0x000026E7</span>, <span class="number">0x000010D7</span>, <span class="number">0x00001127</span>, <span class="number">0x00002007</span>, </span><br><span class="line"><span class="number">0x000011C7</span>, <span class="number">0x00001E47</span>, <span class="number">0x00001017</span>, <span class="number">0x00001017</span>, <span class="number">0x000011F7</span>, <span class="number">0x00002007</span>, <span class="number">0x00001037</span>, <span class="number">0x00001107</span>, </span><br><span class="line"><span class="number">0x00001F17</span>, <span class="number">0x000010D7</span>, <span class="number">0x00001017</span>, <span class="number">0x00001017</span>, <span class="number">0x00001F67</span>, <span class="number">0x00001017</span>, <span class="number">0x000011C7</span>, <span class="number">0x000011C7</span>, </span><br><span class="line"><span class="number">0x00001017</span>, <span class="number">0x00001FD7</span>, <span class="number">0x00001F17</span>, <span class="number">0x00001107</span>, <span class="number">0x00000F47</span>, <span class="number">0x00001127</span>, <span class="number">0x00001037</span>, <span class="number">0x00001E47</span>, </span><br><span class="line"><span class="number">0x00001037</span>, <span class="number">0x00001FD7</span>, <span class="number">0x00001107</span>, <span class="number">0x00001FD7</span>, <span class="number">0x00001107</span>, <span class="number">0x00002787</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> flag[<span class="number">38</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">38</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">flag[i]=(((pw[i]<span class="number">-30</span>)^<span class="number">0x4D</span>)<span class="number">-20</span>)/<span class="number">80</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,flag[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag&#123;67e9a228e45b622c2992fb5174a4f5f5&#125;</span></span><br></pre></td></tr></table></figure><p>这种跟类型有关的题还是喜欢用c写</p><h2 id="android-so"><a href="#android-so" class="headerlink" title="android_so"></a>android_so</h2><p>哎只允许真机调试，有点出的不好了，对于我这种模拟器玩家很是难做，借了个学长的真机穿。</p><p>java层就一个base+des-CBC，主要iv和key都放在了so层处理。</p><p>key能直接断在返回那边动调出</p><p>iv用个frida hook cypher.init脚本出</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526164235188.png" alt="image-20240526164235188"></p><h2 id="rust-baby"><a href="#rust-baby" class="headerlink" title="rust_baby"></a>rust_baby</h2><p>看代码看得最头疼的一题，</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526164644891.png" alt="image-20240526164644891"></p><p>先写了个列表，然后慢慢从列表中调用</p><p>动调看加密，先是一个补齐，一直补到104位，这里是第一步加密，取8个字节，一个sub_1400028C3，一个异或</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image.png" alt="image"></p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526165504040.png" alt="image-20240526165504040"></p><p>进去看不懂，但是根据输入输出进行大概猜测就知道是-1，0，+1，+2操作</p><p>后面进行16个字节分组，下一步加密是在这里，异或v96的表，这个表每次循环都会换一下，但是直接动调取就行</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526170136833.png" alt="image-20240526170136833"></p><p>一直到比较段，都没咋动，下面一大串都没啥用</p><p><a href="../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526165822823.png">image-20240526165822823</a></p><p>然后写个脚本出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pw = [<span class="number">0x8a</span>,<span class="number">0x07</span>,<span class="number">0x72</span>,<span class="number">0x76</span>,<span class="number">0x8d</span>,<span class="number">0x7d</span>,<span class="number">0x4d</span>,<span class="number">0x51</span>,<span class="number">0x35</span>,<span class="number">0xde</span>,<span class="number">0x88</span>,<span class="number">0x16</span>,<span class="number">0xd4</span>,<span class="number">0x04</span>,<span class="number">0xf9</span>,<span class="number">0x0e</span>,<span class="number">0x08</span>,<span class="number">0xcf</span>,<span class="number">0xcc</span>,<span class="number">0x7c</span>,<span class="number">0x0f</span>,<span class="number">0x0d</span>,<span class="number">0x09</span>,<span class="number">0x5e</span>,<span class="number">0xd5</span>,<span class="number">0x7e</span>,<span class="number">0xe4</span>,<span class="number">0x4b</span>,<span class="number">0xc4</span>,<span class="number">0xf3</span>,<span class="number">0x1c</span>,<span class="number">0xaf</span>,<span class="number">0x12</span>,<span class="number">0xe4</span>,<span class="number">0xa0</span>,<span class="number">0xae</span>,<span class="number">0xf6</span>,<span class="number">0x69</span>,<span class="number">0xc9</span>,<span class="number">0xd2</span>,<span class="number">0xe0</span>,<span class="number">0xa7</span>,<span class="number">0x01</span>,<span class="number">0x0e</span>,<span class="number">0x1a</span>,<span class="number">0x57</span>,<span class="number">0x70</span>,<span class="number">0x92</span>,<span class="number">0x61</span>,<span class="number">0x49</span>,<span class="number">0x7a</span>,<span class="number">0x43</span>,<span class="number">0x27</span>,<span class="number">0x29</span>,<span class="number">0x89</span>,<span class="number">0xb5</span>,<span class="number">0x92</span>,<span class="number">0x2e</span>,<span class="number">0x6a</span>,<span class="number">0xa6</span>,<span class="number">0xdb</span>,<span class="number">0x2f</span>,<span class="number">0xc6</span>,<span class="number">0xa9</span>,<span class="number">0x6e</span>,<span class="number">0x8f</span>,<span class="number">0x34</span>,<span class="number">0x90</span>,<span class="number">0x59</span>,<span class="number">0xfc</span>,<span class="number">0x2d</span>,<span class="number">0x91</span>,<span class="number">0x66</span>,<span class="number">0xeb</span>,<span class="number">0xbe</span>,<span class="number">0x0d</span>,<span class="number">0xf4</span>,<span class="number">0x05</span>,<span class="number">0x0b</span>,<span class="number">0x1b</span>,<span class="number">0xcb</span>,<span class="number">0x18</span>,<span class="number">0x74</span>,<span class="number">0xf9</span>,<span class="number">0x82</span>,<span class="number">0x81</span>,<span class="number">0xbc</span>,<span class="number">0x04</span>,<span class="number">0xd9</span>,<span class="number">0x75</span>,<span class="number">0x8e</span>,<span class="number">0x2d</span>,<span class="number">0x97</span>,<span class="number">0x07</span>,<span class="number">0x7c</span>,<span class="number">0x7d</span>,<span class="number">0x18</span>,<span class="number">0xc8</span>,<span class="number">0x3d</span>,<span class="number">0x4f</span>,<span class="number">0xc0</span>,<span class="number">0xa5</span>,<span class="number">0x6a</span>,<span class="number">0xd7</span>]</span><br><span class="line">key = [<span class="number">0xDC</span>,<span class="number">0x5F</span>,<span class="number">0x20</span>,<span class="number">0x22</span>,<span class="number">0xC2</span>,<span class="number">0x79</span>,<span class="number">0x19</span>,<span class="number">0x56</span>,<span class="number">0x35</span>,<span class="number">0xDA</span>,<span class="number">0x8B</span>,<span class="number">0x47</span>,<span class="number">0xD3</span>,<span class="number">0x19</span>,<span class="number">0xFC</span>,<span class="number">0x55</span>,<span class="number">0x14</span>,<span class="number">0xCD</span>,<span class="number">0xD2</span>,<span class="number">0x7B</span>,<span class="number">0x58</span>,<span class="number">0x59</span>,<span class="number">0x09</span>,<span class="number">0x42</span>,<span class="number">0xDE</span>,<span class="number">0x2C</span>,<span class="number">0xB4</span>,<span class="number">0x48</span>,<span class="number">0xD9</span>,<span class="number">0xF2</span>,<span class="number">0x1B</span>,<span class="number">0xA9</span>,<span class="number">0x40</span>,<span class="number">0xE1</span>,<span class="number">0xA6</span>,<span class="number">0xFB</span>,<span class="number">0xFF</span>,<span class="number">0x38</span>,<span class="number">0xC1</span>,<span class="number">0xD5</span>,<span class="number">0xE2</span>,<span class="number">0xE8</span>,<span class="number">0x77</span>,<span class="number">0x78</span>,<span class="number">0x6F</span>,<span class="number">0x22</span>,<span class="number">0x04</span>,<span class="number">0xE6</span>,<span class="number">0x16</span>,<span class="number">0x3E</span>,<span class="number">0x0C</span>,<span class="number">0x35</span>,<span class="number">0x52</span>,<span class="number">0x5C</span>,<span class="number">0xFD</span>,<span class="number">0xC1</span>,<span class="number">0xE5</span>,<span class="number">0x59</span>,<span class="number">0x1C</span>,<span class="number">0xD0</span>,<span class="number">0xAE</span>,<span class="number">0x5A</span>,<span class="number">0xB2</span>,<span class="number">0xDD</span>,<span class="number">0x19</span>,<span class="number">0xF8</span>,<span class="number">0x42</span>,<span class="number">0xE6</span>,<span class="number">0x2C</span>,<span class="number">0x89</span>,<span class="number">0x59</span>,<span class="number">0xE5</span>,<span class="number">0x11</span>,<span class="number">0x9C</span>,<span class="number">0xC8</span>,<span class="number">0x7B</span>,<span class="number">0x81</span>,<span class="number">0x70</span>,<span class="number">0x7F</span>,<span class="number">0x6F</span>,<span class="number">0xBC</span>,<span class="number">0x6F</span>,<span class="number">0x02</span>,<span class="number">0x8F</span>,<span class="number">0xF7</span>,<span class="number">0xF4</span>,<span class="number">0xC8</span>,<span class="number">0x70</span>,<span class="number">0xAE</span>,<span class="number">0x02</span>,<span class="number">0xF8</span>,<span class="number">0x5B</span>,<span class="number">0xE2</span>,<span class="number">0x72</span>,<span class="number">0x08</span>,<span class="number">0x09</span>,<span class="number">0x6F</span>,<span class="number">0xBF</span>,<span class="number">0x4B</span>,<span class="number">0x39</span>,<span class="number">0xB5</span>,<span class="number">0xD0</span>,<span class="number">0x1E</span>,<span class="number">0xA3</span>,<span class="number">0x23</span>,<span class="number">0xAB</span>,<span class="number">0x9B</span>,<span class="number">0x43</span>,<span class="number">0xB1</span>,<span class="number">0x15</span>,<span class="number">0xD7</span>,<span class="number">0xBE</span>,]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pw)):</span><br><span class="line">    pw[i] ^= key[i]</span><br><span class="line">    pw[i] ^= <span class="number">0x33</span></span><br><span class="line">    <span class="keyword">if</span> (((i%<span class="number">8</span>)//<span class="number">2</span>)==<span class="number">0</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(pw[i]+<span class="number">1</span>),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (((i%<span class="number">8</span>)//<span class="number">2</span>)==<span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(pw[i]),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (((i%<span class="number">8</span>)//<span class="number">2</span>)==<span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(pw[i]-<span class="number">1</span>),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(pw[i]-<span class="number">2</span>),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">//flag&#123;6e2480b3-4f02-4cf1-9bc0-123b75f9a922&#125;</span><br></pre></td></tr></table></figure><h2 id="whereThe1b"><a href="#whereThe1b" class="headerlink" title="whereThe1b"></a>whereThe1b</h2><p>一个python写的lib，base32，各种随机数异或调用啥的，看了一会不想看了，发现是分组加密，三位对应四位，而且是可见字符，直接放在虚拟机(因为好像只有linux能调用cpython)里爆破了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> whereThel1b</span><br><span class="line"></span><br><span class="line">encry = [<span class="number">108</span>, <span class="number">117</span>, <span class="number">72</span>, <span class="number">80</span>, <span class="number">64</span>, <span class="number">49</span>, <span class="number">99</span>, <span class="number">19</span>, <span class="number">69</span>, <span class="number">115</span>, <span class="number">94</span>, <span class="number">93</span>, <span class="number">94</span>, <span class="number">115</span>, <span class="number">71</span>, <span class="number">95</span>, <span class="number">84</span>, <span class="number">89</span>, <span class="number">56</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">2</span>, <span class="number">84</span>, <span class="number">75</span>, <span class="number">127</span>, <span class="number">68</span>, <span class="number">103</span>, <span class="number">85</span>, <span class="number">105</span>, <span class="number">113</span>, <span class="number">80</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">67</span>, <span class="number">81</span>, <span class="number">7</span>, <span class="number">113</span>, <span class="number">70</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">92</span>, <span class="number">124</span>, <span class="number">93</span>, <span class="number">120</span>, <span class="number">104</span>, <span class="number">108</span>, <span class="number">106</span>, <span class="number">17</span>, <span class="number">80</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">75</span>, <span class="number">93</span>, <span class="number">68</span>, <span class="number">121</span>, <span class="number">26</span>]</span><br><span class="line">flag = <span class="string">&quot;&#123;&#125;&#123;&#125;&#123;&#125;&quot;</span></span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">                flag=<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(i)&#125;</span><span class="subst">&#123;<span class="built_in">chr</span>(j)&#125;</span><span class="subst">&#123;<span class="built_in">chr</span>(k)&#125;</span>&#x27;</span>*<span class="number">14</span></span><br><span class="line">                flag = flag.encode()</span><br><span class="line">                ret = whereThel1b.trytry(flag)</span><br><span class="line">                <span class="keyword">if</span> ret[(<span class="number">4</span>*o):(<span class="number">4</span>*o+<span class="number">4</span>)]==encry[(<span class="number">4</span>*o):(<span class="number">4</span>*o+<span class="number">4</span>)]:</span><br><span class="line">                    <span class="built_in">print</span>(flag,end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Goreverse"><a href="#Goreverse" class="headerlink" title="Goreverse"></a>Goreverse</h2><p>思路超级清晰，就是加密嵌套太多层了，只要一出错就得还原重新看，sm4那里就是死活出不来，最后才知道是iv搞错了，真无语了，这题调试还是一坨，调一步卡一步，有两个反调试。最后看vidar-team的wp复现的。</p><p>先用go脚本还原一下大部分符号名</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526171458703.png" alt="image-20240526171458703"></p><p>main函数一个反调试，直接把exit()nop掉就行，继续运行到</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526191855425.png" alt="image-20240526191855425"></p><p>很明显一个open了一个flag文件读入，然后进行以下几个操作，逐步分析</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240526192238258.png" alt="image-20240526192238258"></p><p>大概就是这样，找到aes的key和iv，然后找到sm4的key和iv，还原xxtea算法和找到xxtea的key，找到异或表，就可以穿了。。。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> table[]=<span class="string">&quot;D7BJLsOk9@f&amp;1dWIn53IDlJqUS6$^WhkAk2kk*2GaqmLwiLX^bGGE$&amp;dmqR^g5bL3&quot;</span>;</span><br><span class="line"><span class="type">char</span> keyxxtea[]=<span class="string">&quot;Bs^8*wZ4lu8oR&amp;@k&quot;</span>;</span><br><span class="line"><span class="type">char</span> keySm4[]=<span class="string">&quot;pg5g#k6Qo3L&amp;1EzT&quot;</span>;</span><br><span class="line"><span class="type">char</span> keyaes[]=<span class="string">&quot;dPGWgcLpqmxw3uOXhKpKV009Cql@@XE6&quot;</span>;</span><br><span class="line"><span class="type">char</span> ivaes[]=<span class="string">&quot;dPGWgcLpqmxw3uOX&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240527124436315.png" alt="image-20240527124436315"></p><p>输出的前16个字节是sm4的iv，后面的都是sm4的密文，因为进行加密的iv是随机数，只能通过这个方法判断</p><p><img src="/../img/2024CISCN%E5%88%9D%E8%B5%9B/image-20240527124758410.png" alt="image-20240527124758410"></p><p>最后再进行一步xxtea解密和异或表</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delta 0x7FAB4CAD</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> v[<span class="number">20</span>] = &#123;<span class="number">0xa17bd6ac</span>,<span class="number">0x5ec21b5e</span>,<span class="number">0xa42f58b2</span>,<span class="number">0x1f8dcfae</span>,<span class="number">0x17e7d4bb</span>,<span class="number">0x8bb7be13</span>,<span class="number">0xf335137e</span>,<span class="number">0x24eedf2f</span>,<span class="number">0xf57f3e58</span>,<span class="number">0xe246395a</span>,<span class="number">0x1c4f3291</span>&#125;;<span class="comment">//可改</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> key[<span class="number">4</span>] = &#123;<span class="number">0x385E7342</span>, <span class="number">0x345A772A</span>, <span class="number">0x6F38756C</span>, <span class="number">0x6B402652</span>&#125;;<span class="comment">//可改</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> y,z,p,rounds,e;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> table[<span class="number">100</span>]=&#123;<span class="number">0x44</span>, <span class="number">0x37</span>, <span class="number">0x42</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x73</span>, <span class="number">0x4F</span>, <span class="number">0x6B</span>, <span class="number">0x39</span>, <span class="number">0x40</span>, <span class="number">0x66</span>, <span class="number">0x26</span>, <span class="number">0x31</span>, <span class="number">0x64</span>, <span class="number">0x57</span>, <span class="number">0x49</span>, </span><br><span class="line"><span class="number">0x6E</span>, <span class="number">0x35</span>, <span class="number">0x33</span>, <span class="number">0x49</span>, <span class="number">0x44</span>, <span class="number">0x6C</span>, <span class="number">0x4A</span>, <span class="number">0x71</span>, <span class="number">0x55</span>, <span class="number">0x53</span>, <span class="number">0x36</span>, <span class="number">0x24</span>, <span class="number">0x5E</span>, <span class="number">0x57</span>, <span class="number">0x68</span>, <span class="number">0x6B</span>, </span><br><span class="line"><span class="number">0x41</span>, <span class="number">0x6B</span>, <span class="number">0x32</span>, <span class="number">0x6B</span>, <span class="number">0x6B</span>, <span class="number">0x2A</span>, <span class="number">0x32</span>, <span class="number">0x47</span>, <span class="number">0x61</span>, <span class="number">0x71</span>, <span class="number">0x6D</span>, <span class="number">0x4C</span>, <span class="number">0x77</span>, <span class="number">0x69</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, </span><br><span class="line"><span class="number">0x5E</span>, <span class="number">0x62</span>, <span class="number">0x47</span>, <span class="number">0x47</span>, <span class="number">0x45</span>, <span class="number">0x24</span>, <span class="number">0x26</span>, <span class="number">0x64</span>, <span class="number">0x6D</span>, <span class="number">0x71</span>, <span class="number">0x52</span>, <span class="number">0x5E</span>, <span class="number">0x67</span>, <span class="number">0x35</span>, <span class="number">0x62</span>, <span class="number">0x4C</span>, </span><br><span class="line"><span class="number">0x33</span>, <span class="number">0x6C</span>, <span class="number">0x43</span>, <span class="number">0x41</span>, <span class="number">0x35</span>, <span class="number">0x5E</span>, <span class="number">0x48</span>, <span class="number">0x47</span>, <span class="number">0x4B</span>, <span class="number">0x24</span>, <span class="number">0x39</span>, <span class="number">0x71</span>, <span class="number">0x6F</span>, <span class="number">0x35</span>, <span class="number">0x54</span>, <span class="number">0x40</span>, </span><br><span class="line"><span class="number">0x42</span>, <span class="number">0x77</span>, <span class="number">0x6F</span>, <span class="number">0x6D</span>, <span class="number">0x39</span>, <span class="number">0x76</span>, <span class="number">0x45</span>, <span class="number">0x58</span>, <span class="number">0x79</span>, <span class="number">0x61</span>, <span class="number">0x30</span>, <span class="number">0x48</span>, <span class="number">0x41</span>, <span class="number">0x56</span>, <span class="number">0x33</span>, <span class="number">0x4C</span>, </span><br><span class="line"><span class="number">0x72</span>, <span class="number">0x57</span>, <span class="number">0x57</span>&#125;;</span><br><span class="line"><span class="type">int</span> n = <span class="number">11</span>;<span class="comment">//v的个数</span></span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">rounds = <span class="number">6</span> + <span class="number">52</span>/n;<span class="comment">//容易魔改</span></span><br><span class="line">y = v[<span class="number">0</span>];</span><br><span class="line">sum = rounds*delta;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">e = sum &gt;&gt; <span class="number">2</span> &amp; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span>(p=n<span class="number">-1</span>;p&gt;<span class="number">0</span>;p--)</span><br><span class="line">&#123;</span><br><span class="line">z = v[p<span class="number">-1</span>];</span><br><span class="line">v[p] -= ((((z&gt;&gt;<span class="number">5</span>)^(y&lt;&lt;<span class="number">2</span>))+((y&gt;&gt;<span class="number">3</span>)^(z&lt;&lt;<span class="number">4</span>))) ^y ^ sum) + (key[(p&amp;<span class="number">3</span>)^e]^z);<span class="comment">//容易魔改</span></span><br><span class="line">y = v[p];</span><br><span class="line">&#125;</span><br><span class="line">z = v[n<span class="number">-1</span>];</span><br><span class="line">v[<span class="number">0</span>] -= ((((z&gt;&gt;<span class="number">5</span>)^(y&lt;&lt;<span class="number">2</span>))+((y&gt;&gt;<span class="number">3</span>)^(z&lt;&lt;<span class="number">4</span>))) ^y ^ sum) + (key[(p&amp;<span class="number">3</span>)^e]^z);<span class="comment">//容易魔改</span></span><br><span class="line">y = v[<span class="number">0</span>];</span><br><span class="line">sum -= delta;</span><br><span class="line">&#125;<span class="keyword">while</span>(--rounds);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,*((<span class="type">char</span>*)&amp;v[i])^table[i*<span class="number">4</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,*((<span class="type">char</span>*)&amp;v[i]+<span class="number">1</span>)^table[i*<span class="number">4</span>+<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,*((<span class="type">char</span>*)&amp;v[i]+<span class="number">2</span>)^table[i*<span class="number">4</span>+<span class="number">2</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,*((<span class="type">char</span>*)&amp;v[i]+<span class="number">3</span>)^table[i*<span class="number">4</span>+<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag&#123;9c2a42ab-b02d-457e-befb-27af6a7fa7bc&#125;</span></span><br></pre></td></tr></table></figure><h2 id="gdb-debug"><a href="#gdb-debug" class="headerlink" title="gdb_debug"></a>gdb_debug</h2><p>固定的种子，一共调用了三次，先把需要用的rand值全部打印出来成为一个表，然后加密就是简单的异或+换表顺序+异或，写个脚本出了，第二天的签到。。。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cstdlib&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cstdio&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;defs.h&quot;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> data2[] = &#123;<span class="number">220</span>, <span class="number">184</span>, <span class="number">64</span>, <span class="number">189</span>, <span class="number">156</span>, <span class="number">201</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">239</span>, <span class="number">18</span>, <span class="number">216</span>, <span class="number">152</span>, <span class="number">105</span>, <span class="number">208</span>, <span class="number">222</span>, <span class="number">252</span>, <span class="number">107</span>, <span class="number">174</span>, <span class="number">125</span>, <span class="number">139</span>, <span class="number">214</span>,</span><br><span class="line">               <span class="number">141</span>, <span class="number">15</span>, <span class="number">208</span>, <span class="number">79</span>, <span class="number">102</span>, <span class="number">62</span>, <span class="number">157</span>, <span class="number">250</span>, <span class="number">195</span>, <span class="number">233</span>, <span class="number">36</span>, <span class="number">211</span>, <span class="number">239</span>, <span class="number">255</span>, <span class="number">157</span>, <span class="number">231</span>, <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> rand_list[]&#123;</span><br><span class="line">        <span class="number">0x1fae43d9</span>, <span class="number">0x14da3e0f</span>, <span class="number">0x29fdc718</span>, <span class="number">0x6b7956bd</span>, <span class="number">0x565247c7</span>, <span class="number">0x118e4e16</span>, <span class="number">0xec41481</span>, <span class="number">0x2853f3be</span>, <span class="number">0x18fe7af8</span>,</span><br><span class="line">        <span class="number">0x637a7d4a</span>, <span class="number">0x4c235f65</span>, <span class="number">0x1a636af2</span>, <span class="number">0xf8e55d</span>, <span class="number">0x3f4562ab</span>, <span class="number">0x910412b</span>, <span class="number">0x57ec233</span>, <span class="number">0x1a9fe4d4</span>, <span class="number">0x321373a5</span>,</span><br><span class="line">        <span class="number">0x5aa40d67</span>, <span class="number">0x7661698</span>, <span class="number">0x7e44749f</span>, <span class="number">0x3c64e7e</span>, <span class="number">0x49be3e2b</span>, <span class="number">0x394c025d</span>, <span class="number">0x6acb9dc2</span>, <span class="number">0x726285af</span>, <span class="number">0x7d6818e</span>,</span><br><span class="line">        <span class="number">0x655c983a</span>, <span class="number">0x7afa9e4c</span>, <span class="number">0x7f7af6a5</span>, <span class="number">0x5b28f175</span>, <span class="number">0x1aa8e225</span>, <span class="number">0x145534b4</span>, <span class="number">0x526b88d</span>, <span class="number">0x62238e3</span>, <span class="number">0x6aa77c7b</span>,</span><br><span class="line">        <span class="number">0x16b506a3</span>, <span class="number">0x14e64d64</span>, <span class="number">0x12fb7039</span>, <span class="number">0x2fb3819c</span>, <span class="number">0x7860caae</span>, <span class="number">0x5f1ecf9e</span>, <span class="number">0x4a16ec8e</span>, <span class="number">0x7959b00b</span>, <span class="number">0x1e64324a</span>,</span><br><span class="line">        <span class="number">0x53272db9</span>, <span class="number">0x7ed8723f</span>, <span class="number">0x3904171e</span>, <span class="number">0x53aa15e</span>, <span class="number">0x597c7fa6</span>, <span class="number">0x406a2db6</span>, <span class="number">0x37f15fd</span>, <span class="number">0x5d42ce25</span>, <span class="number">0xa286be1</span>,</span><br><span class="line">        <span class="number">0x3ccb185a</span>, <span class="number">0x480e6be7</span>, <span class="number">0x7c8af191</span>, <span class="number">0x44a199e8</span>, <span class="number">0x2d6b0421</span>, <span class="number">0x77858fdd</span>, <span class="number">0x441c908d</span>, <span class="number">0x893f596</span>, <span class="number">0x122e7202</span>,</span><br><span class="line">        <span class="number">0x5871c541</span>, <span class="number">0xdbaae23</span>, <span class="number">0x1850aae5</span>, <span class="number">0x431941bc</span>, <span class="number">0x246fb4c7</span>, <span class="number">0x2d36f849</span>, <span class="number">0x5614b1f5</span>, <span class="number">0x54233663</span>, <span class="number">0x2597c2f7</span>,</span><br><span class="line">        <span class="number">0x35338194</span>, <span class="number">0x1e3a22f1</span>, <span class="number">0x1ef17303</span>, <span class="number">0x5397b3de</span>, <span class="number">0x716150aa</span>, <span class="number">0x1dc9e542</span>, <span class="number">0xc9bcafc</span>, <span class="number">0x769bf209</span>, <span class="number">0x774664e8</span>,</span><br><span class="line">        <span class="number">0x4d05f8b2</span>, <span class="number">0x7a1b0806</span>, <span class="number">0x5489330d</span>, <span class="number">0x572e6493</span>, <span class="number">0x36e62061</span>, <span class="number">0x1c979ef4</span>, <span class="number">0x53b95624</span>, <span class="number">0x7b87ba49</span>, <span class="number">0x4a02a315</span>,</span><br><span class="line">        <span class="number">0x4b3ee601</span>, <span class="number">0x3fa44ad7</span>, <span class="number">0x529698ab</span>, <span class="number">0x5d6d5804</span>, <span class="number">0x18161018</span>, <span class="number">0x605146cf</span>, <span class="number">0x75be02e9</span>, <span class="number">0x5b2f51d5</span>, <span class="number">0x4c0fb96</span>,</span><br><span class="line">        <span class="number">0x22f4fb33</span>, <span class="number">0x314403ca</span>, <span class="number">0x58e431f9</span>, <span class="number">0x488cbe2a</span>, <span class="number">0x6677855e</span>, <span class="number">0x771e54ea</span>, <span class="number">0x677e312d</span>, <span class="number">0x3a0f393c</span>, <span class="number">0x687fa594</span>,</span><br><span class="line">        <span class="number">0x548166f</span>, <span class="number">0x46ab0438</span>, <span class="number">0x5f1b979d</span>, <span class="number">0x7c8e7b58</span>, <span class="number">0x13b0fcea</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> unsi[<span class="number">40</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    srand(<span class="number">1610612736</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; ++i) &#123;</span><br><span class="line">        data2[i] ^= rand_list[<span class="number">38</span> + <span class="number">37</span> + i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *ptr = <span class="built_in">malloc</span>(<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; ++i) ((_BYTE *) ptr)[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">38</span> - <span class="number">1</span>; k; --k) &#123;</span><br><span class="line">        <span class="type">int</span> v18 = rand_list[<span class="number">38</span> + <span class="number">37</span> - k] % (k + <span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> v19 = *((_BYTE *) ptr + k);</span><br><span class="line">        *((_BYTE *) ptr + k) = *((_BYTE *) ptr + v18);</span><br><span class="line">        *((_BYTE *) ptr + v18) = v19;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">40</span>; ++i) &#123;</span><br><span class="line">        _BYTE current = data2[i];</span><br><span class="line">        unsi[((_BYTE *) ptr)[i]] = current;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; ++i) &#123;</span><br><span class="line">        unsi[i] ^= rand_list[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, unsi[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2024CISCN初赛-Reverse&quot;&gt;&lt;a href=&quot;#2024CISCN初赛-Reverse&quot; class=&quot;headerlink&quot; title=&quot;2024CISCN初赛 Reverse&quot;&gt;&lt;/a&gt;2024CISCN初赛 Reverse&lt;/h1&gt;&lt;p&gt;最近</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ios学习篇(2)</title>
    <link href="https://straw-233.github.io/2024/04/18/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/"/>
    <id>https://straw-233.github.io/2024/04/18/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/</id>
    <published>2024-04-18T13:46:25.520Z</published>
    <updated>2024-04-18T13:59:15.265Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ios学习篇-2"><a href="#ios学习篇-2" class="headerlink" title="ios学习篇(2)"></a>ios学习篇(2)</h1><h2 id="ipa文件结构"><a href="#ipa文件结构" class="headerlink" title="ipa文件结构"></a>ipa文件结构</h2><p>​ipa以压缩包的形式打开后进入payload中会有很多的文件存在，我们如何进行有效的辨别每个文件是什么，以快速找到对于逆向最有用二进制文件呢，先从ipa的结构入手。</p><p>​本文章将以一个开源的社交app为例子进行简单介绍</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/1.png" alt="1"></p><h3 id="Info-plist"><a href="#Info-plist" class="headerlink" title="Info.plist"></a>Info.plist</h3><p>​Info.plist是一个应用的相关配置文件（类似于android的AndroidManifest.xml）</p><p>​可以用plist Editor来查看大致的相关配置信息，当然用vscode看也行不过比较难看</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/2.png" alt="2"></p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/3.png" alt="3"></p><p>​后面还涉及一些权限啥的配置，不展开细讲</p><h3 id="CodeSignature"><a href="#CodeSignature" class="headerlink" title="_CodeSignature"></a>_CodeSignature</h3><ul><li>ipa包签名文件的存放文件夹</li></ul><h3 id="Iproj"><a href="#Iproj" class="headerlink" title=".Iproj"></a>.Iproj</h3><ul><li>App所支持的语言文件</li></ul><h3 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h3><ul><li>插件</li></ul><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/4.png" alt="4"></p><p>​每个插件里的结构也类似</p><h3 id="Frameworks"><a href="#Frameworks" class="headerlink" title="Frameworks"></a>Frameworks</h3><ul><li><p>当前应用使用的三方 Framework 或 Swift 动态库</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/5.png" alt="5"></p></li></ul><h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><ul><li>资源文件</li></ul><h3 id="Assets-car"><a href="#Assets-car" class="headerlink" title="Assets.car"></a>Assets.car</h3><ul><li>Assets.xcassts在编译过程中生成的最终展示文件，默认里面存放各种分辨率图片</li></ul><h3 id="bundle"><a href="#bundle" class="headerlink" title=".bundle"></a>.bundle</h3><ul><li>调用一些其他的资源项目包</li></ul><p>该文件多的话，会非常难逆</p><h3 id="mach-o"><a href="#mach-o" class="headerlink" title="mach-o"></a>mach-o</h3><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(2)/6.png" alt="6"></p><p>根据Info.plist里找，这就是就是我们需要进行逆向的文件</p><h3 id="nib"><a href="#nib" class="headerlink" title=".nib"></a>.nib</h3><p>.nib 文件是二进制的 plist 文件，其中保存了应用程序中 GUI 组件的位置信息和设置信息。这些文件是通过 Xcode 的 Interface Builder 创建的。Interface Builder 编辑.xib 文件的文本版本，然后再将这些文件打包成二进制格式。</p><h3 id="storyboardc"><a href="#storyboardc" class="headerlink" title=".storyboardc"></a>.storyboardc</h3><ul><li>模块化UI文件</li></ul><h3 id="其他资源文件"><a href="#其他资源文件" class="headerlink" title="其他资源文件"></a>其他资源文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.xml、.json</span><br><span class="line">.plist：项目中使用资源的.plist文件</span><br><span class="line">.conf：相关的配置文件</span><br><span class="line">.cer、.der、.p12：钥匙串文件</span><br><span class="line">.wav：音频文件</span><br><span class="line">.js、.html</span><br><span class="line">.nib：Xcode自带的数据文件，包含一个窗口程序和应用程序委托对象</span><br><span class="line">.sqlite：数据库文件</span><br><span class="line">.txt：文本文件</span><br><span class="line">.mom：Xcode创建的数据模型文件</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ios学习篇-2&quot;&gt;&lt;a href=&quot;#ios学习篇-2&quot; class=&quot;headerlink&quot; title=&quot;ios学习篇(2)&quot;&gt;&lt;/a&gt;ios学习篇(2)&lt;/h1&gt;&lt;h2 id=&quot;ipa文件结构&quot;&gt;&lt;a href=&quot;#ipa文件结构&quot; class=&quot;head</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ios学习篇(1)</title>
    <link href="https://straw-233.github.io/2024/04/13/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/"/>
    <id>https://straw-233.github.io/2024/04/13/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/</id>
    <published>2024-04-13T11:16:58.428Z</published>
    <updated>2024-04-13T13:53:27.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ios学习篇-1"><a href="#ios学习篇-1" class="headerlink" title="ios学习篇(1)"></a>ios学习篇(1)</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>​哎，感觉学安卓太难了，没有用过安卓系统，但是之前有过ios越狱经验，干脆直接学ios逆向好了。学了一个星期，才刚把基础题做出来。为了省钱不买mac，就用windows硬搞，吃尽了苦头啊。。。</p><h2 id="工具-设备"><a href="#工具-设备" class="headerlink" title="工具&#x2F;设备"></a>工具&#x2F;设备</h2><p>iphone 7：dopamine(多巴胺)，牛蛙助手，巨魔商店，open-ssh，debugserver</p><p>windows系统：ssh，爱思助手，ida</p><h2 id="无根越狱-仅适配ios17以下版本"><a href="#无根越狱-仅适配ios17以下版本" class="headerlink" title="无根越狱(仅适配ios17以下版本)"></a>无根越狱(仅适配ios17以下版本)</h2><p>看了很多教程，试过了WinRa1n，直接报错差点成为苹果板砖了。感觉还是多巴胺一键最简单</p><h3 id="前置步骤"><a href="#前置步骤" class="headerlink" title="前置步骤"></a>前置步骤</h3><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E6%89%80%E9%9C%80%E8%BD%AF%E4%BB%B6.png" alt="所需软件"></p><p>​先去把爱思助手下了，爱思能帮你配好很多环境，还有唯一可见的ui，只能执行&#x2F;var&#x2F;mobile&#x2F;Media下的文件</p><p>​再去下个<a href="https://ios222.com/">牛蛙助手官网_苹果助手</a>，BLFGTool这个可以将你下载的ipa进行签名并且安装</p><p>​签名详细步骤可以跟着<a href="https://www.bilibili.com/video/BV1jT4y1H7cu/?spm_id_from=333.337.search-card.all.click&vd_source=934266fa049a08cd3a0a9e4ceda56d20">【免费免越狱】牛蛙助手iphone手机7天自签名神器 手机上自签 从此告别电脑签名 苹果应用多开_哔哩哔哩_bilibili</a>来操作</p><h3 id="中间步骤"><a href="#中间步骤" class="headerlink" title="中间步骤"></a>中间步骤</h3><p>​在手机上的safari浏览器下一个dopamine(多巴胺)的ipa，然后传到牛蛙助手(如果你有巨魔就用巨魔，因为我的巨魔是越狱后搞得)上进行签名安装，打开多巴胺后，就直接默认设置直接一键越狱即可，后续设置的密码要记住，记得使用sileo越狱商店。</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E5%A4%9A%E5%B7%B4%E8%83%BA.png" alt="多巴胺"></p><h3 id="后续步骤"><a href="#后续步骤" class="headerlink" title="后续步骤"></a>后续步骤</h3><p>有了sileo以后，就可以添加各种软件源，在源上下载很多插件，工具，软件等，我的字体也是这里改的。</p><p>先在sileo中搜Trollstore helper，对巨魔商店进行一个安装(感觉是通过一个ios的漏洞安装的，因为没越狱也能装)，巨魔商店是一个一个ipa直接安装的超级牛的工具</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E5%B7%A8%E9%AD%94%E5%95%86%E5%BA%97.png" alt="巨魔商店"></p><p>后面在sileo上再装open-ssh和debug-server，方便我们在windows系统中进行终端操作，和ida远程调试</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/open-ssh.png" alt="open-ssh"></p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/debugserver.png" alt="debugserver"></p><p>最后我喜欢搞一个Filza，一个ios的文件管理器，自带那个权限太低了，啥操作也没有，这个就跟安卓的文件管理器相似了。</p><h2 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h2><p>确保两台设备在同一网络下，使用ssh，进行连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.x.xxx</span><br></pre></td></tr></table></figure><p>输入密码，一般默认是alpine或者是你之前越狱设置的密码</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/ssh%E8%BF%9E%E6%8E%A5.png" alt="ssh连接"></p><p>这样就成功进入了，ios系统是基于unix系统的，所以一些常见的linux指令也能运行</p><h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>以crack me1这题为例子，来演示一下</p><h3 id="ipa"><a href="#ipa" class="headerlink" title="ipa"></a>ipa</h3><p>一般给你的文件就是一个ipa的文件（很多正式的ipa都会有带壳，需要对壳进行砸壳处理，但这题没有），相当于安卓里的apk文件，其实本质上都是一个压缩包，用压缩包打开后，进入&#x2F;Payload&#x2F;crack me1.app&#x2F;</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/ipa%E6%96%87%E4%BB%B6.png" alt="ipa文件"></p><p>就可以看到全部的文件，我们主要用到的是一个mach-o的文件，是mac和ios系统下的可执行文件，就是那个crack me1，关于其他文件是什么，可以自行搜索ipa结构进行分析查看。</p><p>将这个ipa传到巨魔商店里进行安装，打开</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E9%A2%98%E7%9B%AE.png" alt="题目"></p><h3 id="mach-o"><a href="#mach-o" class="headerlink" title="mach-o"></a>mach-o</h3><p>关于怎么判断哪个文件为mach-o文件，其实可以用010中的mach-o的模板看，因为该类文件的文件头和java的.class文件相同，都是CA FE BA BE(咖啡宝贝)</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E5%A4%B4%E6%96%87%E4%BB%B6.png" alt="头文件"></p><p>模板中也能看到很多文件头，函数表，数据库信息等</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/mach-o%E7%BB%93%E6%9E%84.png" alt="mach-o结构"></p><p>当然如果你有mac，使用machoview会更方便</p><p>通过010我们也可以看到，这个文件把32位和64位架构全部整合进去了，所以这个文件无论在哪种arm架构下都能正常运行，但我们手机基本用的是arm64，所以我们用ida64对文件进行分析。</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/main%E5%87%BD%E6%95%B0.png" alt="main函数"></p><p>打开，发现也能正常反编译，是使用object-c写的，左边的函数表中有一堆，然后main函数只是一个接口，没有关键函数，所以从AppDelegate，ViewController，GTMBase64这几个大类下手。</p><p><a href="https://juejin.cn/post/6951591401528229895">iOS应用的启动流程和优化详解 - 掘金 (juejin.cn)</a></p><p><a href="https://www.cnblogs.com/hubert-style/p/15408236.html">iOS程序入口结构 - 背包の技术 - 博客园 (cnblogs.com)</a></p><h3 id="ida分析"><a href="#ida分析" class="headerlink" title="ida分析"></a>ida分析</h3><p>看了一堆文章再加随便乱点以后，发现了关键函数位置ViewController touch</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0.png" alt="关键函数"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v33[2] = self;//指向应用程序的委托对象的指针</span><br><span class="line">v33[1] = (id)a2;//选择器</span><br><span class="line">v33[0] = objc_retain(&amp;cfstr_Crack);//v33=&quot;crack&quot;</span><br><span class="line">v2 = +[ViewController DES:KEY:](&amp;OBJC_CLASS___ViewController, &quot;DES:KEY:&quot;, string, v33[0]);//DES加密</span><br><span class="line">v32 = objc_retainAutoreleasedReturnValue(v2);//清空释放</span><br><span class="line">v3 = objc_msgSend((id)textfield, &quot;text&quot;);//相当于scanf，获取text窗口中的数据</span><br><span class="line">v25 = objc_retainAutoreleasedReturnValue(v3);//清空释放</span><br><span class="line">v24 = (unsigned __int8)objc_msgSend(v32, &quot;isEqualToString:&quot;, v25);//比较</span><br><span class="line">objc_release(v25);</span><br></pre></td></tr></table></figure><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/DES%E5%8A%A0%E5%AF%86.png" alt="DES加密"></p><p>细看DES加密的函数，要是不给函数名，估计更难看，这边调用了CommonCrypto 库中的 CCCrypt 函数进行加密或解密操作</p><p>进入CCCrypt细看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CCCryptorStatus __cdecl CCCrypt(</span><br><span class="line">        CCOperation op,</span><br><span class="line">        CCAlgorithm alg,</span><br><span class="line">        CCOptions options,</span><br><span class="line">        const void *key,</span><br><span class="line">        size_t keyLength,</span><br><span class="line">        const void *iv,</span><br><span class="line">        const void *dataIn,</span><br><span class="line">        size_t dataInLength,</span><br><span class="line">        void *dataOut,</span><br><span class="line">        size_t dataOutAvailable,</span><br><span class="line">        size_t *dataOutMoved)</span><br><span class="line">&#123;</span><br><span class="line">  return _CCCrypt(op, alg, options, key, keyLength, iv, dataIn, dataInLength, dataOut, dataOutAvailable, dataOutMoved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">解释一下每个参数的作用：</span><br><span class="line">op: 表示进行加密还是解密操作，可以是 kCCEncrypt 或 kCCDecrypt。</span><br><span class="line">alg: 表示使用的加密算法，例如 kCCAlgorithmAES 表示使用 AES 算法。</span><br><span class="line">options: 用于指定加密选项，例如填充方式等。</span><br><span class="line">key: 表示加密或解密所使用的密钥。</span><br><span class="line">keyLength: 表示密钥的长度。</span><br><span class="line">iv: 表示初始化向量（Initialization Vector），在某些加密模式下会使用到。</span><br><span class="line">dataIn: 表示待加密或解密的数据输入。</span><br><span class="line">dataInLength: 表示待加密或解密的数据输入长度。</span><br><span class="line">dataOut: 表示加密或解密后的数据输出。</span><br><span class="line">dataOutAvailable: 表示输出缓冲区的可用空间大小。</span><br><span class="line">dataOutMoved: 表示实际写入到输出缓冲区的数据长度。</span><br></pre></td></tr></table></figure><p>然后根据参数看出来是DES&#x2F;pkcs7&#x2F;ECB加密，密文是1hKgkdbhfbeu6755d8fk，密钥是crack，但是自己加密出来结果怎么都是是错的，感觉是密钥填充的问题，哎，要是能动态调试这题就秒杀了。</p><h3 id="动态调试-1"><a href="#动态调试-1" class="headerlink" title="动态调试"></a>动态调试</h3><p>最煎熬的地方，看了无数文章，无限个报错，终于成功动调了。</p><p>因为ida本身不自带iphone-server（为什么macos-server都有，iPhone没有？怒了），我们要用其他的方法调试</p><p>我先尝试了用网上下载的debug-server，但是因为iphone自身极高的保护，修改了各种权限后，还是一执行就把我kill掉，估计也是因为签名问题，iphone 的保护真是好啊！</p><p>于是又搜到sileo中的自带的debugserver，在iphone中安装完debugserver后，就已经在环境变量中能直接使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">debugserver-@(#)PROGRAM:LLDB  PROJECT:lldb-14.0.0</span><br><span class="line"> for arm64.</span><br><span class="line">Usage:</span><br><span class="line">  debugserver host:port [program-name program-arg1 program-arg2 ...]</span><br><span class="line">  debugserver /path/file [program-name program-arg1 program-arg2 ...]</span><br><span class="line">  debugserver host:port --attach=&lt;pid&gt;</span><br><span class="line">  debugserver /path/file --attach=&lt;pid&gt;</span><br><span class="line">  debugserver host:port --attach=&lt;process_name&gt;</span><br><span class="line">  debugserver /path/file --attach=&lt;process_name&gt;</span><br></pre></td></tr></table></figure><p>将我们的题目在手机中打开</p><p>先要查看你所运行的程序的PID，简单的grep查找指令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep crack</span><br></pre></td></tr></table></figure><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/PID%E6%9F%A5%E7%9C%8B.png" alt="PID查看"></p><p>可以看到PID为37918</p><p>输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugserver 192.168.x.xxx:3333</span><br><span class="line">               电脑的ip  端口(默认)</span><br></pre></td></tr></table></figure><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E7%9B%91%E5%90%AC.png" alt="监听"></p><p>打开ida,远程调试参数设置</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/ip%E8%AE%BE%E7%BD%AE.png" alt="ip设置"></p><p>那个hostname填的是你手机的ip地址，跟上面的相反</p><p>连上后再用attach process输入刚才获取的程序PID，进行附加</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E7%AB%AF%E5%8F%A3%E8%AE%BE%E7%BD%AE.png" alt="端口设置"></p><p>要慢慢wait，等待各种函数加载好，这样就可以正常调试了，我们在刚才那个分析的判断函数下断个断点</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E4%B8%8B%E6%96%AD%E7%82%B9.png" alt="下断点"></p><p>点进v32</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E5%9C%B0%E5%9D%80.png" alt="地址"></p><p>一个地址，再进去</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/flag.png" alt="flag"></p><p>下面就是我们的flag啦</p><p>输入我们的app进行验证</p><p><img src="/../img/ios%E5%AD%A6%E4%B9%A0%E7%AF%87(1)/%E9%AA%8C%E8%AF%81%E6%88%90%E5%8A%9F.png" alt="验证成功"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ios学习篇-1&quot;&gt;&lt;a href=&quot;#ios学习篇-1&quot; class=&quot;headerlink&quot; title=&quot;ios学习篇(1)&quot;&gt;&lt;/a&gt;ios学习篇(1)&lt;/h1&gt;&lt;h2 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>反混淆学习-fla控制流平坦化篇</title>
    <link href="https://straw-233.github.io/2024/03/27/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E7%AF%87/"/>
    <id>https://straw-233.github.io/2024/03/27/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E7%AF%87/</id>
    <published>2024-03-27T13:23:15.049Z</published>
    <updated>2024-03-27T13:43:28.160Z</updated>
    
    <content type="html"><![CDATA[<h1 id="反混淆学习-fla控制流平坦化篇"><a href="#反混淆学习-fla控制流平坦化篇" class="headerlink" title="反混淆学习-fla控制流平坦化篇"></a>反混淆学习-fla控制流平坦化篇</h1><p>感觉反混淆比混淆难多了。。。</p><p>现在也暂时不会怎么自己写ida-python脚本来反混淆</p><p>还是先学学看吧</p><h2 id="deflat工具介绍"><a href="#deflat工具介绍" class="headerlink" title="deflat工具介绍"></a>deflat工具介绍</h2><p>网上常用的反控制流平坦化的工具，可以直接在终端运行将经过fla编译的可执行文件转化为反混淆过的可执行文件，也支持arm架构。</p><p>下载地址：<a href="https://github.com/cq674350529/deflat">deflat: use angr to deobfuscation </a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python deflat.py --file 文件名 --addr 初始地址</span><br></pre></td></tr></table></figure><p>需要一个python的angr库</p><p>因为要用到初始地址，所以就要求你的可执行文件没开PIE（随机地址）保护</p><p>（要求还挺苛刻的，估计只有比赛值得一用，实战估计全是保护全开，优点就是常用架构都能用）</p><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>自己先用编译一个保护全关的经过fla过的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opt -lowerswitch -S IR/TestProgram.ll -o IR/TestProgram_lowerswitch.ll</span><br><span class="line">opt -load ../Build/LLVMObfuscator.so -fla -S -enable-new-pm=0 IR/TestProgram_lowerswitch.ll -o IR/TestProgram_fla.ll</span><br><span class="line">clang IR/TestProgram_fla.ll -o Bin/TestProgram_fla -fno-stack-protector -z execstack -no-pie</span><br></pre></td></tr></table></figure><p><img src="/../img/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E7%AF%87/image-20240327201723919.png" alt="image-20240327201723919"></p><p>用ida看看，很常规的控制流平坦化</p><p><img src="/../img/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E7%AF%87/image-20240327201828945.png" alt="image-20240327201828945"></p><p>用工具转化一下，得到了个TestProgram_fla_unprotect_recovered文件</p><p><img src="/../img/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E7%AF%87/image-20240327202021043.png" alt="image-20240327202021043"></p><p>确实反混淆了，效果不错</p><p><img src="/../img/%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AD%A6%E4%B9%A0-fla%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E7%AF%87/image-20240327202141816.png" alt="image-20240327202141816"></p><p>这下面有一堆nop看来是把一些跳转指令全去了，并进行了补全</p><h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>详细学习太复杂，简单概述一下大概流程</p><h3 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h3><p>引入：</p><ol><li>函数的开始地址为序言的地址</li><li>序言的后继为主分发器</li><li>后继为主分发器的块为预处理器</li><li>后继为预处理器的块为真实块</li><li>无后继的块为返回块</li><li>剩下的为无用块</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;deflat control flow script&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--file&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;binary to analyze&quot;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--addr&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;address of target function in hex format&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.file <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> args.addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    filename = args.file</span><br><span class="line">    start = <span class="built_in">int</span>(args.addr, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    project = angr.Project(filename, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    <span class="comment"># do normalize to avoid overlapping blocks, disable force_complete_scan to avoid possible &quot;wrong&quot; blocks</span></span><br><span class="line">    <span class="comment"># 获取控制流</span></span><br><span class="line">    cfg = project.analyses.CFGFast(normalize=<span class="literal">True</span>, force_complete_scan=<span class="literal">False</span>)</span><br><span class="line">    target_function = cfg.functions.get(start)</span><br><span class="line">    <span class="comment"># A super transition graph is a graph that looks like IDA Pro&#x27;s CFG</span></span><br><span class="line">    supergraph = am_graph.to_supergraph(target_function.transition_graph)</span><br><span class="line"></span><br><span class="line">    base_addr = project.loader.main_object.mapped_base &gt;&gt; <span class="number">12</span> &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get prologue_node and retn_node</span></span><br><span class="line">    <span class="comment"># 从控制流中获取返回块和序言</span></span><br><span class="line">    prologue_node = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">        <span class="keyword">if</span> supergraph.in_degree(node) == <span class="number">0</span>:</span><br><span class="line">            prologue_node = node</span><br><span class="line">        <span class="keyword">if</span> supergraph.out_degree(node) == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(node.out_branches) == <span class="number">0</span>:</span><br><span class="line">            retn_node = node</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prologue_node <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> prologue_node.addr != start:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Something must be wrong...&quot;</span>)</span><br><span class="line">        sys.exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主分发器，successors包括了所有正常的后续list</span></span><br><span class="line">    main_dispatcher_node = <span class="built_in">list</span>(supergraph.successors(prologue_node))[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 找到预处理器</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.predecessors(main_dispatcher_node):</span><br><span class="line">        <span class="keyword">if</span> node.addr != prologue_node.addr:</span><br><span class="line">            pre_dispatcher_node = node</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 找到真实块和预处理块（虚假块）</span></span><br><span class="line">    relevant_nodes, nop_nodes = get_relevant_nop_nodes(</span><br><span class="line">        supergraph, pre_dispatcher_node, prologue_node, retn_node)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******************relevant blocks************************&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;prologue: %#x&#x27;</span> % start)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;main_dispatcher: %#x&#x27;</span> % main_dispatcher_node.addr)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;pre_dispatcher: %#x&#x27;</span> % pre_dispatcher_node.addr)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;retn: %#x&#x27;</span> % retn_node.addr)</span><br><span class="line">    relevant_block_addrs = [node.addr <span class="keyword">for</span> node <span class="keyword">in</span> relevant_nodes]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;relevant_blocks:&#x27;</span>, [<span class="built_in">hex</span>(addr) <span class="keyword">for</span> addr <span class="keyword">in</span> relevant_block_addrs])</span><br><span class="line"><span class="comment"># 打印相关块信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******************symbolic execution*********************&#x27;</span>)</span><br><span class="line">    relevants = relevant_nodes</span><br><span class="line">    relevants.append(prologue_node)</span><br><span class="line">    relevants_without_retn = <span class="built_in">list</span>(relevants)</span><br><span class="line">    relevants.append(retn_node)</span><br><span class="line">    relevant_block_addrs.extend([prologue_node.addr, retn_node.addr])</span><br><span class="line"></span><br><span class="line">    flow = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    patch_instrs = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> relevant <span class="keyword">in</span> relevants_without_retn:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-------------------dse %#x---------------------&#x27;</span> % relevant.addr)</span><br><span class="line">        block = project.factory.block(relevant.addr, size=relevant.size)</span><br><span class="line">        has_branches = <span class="literal">False</span></span><br><span class="line">        hook_addrs = <span class="built_in">set</span>([])</span><br><span class="line">        <span class="keyword">for</span> ins <span class="keyword">in</span> block.capstone.insns:</span><br><span class="line">            <span class="comment"># 不同架构的区分</span></span><br><span class="line">            <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">                <span class="comment"># 判断该真实块是否存在分支</span></span><br><span class="line">                <span class="keyword">if</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;cmov&#x27;</span>):</span><br><span class="line">                    <span class="comment"># only record the first one</span></span><br><span class="line">                    <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                        patch_instrs[relevant] = ins</span><br><span class="line">                        has_branches = <span class="literal">True</span></span><br><span class="line">                <span class="comment"># call指令对angr没影响，直接hook</span></span><br><span class="line">                <span class="keyword">elif</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;call&#x27;</span>):</span><br><span class="line">                    hook_addrs.add(ins.insn.address)</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">                <span class="keyword">if</span> ins.insn.mnemonic != <span class="string">&#x27;mov&#x27;</span> <span class="keyword">and</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;mov&#x27;</span>):</span><br><span class="line">                    <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                        patch_instrs[relevant] = ins</span><br><span class="line">                        has_branches = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">elif</span> ins.insn.mnemonic <span class="keyword">in</span> &#123;<span class="string">&#x27;bl&#x27;</span>, <span class="string">&#x27;blx&#x27;</span>&#125;:</span><br><span class="line">                    hook_addrs.add(ins.insn.address)</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">                <span class="keyword">if</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;cset&#x27;</span>):</span><br><span class="line">                    <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                        patch_instrs[relevant] = ins</span><br><span class="line">                        has_branches = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">elif</span> ins.insn.mnemonic <span class="keyword">in</span> &#123;<span class="string">&#x27;bl&#x27;</span>, <span class="string">&#x27;blr&#x27;</span>&#125;:</span><br><span class="line">                    hook_addrs.add(ins.insn.address)</span><br><span class="line">                    </span><br><span class="line">        <span class="comment"># angr符号执行，对于两个分支的进行模拟，获取后续节点  </span></span><br><span class="line">        <span class="keyword">if</span> has_branches:</span><br><span class="line">            tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                     relevant.addr, hook_addrs, claripy.BVV(<span class="number">1</span>, <span class="number">1</span>), <span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                flow[relevant].append(tmp_addr)</span><br><span class="line">            tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                     relevant.addr, hook_addrs, claripy.BVV(<span class="number">0</span>, <span class="number">1</span>), <span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                flow[relevant].append(tmp_addr)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                     relevant.addr, hook_addrs)</span><br><span class="line">            <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                flow[relevant].append(tmp_addr)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************flow******************************&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> flow.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % k.addr, [<span class="built_in">hex</span>(child) <span class="keyword">for</span> child <span class="keyword">in</span> v])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % retn_node.addr, [])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************patch*****************************&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> origin:</span><br><span class="line">        <span class="comment"># Attention: can&#x27;t transform to str by calling decode() directly. so use bytearray instead.</span></span><br><span class="line">        origin_data = <span class="built_in">bytearray</span>(origin.read())</span><br><span class="line">        origin_data_len = <span class="built_in">len</span>(origin_data)</span><br><span class="line">        <span class="comment"># 打开文件，记录长度</span></span><br><span class="line"></span><br><span class="line">    recovery_file = filename + <span class="string">&#x27;_recovered&#x27;</span></span><br><span class="line">    recovery = <span class="built_in">open</span>(recovery_file, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    <span class="comment"># 重命名为_recovered文件并重新打开</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># patch irrelevant blocks</span></span><br><span class="line">    <span class="keyword">for</span> nop_node <span class="keyword">in</span> nop_nodes:</span><br><span class="line">        fill_nop(origin_data, nop_node.addr-base_addr,</span><br><span class="line">                 nop_node.size, project.arch)</span><br><span class="line">    <span class="comment"># 如果在nop列表中全nop了</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># remove unnecessary control flows</span></span><br><span class="line">    <span class="keyword">for</span> parent, childs <span class="keyword">in</span> flow.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(childs) == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 子节点为1的操作</span></span><br><span class="line">            parent_block = project.factory.block(parent.addr, size=parent.size)</span><br><span class="line">            last_instr = parent_block.capstone.insns[-<span class="number">1</span>]</span><br><span class="line">            file_offset = last_instr.address - base_addr</span><br><span class="line">            <span class="comment"># patch the last instruction to jmp</span></span><br><span class="line">            <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">                fill_nop(origin_data, file_offset,</span><br><span class="line">                         last_instr.size, project.arch)</span><br><span class="line">                patch_value = ins_j_jmp_hex_x86(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;jmp&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">                patch_value = ins_b_jmp_hex_arm(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&quot;Iend_BE&quot;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">                <span class="comment"># <span class="doctag">FIXME:</span> For aarch64/arm64, the last instruction of prologue seems useful in some cases, so patch the next instruction instead.</span></span><br><span class="line">                <span class="keyword">if</span> parent.addr == start:</span><br><span class="line">                    file_offset += <span class="number">4</span></span><br><span class="line">                    patch_value = ins_b_jmp_hex_arm64(last_instr.address+<span class="number">4</span>, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    patch_value = ins_b_jmp_hex_arm64(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&quot;Iend_BE&quot;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">            <span class="comment"># 针对不同架构将父节点的最后一条指令修补为跳转至子节点的跳转指令</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 子节点多个的操作</span></span><br><span class="line">            instr = patch_instrs[parent]</span><br><span class="line">            file_offset = instr.address - base_addr</span><br><span class="line">            <span class="comment"># patch instructions starting from `cmovx` to the end of block</span></span><br><span class="line">            fill_nop(origin_data, file_offset, parent.addr +</span><br><span class="line">                     parent.size - base_addr - file_offset, project.arch)</span><br><span class="line">            <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">                <span class="comment"># patch the cmovx instruction to jx instruction</span></span><br><span class="line">                patch_value = ins_j_jmp_hex_x86(instr.address, childs[<span class="number">0</span>], instr.mnemonic[<span class="built_in">len</span>(<span class="string">&#x27;cmov&#x27;</span>):])</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"></span><br><span class="line">                file_offset += <span class="number">6</span></span><br><span class="line">                <span class="comment"># patch the next instruction to jmp instrcution</span></span><br><span class="line">                patch_value = ins_j_jmp_hex_x86(instr.address+<span class="number">6</span>, childs[<span class="number">1</span>], <span class="string">&#x27;jmp&#x27;</span>)</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">                <span class="comment"># patch the movx instruction to bx instruction</span></span><br><span class="line">                bx_cond = <span class="string">&#x27;b&#x27;</span> + instr.mnemonic[<span class="built_in">len</span>(<span class="string">&#x27;mov&#x27;</span>):]</span><br><span class="line">                patch_value = ins_b_jmp_hex_arm(instr.address, childs[<span class="number">0</span>], bx_cond)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"></span><br><span class="line">                file_offset += <span class="number">4</span></span><br><span class="line">                <span class="comment"># patch the next instruction to b instrcution</span></span><br><span class="line">                patch_value = ins_b_jmp_hex_arm(instr.address+<span class="number">4</span>, childs[<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">            <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">                <span class="comment"># patch the cset.xx instruction to bx instruction</span></span><br><span class="line">                bx_cond = instr.op_str.split(<span class="string">&#x27;,&#x27;</span>)[-<span class="number">1</span>].strip()</span><br><span class="line">                patch_value = ins_b_jmp_hex_arm64(instr.address, childs[<span class="number">0</span>], bx_cond)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"></span><br><span class="line">                file_offset += <span class="number">4</span></span><br><span class="line">                <span class="comment"># patch the next instruction to b instruction</span></span><br><span class="line">                patch_value = ins_b_jmp_hex_arm64(instr.address+<span class="number">4</span>, childs[<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                    patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">                patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">                <span class="comment">#如果存在多个子节点，则需要进行更复杂的修补。对于x86架构，需要修改条件传送指令（如cmovx）为条件跳转指令（如jx）。对于ARM和ARM64架构，需要修改指令为条件跳转指令（如bx、b）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(origin_data) == origin_data_len, <span class="string">&quot;Error: size of data changed!!!&quot;</span></span><br><span class="line">    <span class="comment">#确保修复前后长度相同</span></span><br><span class="line">    recovery.write(origin_data)</span><br><span class="line">    recovery.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Successful! The recovered file: %s&#x27;</span> % recovery_file)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="获取与控制流相关的NOP节点"><a href="#获取与控制流相关的NOP节点" class="headerlink" title="获取与控制流相关的NOP节点"></a>获取与控制流相关的NOP节点</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_relevant_nop_nodes</span>(<span class="params">supergraph, pre_dispatcher_node, prologue_node, retn_node</span>):</span><br><span class="line">    <span class="comment"># relevant_nodes = list(supergraph.predecessors(pre_dispatcher_node))</span></span><br><span class="line">    relevant_nodes = []</span><br><span class="line">    nop_nodes = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">        <span class="comment">#使用块字节大小，来判断是否为真实块</span></span><br><span class="line">        <span class="keyword">if</span> supergraph.has_edge(node, pre_dispatcher_node) <span class="keyword">and</span> node.size &gt; <span class="number">8</span>:</span><br><span class="line">            <span class="comment"># <span class="doctag">XXX:</span> use node.size is faster than to create a block</span></span><br><span class="line">            relevant_nodes.append(node)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment">#排除序言，返回块，预处理器</span></span><br><span class="line">        <span class="keyword">if</span> node.addr <span class="keyword">in</span> (prologue_node.addr, retn_node.addr, pre_dispatcher_node.addr):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        nop_nodes.append(node)</span><br><span class="line">        <span class="comment">#其余都加入nop</span></span><br><span class="line">    <span class="keyword">return</span> relevant_nodes, nop_nodes</span><br></pre></td></tr></table></figure><h3 id="在给定的起始地址处执行符号执行"><a href="#在给定的起始地址处执行符号执行" class="headerlink" title="在给定的起始地址处执行符号执行"></a>在给定的起始地址处执行符号执行</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">symbolic_execution</span>(<span class="params">project, relevant_block_addrs, start_addr, hook_addrs=<span class="literal">None</span>, modify_value=<span class="literal">None</span>, inspect=<span class="literal">False</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#从状态中获取当前指令指针的值，并解除指定地址的挂钩</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retn_procedure</span>(<span class="params">state</span>):</span><br><span class="line">        ip = state.solver.<span class="built_in">eval</span>(state.regs.ip)</span><br><span class="line">        project.unhook(ip)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># 检查语句</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statement_inspect</span>(<span class="params">state</span>):</span><br><span class="line">        expressions = <span class="built_in">list</span>(</span><br><span class="line">            state.scratch.irsb.statements[state.inspect.statement].expressions)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(expressions) != <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(expressions[<span class="number">0</span>], pyvex.expr.ITE):</span><br><span class="line">            state.scratch.temps[expressions[<span class="number">0</span>].cond.tmp] = modify_value</span><br><span class="line">            state.inspect._breakpoints[<span class="string">&#x27;statement&#x27;</span>] = []</span><br><span class="line"><span class="comment"># 检查挂钩</span></span><br><span class="line">    <span class="keyword">if</span> hook_addrs <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        skip_length = <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">            skip_length = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> hook_addr <span class="keyword">in</span> hook_addrs:</span><br><span class="line">            project.hook(hook_addr, retn_procedure, length=skip_length)</span><br><span class="line"></span><br><span class="line">    state = project.factory.blank_state(addr=start_addr, remove_options=&#123;</span><br><span class="line">                                        angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">    <span class="keyword">if</span> inspect:</span><br><span class="line">        state.inspect.b(</span><br><span class="line">            <span class="string">&#x27;statement&#x27;</span>, when=angr.state_plugins.inspect.BP_BEFORE, action=statement_inspect)</span><br><span class="line">    sm = project.factory.simulation_manager(state)</span><br><span class="line">    sm.step()</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(sm.active) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> active_state <span class="keyword">in</span> sm.active:</span><br><span class="line">            <span class="keyword">if</span> active_state.addr <span class="keyword">in</span> relevant_block_addrs:</span><br><span class="line">                <span class="keyword">return</span> active_state.addr</span><br><span class="line">        sm.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;反混淆学习-fla控制流平坦化篇&quot;&gt;&lt;a href=&quot;#反混淆学习-fla控制流平坦化篇&quot; class=&quot;headerlink&quot; title=&quot;反混淆学习-fla控制流平坦化篇&quot;&gt;&lt;/a&gt;反混淆学习-fla控制流平坦化篇&lt;/h1&gt;&lt;p&gt;感觉反混淆比混淆难多了。。。</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>OLLVM-常量替代</title>
    <link href="https://straw-233.github.io/2024/03/20/OLLVM-%E5%B8%B8%E9%87%8F%E6%9B%BF%E4%BB%A3/"/>
    <id>https://straw-233.github.io/2024/03/20/OLLVM-%E5%B8%B8%E9%87%8F%E6%9B%BF%E4%BB%A3/</id>
    <published>2024-03-20T10:43:21.967Z</published>
    <updated>2024-03-20T10:47:12.016Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OLLVM-常量替代"><a href="#OLLVM-常量替代" class="headerlink" title="OLLVM-常量替代"></a>OLLVM-常量替代</h1><p>感觉跟指令替代类似，仅支持32位整数替代</p><p>（建议结合代码食用）</p><h2 id="替换方案"><a href="#替换方案" class="headerlink" title="替换方案"></a>替换方案</h2><p><img src="/../img/OLLVM%E5%B8%B8%E9%87%8F%E6%9B%BF%E4%BB%A3/%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88.png" alt="替换方案"></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>ConstantSubstitution.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/CommandLine.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Local.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SplitBasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RAND 32767</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_CONST_SUBST 2</span></span><br><span class="line">using namespace llvm;</span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"><span class="type">static</span> cl::opt&lt;<span class="type">int</span>&gt; <span class="title function_">obfuTimes</span><span class="params">(<span class="string">&quot;csub_loop&quot;</span>,cl::init(<span class="number">1</span>),cl::desc(<span class="string">&quot;Obfucase a function &lt;obfu_loop&gt; time(s).&quot;</span>))</span>;</span><br><span class="line">namespace&#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">ConstantSubstitution</span> :</span>public FunctionPass&#123;</span><br><span class="line">        public :</span><br><span class="line">            <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">            </span><br><span class="line">            ConstantSubstitution():FunctionPass(ID)&#123;</span><br><span class="line">                srand(time(<span class="literal">NULL</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">bool</span> <span class="title function_">runOnFunction</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">substitute</span><span class="params">(BinaryOperator *BI)</span>;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">linearSubstitute</span><span class="params">(BinaryOperator *BI,<span class="type">int</span> i)</span>;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">bitwiseSubstitute</span><span class="params">(BinaryOperator *BI,<span class="type">int</span> i)</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">ConstantSubstitution::runOnFunction</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    INIT_CONTEXT(F);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;obfuTimes;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock &amp;BB:F)&#123;</span><br><span class="line">            <span class="built_in">vector</span>&lt;Instruction*&gt;origInst;</span><br><span class="line">            <span class="keyword">for</span>(Instruction &amp;I:BB)&#123;</span><br><span class="line">                origInst.push_back(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(Instruction *I:origInst)&#123; <span class="comment">//遍历所有指令</span></span><br><span class="line">                <span class="keyword">if</span>(BinaryOperator *BI=dyn_cast&lt;BinaryOperator&gt;(I))&#123;<span class="comment">//判断是不是二元运算指令</span></span><br><span class="line">                    <span class="keyword">if</span>(BI-&gt;getType()-&gt;isIntegerTy(<span class="number">32</span>))&#123;<span class="comment">//仅对整数进行替换</span></span><br><span class="line">                        substitute(BI);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ConstantSubstitution::substitute</span><span class="params">(BinaryOperator *BI)</span>&#123;</span><br><span class="line">    <span class="type">int</span> operandNum =BI -&gt;getNumOperands();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;operandNum;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(isa&lt;ConstantInt&gt;(BI-&gt;getOperand(i)))&#123;</span><br><span class="line">            <span class="type">int</span> choice =rand()%NUMBER_CONST_SUBST;</span><br><span class="line">            <span class="keyword">switch</span> (choice)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                linearSubstitute(BI,i); <span class="comment">// 线性替换</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                bitwiseSubstitute(BI,i);</span><br><span class="line">                <span class="comment">// bitwiseSubstitute(BI,i); // 按位运算替换</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ConstantSubstitution::linearSubstitute</span><span class="params">(BinaryOperator *BI,<span class="type">int</span> i)</span>&#123;</span><br><span class="line">    <span class="comment">//线性替换 :Val -&gt; ax+by+c</span></span><br><span class="line">    <span class="comment">//其中 val 为原常量 a, b 为随机常量 x, y 为随机全局变量 c = val - (ax + by)</span></span><br><span class="line">    Module *M=BI-&gt;getModule();</span><br><span class="line">    <span class="comment">//指定模块</span></span><br><span class="line">    ConstantInt *val=cast&lt;ConstantInt&gt;(BI-&gt;getOperand(i));</span><br><span class="line">    <span class="comment">//获取原来的操作数</span></span><br><span class="line">    <span class="type">int</span> randx=rand()%MAX_RAND,randy=rand()%MAX_RAND;</span><br><span class="line">    <span class="comment">//创建随机数x,y</span></span><br><span class="line">    <span class="type">int</span> randa=rand()%MAX_RAND,randb=rand()%MAX_RAND;</span><br><span class="line">    <span class="comment">//创建随机数a,b</span></span><br><span class="line">    APInt c = val-&gt;getValue()-(randx*randa+randy*randb);</span><br><span class="line">    <span class="comment">//c=val-(ax+by)</span></span><br><span class="line">    GlobalVariable *xptr=new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::PrivateLinkage,CONST_I32(randx),<span class="string">&quot;x&quot;</span>);</span><br><span class="line">    <span class="comment">//创建x全局变量</span></span><br><span class="line">    <span class="comment">//commonLinkage 是未初始化的全局变量，初始值只能为0，不能为其他值。这里我们设置的初始值x不能是0，所以不能设置成commonlinkage</span></span><br><span class="line">    GlobalVariable *yptr=new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::PrivateLinkage,CONST_I32(randy),<span class="string">&quot;y&quot;</span>);</span><br><span class="line">    <span class="comment">//创建y全局变量</span></span><br><span class="line">    LoadInst *x=new LoadInst(TYPE_I32,xptr,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//读取x</span></span><br><span class="line">    LoadInst *y=new LoadInst(TYPE_I32,yptr,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//读取y</span></span><br><span class="line">    BinaryOperator *op1=BinaryOperator::CreateMul(CONST_I32(randa),x,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//ax</span></span><br><span class="line">    BinaryOperator *op2=BinaryOperator::CreateMul(CONST_I32(randb),y,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//by</span></span><br><span class="line">    BinaryOperator *op3=BinaryOperator::CreateAdd(op1,op2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//ax+by</span></span><br><span class="line">    BinaryOperator *op4=BinaryOperator::CreateAdd(op3,CONST_I32(c.getSExtValue()),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//ax+by+c</span></span><br><span class="line">    BI-&gt;setOperand(i,op4);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ConstantSubstitution::bitwiseSubstitute</span><span class="params">(BinaryOperator *BI,<span class="type">int</span> i)</span>&#123;</span><br><span class="line">    <span class="comment">//按位运算替换：val -&gt; (x &lt;&lt; 5 | y &gt;&gt; 3) ^ c</span></span><br><span class="line">    <span class="comment">//其中 val 为原常量x, y 为随机全局变量 c = val ^ (x &lt;&lt; 5 | y &gt;&gt; 3)</span></span><br><span class="line">    Module *M=BI-&gt;getModule();</span><br><span class="line">    <span class="comment">//指定模块</span></span><br><span class="line">    ConstantInt *val=cast&lt;ConstantInt&gt;(BI-&gt;getOperand(i));</span><br><span class="line">    <span class="comment">//获取原来的操作数</span></span><br><span class="line">    <span class="type">int</span> randx=rand()%MAX_RAND,randy=rand()%MAX_RAND;</span><br><span class="line">    <span class="comment">//随机数</span></span><br><span class="line">    APInt c = val-&gt;getValue()^(randx&lt;&lt;<span class="number">5</span>|randy&gt;&gt;<span class="number">3</span>);</span><br><span class="line">    <span class="comment">//c = val ^ (x &lt;&lt; 5 | y &gt;&gt; 3)</span></span><br><span class="line">    GlobalVariable *xptr=new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::PrivateLinkage,CONST_I32(randx),<span class="string">&quot;x&quot;</span>);   </span><br><span class="line">    <span class="comment">//创建x全局变量</span></span><br><span class="line">    <span class="comment">//commonLinkage 是未初始化的全局变量，初始值只能为0，不能为其他值。这里我们设置的初始值x不能是0，所以不能设置成commonlinkage</span></span><br><span class="line">    GlobalVariable *yptr=new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::PrivateLinkage,CONST_I32(randy),<span class="string">&quot;y&quot;</span>);</span><br><span class="line">    <span class="comment">//创建y全局变量 </span></span><br><span class="line">    LoadInst *x=new LoadInst(TYPE_I32,xptr,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//加载x</span></span><br><span class="line">    LoadInst *y=new LoadInst(TYPE_I32,yptr,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//加载y</span></span><br><span class="line">    BinaryOperator *op1=BinaryOperator::CreateShl(x,CONST_I32(<span class="number">5</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//x&lt;&lt;5</span></span><br><span class="line">    BinaryOperator *op2=BinaryOperator::CreateLShr(y,CONST_I32(<span class="number">3</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//y&gt;&gt;3</span></span><br><span class="line">    BinaryOperator *op3=BinaryOperator::CreateOr(op1,op2,<span class="string">&quot;&quot;</span>,BI);  </span><br><span class="line">    <span class="comment">//x&lt;&lt;5|y&gt;&gt;3</span></span><br><span class="line">    BinaryOperator *op4=BinaryOperator::CreateXor(op3,CONST_I32(c.getSExtValue()),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//c^(x&lt;&lt;5|y&gt;&gt;3)</span></span><br><span class="line">    BI-&gt;setOperand(i,op4);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> ConstantSubstitution::ID=<span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> RegisterPass&lt;ConstantSubstitution&gt; <span class="title function_">X</span><span class="params">(<span class="string">&quot;csub&quot;</span>,<span class="string">&quot;Replace a constant value with equivalent instructions&quot;</span>)</span>; </span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="/../img/OLLVM%E5%B8%B8%E9%87%8F%E6%9B%BF%E4%BB%A3/%E6%95%88%E6%9E%9C1.png" alt="效果1"></p><p>用自己的题目编译混淆了一次，效果还行，试试三次的</p><p><img src="/../img/OLLVM%E5%B8%B8%E9%87%8F%E6%9B%BF%E4%BB%A3/%E6%95%88%E6%9E%9C2.png" alt="效果2"></p><p>爽了，妈妈再也不用担心我的tea加密被一眼看出来了</p><p><img src="/../img/%E4%BB%A4%E7%82%B9%E5%A4%B4.gif" alt="令点头"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OLLVM-常量替代&quot;&gt;&lt;a href=&quot;#OLLVM-常量替代&quot; class=&quot;headerlink&quot; title=&quot;OLLVM-常量替代&quot;&gt;&lt;/a&gt;OLLVM-常量替代&lt;/h1&gt;&lt;p&gt;感觉跟指令替代类似，仅支持32位整数替代&lt;/p&gt;
&lt;p&gt;（建议结合代码食用）</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>OLLVM-随机控制流</title>
    <link href="https://straw-233.github.io/2024/03/19/OLLVM-%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/"/>
    <id>https://straw-233.github.io/2024/03/19/OLLVM-%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/</id>
    <published>2024-03-19T11:45:53.766Z</published>
    <updated>2024-03-19T11:49:56.760Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OLLVM-随机控制流"><a href="#OLLVM-随机控制流" class="headerlink" title="OLLVM-随机控制流"></a>OLLVM-随机控制流</h1><p>感觉跟虚假控制流差不多，就是badyBB和cloneBB的定向跳转转到了随机跳转</p><p>(建议结合代码食用)</p><p><img src="/../img/%E5%B0%8F%E9%B8%A1%E8%B5%B0.gif" alt="小鸡走"></p><h2 id="第一步：基本块分割"><a href="#第一步：基本块分割" class="headerlink" title="第一步：基本块分割"></a>第一步：基本块分割</h2><p>与虚假控制流相同</p><h2 id="第二步：基本块克隆"><a href="#第二步：基本块克隆" class="headerlink" title="第二步：基本块克隆"></a>第二步：基本块克隆</h2><p><img src="/../img/OLLVM%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/%E9%9A%8F%E6%9C%BA2.png" alt="随机2"></p><h2 id="第三步：构造随机跳转，插入生成随机数指令，插入随即跳转，对随机数进行恒等变换"><a href="#第三步：构造随机跳转，插入生成随机数指令，插入随即跳转，对随机数进行恒等变换" class="headerlink" title="第三步：构造随机跳转，插入生成随机数指令，插入随即跳转，对随机数进行恒等变换"></a>第三步：构造随机跳转，插入生成随机数指令，插入随即跳转，对随机数进行恒等变换</h2><p><img src="/../img/OLLVM%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/%E9%9A%8F%E6%9C%BA3.png" alt="随机3"></p><h2 id="第四步：构造虚假随机数跳转"><a href="#第四步：构造虚假随机数跳转" class="headerlink" title="第四步：构造虚假随机数跳转"></a>第四步：构造虚假随机数跳转</h2><p><img src="/../img/OLLVM%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/%E9%9A%8F%E6%9C%BA4.png" alt="随机4"></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>RandomControlFlow.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/CommandLine.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/ValueMapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Cloning.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Module.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SplitBasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Intrinsics.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IntrinsicsX86.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RandomControlFlow.h&quot;</span></span></span><br><span class="line">using namespace llvm;</span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"><span class="type">static</span> cl::opt&lt;<span class="type">int</span>&gt;obfuTimes(<span class="string">&quot;rcf_loop&quot;</span>,cl::init(<span class="number">1</span>),cl::desc(<span class="string">&quot;Obfuscate a function &lt;bef_loop&gt;time(s).&quot;</span>));</span><br><span class="line">namespace&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RandomControlFlow</span>:</span> public FunctionPass&#123;</span><br><span class="line">        public:</span><br><span class="line">            <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">            RandomControlFlow():FunctionPass(ID)&#123;</span><br><span class="line">                srand(time(<span class="literal">NULL</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            Value* <span class="title function_">alterVal</span><span class="params">(Value *origVar,BasicBlock *insertAfter)</span>;</span><br><span class="line">            <span class="comment">//对随机变量进行恒等变换</span></span><br><span class="line">            <span class="type">bool</span> <span class="title function_">runOnFunction</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">insertRandomBranch</span><span class="params">(Value *randVar,BasicBlock *ifTrue,BasicBlock *ifFalse,BasicBlock *insertAfter)</span>;</span><br><span class="line">            <span class="comment">//插入随机跳转</span></span><br><span class="line">            <span class="type">bool</span> <span class="title function_">randcf</span><span class="params">(BasicBlock *entryBB)</span>;</span><br><span class="line">            <span class="comment">//对基本块进行混淆</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">RandomControlFlow::runOnFunction</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    INIT_CONTEXT(F);</span><br><span class="line">    FunctionPass *pass=createSplitBasicBlockPass();</span><br><span class="line">    pass-&gt;runOnFunction(F);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;obfuTimes;i++)&#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;BasicBlock*&gt;origBB;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock &amp;BB:F)&#123;</span><br><span class="line">            origBB.push_back(&amp;BB);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock *BB:origBB)&#123;</span><br><span class="line">            randcf(BB);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"><span class="comment">//以基本块为单位进行随机控制流混淆</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">RandomControlFlow::randcf</span><span class="params">(BasicBlock *entryBB)</span>&#123;</span><br><span class="line">    <span class="comment">//第一步 将基本块拆分</span></span><br><span class="line">    BasicBlock *bodyBB=entryBB-&gt;splitBasicBlock(entryBB-&gt;getFirstNonPHI(),<span class="string">&quot;bodyBB&quot;</span>);</span><br><span class="line">    <span class="comment">//拆分出bodyBB</span></span><br><span class="line">    BasicBlock *endBB=bodyBB-&gt;splitBasicBlock(bodyBB-&gt;getTerminator(),<span class="string">&quot;endBB&quot;</span>);</span><br><span class="line">    <span class="comment">//拆分出endBB</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二步,对基本块进行克隆,并且修复逃逸变量</span></span><br><span class="line">    BasicBlock *cloneBB=createCloneBasicBlock(bodyBB);</span><br><span class="line">    <span class="comment">//修复克隆产生的逃逸变量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//第三步,构建随机跳转</span></span><br><span class="line">    *entryBB-&gt;getTerminator()-&gt;eraseFromParent();</span><br><span class="line">    <span class="comment">//移除entryBB的终结指令</span></span><br><span class="line">    Function *randfunc=Intrinsic::getDeclaration(entryBB-&gt;getModule(),llvm::Intrinsic::x86_rdrand_32); </span><br><span class="line">    <span class="comment">//获取32位随机数</span></span><br><span class="line">    CallInst *callinst=CallInst::Create(randfunc-&gt;getFunctionType(),randfunc,<span class="string">&quot;&quot;</span>,entryBB);</span><br><span class="line">    <span class="comment">//创建call指令插入entryBB的尾部</span></span><br><span class="line">    Value *randVar=ExtractValueInst::Create(callinst,<span class="number">0</span>,<span class="string">&quot;&quot;</span>,entryBB);</span><br><span class="line">    <span class="comment">//将生成的随机数插入到 entryBB的尾部</span></span><br><span class="line">    insertRandomBranch(randVar,bodyBB,cloneBB,entryBB);</span><br><span class="line">    <span class="comment">//添加随机跳转</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//第四步 bodyBB和cloneBB添加随机跳转</span></span><br><span class="line">    bodyBB-&gt;getTerminator()-&gt;eraseFromParent();</span><br><span class="line">    <span class="comment">//移除bodyBB的终结指令</span></span><br><span class="line">    cloneBB-&gt;getTerminator()-&gt;eraseFromParent();</span><br><span class="line">    <span class="comment">//移除cloneBB的终结指令</span></span><br><span class="line">    insertRandomBranch(randVar,bodyBB,endBB,cloneBB);</span><br><span class="line">    <span class="comment">//添加cloneBB到endBB的指令，到bodyBB不执行</span></span><br><span class="line">    insertRandomBranch(randVar,endBB,cloneBB,bodyBB);</span><br><span class="line">    <span class="comment">//添加bodyBB到endBB的指令，到cloneBB不执行</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//插入随机跳转，随机数为randvar</span></span><br><span class="line"><span class="comment">//如果 randvar %2==1 就跳转到ifTrue  ，否则跳转到ifFalse;</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RandomControlFlow::insertRandomBranch</span><span class="params">(Value *randVar,BasicBlock *ifTrue,BasicBlock *ifFalse,BasicBlock *insertAfter)</span>&#123;</span><br><span class="line">    Value *alteredRandVar=alterVal(randVar,insertAfter);</span><br><span class="line">    <span class="comment">//对随机变量进行恒等变换</span></span><br><span class="line">    Value *randMod2=BinaryOperator::CreateURem(alteredRandVar,CONST_I32(<span class="number">2</span>),<span class="string">&quot;&quot;</span>,insertAfter);</span><br><span class="line">    <span class="comment">//对随机变量进行%2</span></span><br><span class="line">    CmpInst *cmp1=new ICmpInst(*insertAfter,ICmpInst::ICMP_EQ,randMod2,CONST_I32(<span class="number">0</span>),<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//判断结果</span></span><br><span class="line">    BranchInst *branch=BranchInst::Create(ifTrue,ifFalse,cmp1,insertAfter);</span><br><span class="line">    <span class="comment">//跳转</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对变量进行恒等变换</span></span><br><span class="line">Value* <span class="title function_">RandomControlFlow::alterVal</span><span class="params">(Value *startVar,BasicBlock *insertAfter)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> code = rand() % <span class="number">3</span>;</span><br><span class="line">  Value *result;</span><br><span class="line">  <span class="keyword">if</span> (code == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// x = x * (x + 1) - x^2</span></span><br><span class="line">    BinaryOperator *op1 = BinaryOperator::Create(Instruction::Add, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">1</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::Create(Instruction::Mul, startVar,</span><br><span class="line">                                                 op1, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op3 = BinaryOperator::Create(Instruction::Mul, startVar,</span><br><span class="line">                                                 startVar, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op4 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Sub, op2, op3, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    result = op4;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// x = 3 * x * (x - 2) - 3 * x^2 + 7 * x</span></span><br><span class="line">    BinaryOperator *op1 = BinaryOperator::Create(Instruction::Mul, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">3</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::Create(Instruction::Sub, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">2</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op3 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Mul, op1, op2, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op4 = BinaryOperator::Create(Instruction::Mul, startVar,</span><br><span class="line">                                                 startVar, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op5 = BinaryOperator::Create(Instruction::Mul, op4,</span><br><span class="line">                                                 CONST_I32(<span class="number">3</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op6 = BinaryOperator::Create(Instruction::Mul, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">7</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op7 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Sub, op3, op5, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op8 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Add, op6, op7, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    result = op8;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// x = (x - 1) * (x + 3) - (x + 4) * (x - 3) - 9</span></span><br><span class="line">    BinaryOperator *op1 = BinaryOperator::Create(Instruction::Sub, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">1</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::Create(Instruction::Add, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">3</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op3 = BinaryOperator::Create(Instruction::Add, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">4</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op4 = BinaryOperator::Create(Instruction::Sub, startVar,</span><br><span class="line">                                                 CONST_I32(<span class="number">3</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op5 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Mul, op1, op2, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op6 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Mul, op3, op4, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op7 =</span><br><span class="line">        BinaryOperator::Create(Instruction::Sub, op5, op6, <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    BinaryOperator *op8 = BinaryOperator::Create(Instruction::Sub, op7,</span><br><span class="line">                                                 CONST_I32(<span class="number">9</span>), <span class="string">&quot;&quot;</span>, insertAfter);</span><br><span class="line">    result = op8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">FunctionPass *<span class="title function_">llvm::createRandomControlFlow</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> new RandomControlFlow();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> RandomControlFlow::ID = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> RegisterPass&lt;RandomControlFlow&gt; <span class="title function_">X</span><span class="params">(<span class="string">&quot;rcf&quot;</span>,<span class="string">&quot;My Random control flow obfuscation&quot;</span>)</span>;</span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="/../img/OLLVM%E9%9A%8F%E6%9C%BA%E6%8E%A7%E5%88%B6%E6%B5%81/%E6%95%88%E6%9E%9C.png" alt="效果"></p><p>感觉混淆一次都已经很难看了，混淆两次更是一坨粑粑，强力混淆(๑•̀ㅂ•́)و✧</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OLLVM-随机控制流&quot;&gt;&lt;a href=&quot;#OLLVM-随机控制流&quot; class=&quot;headerlink&quot; title=&quot;OLLVM-随机控制流&quot;&gt;&lt;/a&gt;OLLVM-随机控制流&lt;/h1&gt;&lt;p&gt;感觉跟虚假控制流差不多，就是badyBB和cloneBB的定向跳转转</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>OLLVM-指令替代</title>
    <link href="https://straw-233.github.io/2024/03/18/OLLVM-%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/"/>
    <id>https://straw-233.github.io/2024/03/18/OLLVM-%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/</id>
    <published>2024-03-18T13:28:58.072Z</published>
    <updated>2024-03-18T13:38:29.142Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OLLVM-指令替代"><a href="#OLLVM-指令替代" class="headerlink" title="OLLVM-指令替代"></a>OLLVM-指令替代</h1><p>(建议结合代码后的注释食用!)</p><p>例如a+b&#x3D;a-(-b)，a^b&#x3D; ( ~ a&amp;b) | (a&amp; ~ b) 且仅支持整数</p><h2 id="加法替代"><a href="#加法替代" class="headerlink" title="加法替代"></a>加法替代</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%8C%87%E4%BB%A41.png" alt="指令1"></p><h2 id="减法替代"><a href="#减法替代" class="headerlink" title="减法替代"></a>减法替代</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%8C%87%E4%BB%A42.png" alt="指令2"></p><h2 id="与替换"><a href="#与替换" class="headerlink" title="与替换"></a>与替换</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%8C%87%E4%BB%A43.png" alt="指令3"></p><h2 id="或替换"><a href="#或替换" class="headerlink" title="或替换"></a>或替换</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%8C%87%E4%BB%A44.png" alt="指令4"></p><h2 id="异或替换"><a href="#异或替换" class="headerlink" title="异或替换"></a>异或替换</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%8C%87%E4%BB%A45.png" alt="指令5"></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>Substitution.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/CommandLine.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Local.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SplitBasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_ADD_SUBST 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_SUB_SUBST 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_AND_SUBST 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_OR_SUBST 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMBER_XOR_SUBST 2</span></span><br><span class="line">using namespace llvm;</span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"><span class="type">static</span> cl::opt&lt;<span class="type">int</span>&gt; <span class="title function_">obfuTimes</span><span class="params">(<span class="string">&quot;sub_loop&quot;</span>,cl::init(<span class="number">1</span>),cl::desc(<span class="string">&quot;Obfucase a function &lt;sub_loop&gt; time().&quot;</span>))</span>;</span><br><span class="line">namespace &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Substitution</span>:</span>public FunctionPass&#123;</span><br><span class="line">        public:</span><br><span class="line">        <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">        Substitution():FunctionPass(ID)&#123;</span><br><span class="line">            srand(time(<span class="literal">NULL</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">bool</span> <span class="title function_">runOnFunction</span><span class="params">(Function &amp;F)</span> ;</span><br><span class="line">        <span class="type">void</span> <span class="title function_">substitute</span><span class="params">(BinaryOperator *BI)</span>;</span><br><span class="line">        <span class="comment">// 替换 Add 指令</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">substituteAdd</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 加法替换：a = b + c -&gt; a = b - (-c)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">addNeg</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 加法替换：a = b + c -&gt; a = -(-b + (-c))</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">addDoubleNeg</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 加法替换：a = b + c -&gt; r = rand (); a = b + r; a = a + c; a = a - r</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">addRand</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 加法替换：a = b + c -&gt; r = rand (); a = b - r; a = a + b; a = a + r</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">addRand2</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 Sub 指令</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">substituteSub</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 减法替换：a = b - c -&gt; a = b + (-c)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">subNeg</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 减法替换：a = b - c -&gt; r = rand (); a = b + r; a = a - c; a = a - r</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">subRand</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 减法替换：a = b - c -&gt; a = b - r; a = a - c; a = a + r</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">subRand2</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 And 指令</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">substituteAnd</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 与替换：a = b &amp; c -&gt; a = (b ^ ~c) &amp; b</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">andSubstitute</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 与替换：a = b &amp; c -&gt; a = ~(~b | ~c) &amp; (r | ~r)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">andSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 Or 指令</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">substituteOr</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 或替换：a = b | c -&gt; a = (b &amp; c) | (b ^ c)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">orSubstitute</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 或替换：a = b | c -&gt; a = ~(~b &amp; ~c) &amp; (r | ~r)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">orSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 Xor 指令</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">substituteXor</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 异或替换：a = b ^ c -&gt; a = ~b &amp; c | b &amp; ~c</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">xorSubstitute</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">        <span class="comment">// 异或替换：a = b ^ c -&gt; (b ^ r) ^ (c ^ r) &lt;=&gt; (~b &amp; r | b &amp; ~r) ^ (~c &amp; r |</span></span><br><span class="line">        <span class="comment">// c &amp; ~r)</span></span><br><span class="line">        <span class="type">void</span> <span class="title function_">xorSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> ;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">Substitution::runOnFunction</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;obfuTimes;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock &amp;BB:F)&#123;</span><br><span class="line">            <span class="built_in">vector</span>&lt;Instruction*&gt;origInst;</span><br><span class="line">            <span class="keyword">for</span>(Instruction &amp;I:BB)&#123;</span><br><span class="line">                origInst.push_back(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(Instruction *I:origInst)&#123; <span class="comment">//遍历所有指令</span></span><br><span class="line">                <span class="keyword">if</span>(BinaryOperator *BI=dyn_cast&lt;BinaryOperator&gt;(I))&#123;</span><br><span class="line">                        substitute(BI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// if(isa&lt;BinaryOperator&gt;(I))&#123;</span></span><br><span class="line">                <span class="comment">//     BinaryOperator *BI=cast&lt;BinaryOperator&gt;(I);</span></span><br><span class="line">                <span class="comment">//     substitute(BI);</span></span><br><span class="line">                <span class="comment">// &#125;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substitute</span><span class="params">(BinaryOperator *BI)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (BI-&gt;getOpcode())</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> BinaryOperator::Add:</span><br><span class="line">        substituteAdd(BI);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BinaryOperator::Sub:</span><br><span class="line">        substituteSub(BI);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BinaryOperator::Xor:</span><br><span class="line">        substituteXor(BI);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BinaryOperator::And:</span><br><span class="line">        substituteAnd(BI);</span><br><span class="line">    <span class="keyword">case</span> BinaryOperator::Or:</span><br><span class="line">        substituteOr(BI);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//选择替换类型</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substituteAdd</span><span class="params">(BinaryOperator *BI)</span>&#123;</span><br><span class="line">    <span class="type">int</span> choice=rand()%NUMBER_ADD_SUBST;</span><br><span class="line">    <span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            addNeg(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            addDoubleNeg(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            addRand(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            addRand2(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 加法替换：a = b + c -&gt; a = b - (-c)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::addNeg</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNeg(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-c</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateSub(BI-&gt;getOperand(<span class="number">0</span>),opt1,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b-(-c)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 加法替换：a = b + c -&gt; a = -(-b + (-c))</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::addDoubleNeg</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *op1 = BinaryOperator::CreateNeg(BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-b</span></span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::CreateNeg(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-c</span></span><br><span class="line">    BinaryOperator *op3 = BinaryOperator::CreateAdd(op1, op2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-b+(-c)</span></span><br><span class="line">    BinaryOperator *op = BinaryOperator::CreateNeg(op3,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-(-b+(-c))</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(op);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 加法替换：a = b + c -&gt; r = rand (); a = b + r; a = a + c; a = a - r</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::addRand</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r =(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator * op1 = BinaryOperator::CreateAdd(BI-&gt;getOperand(<span class="number">0</span>), r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b+r</span></span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::CreateAdd(op1, BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b+r)+c</span></span><br><span class="line">    BinaryOperator *op = BinaryOperator::CreateSub(op2, r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//((b+r)+c)-r</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(op);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 加法替换：a = b + c -&gt; r = rand (); a = b - r; a = a + c; a = a + r</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::addRand2</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r =(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator * op1 = BinaryOperator::CreateSub(BI-&gt;getOperand(<span class="number">0</span>), r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b-r</span></span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::CreateAdd(op1, BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b-r)+c</span></span><br><span class="line">    BinaryOperator *op = BinaryOperator::CreateAdd(op2, r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//((b-r)+c)+r</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(op);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 替换 Sub 指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substituteSub</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">        <span class="type">int</span> choice=rand()%NUMBER_SUB_SUBST;</span><br><span class="line">    <span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            subNeg(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            subRand(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            subRand2(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 减法替换：a = b - c -&gt; a = b + (-c)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::subNeg</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNeg(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//-c</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateAdd(BI-&gt;getOperand(<span class="number">0</span>),opt1,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b+(-c)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 减法替换：a = b - c -&gt; r = rand (); a = b + r; a = a - c; a = a - r</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::subRand</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r =(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator * op1 = BinaryOperator::CreateAdd(BI-&gt;getOperand(<span class="number">0</span>), r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b+r</span></span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::CreateSub(op1, BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b+r)-c</span></span><br><span class="line">    BinaryOperator *op = BinaryOperator::CreateSub(op2, r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//((b+r)-c)-r</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(op);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 减法替换：a = b - c -&gt; a = b - r; a = a - c; a = a + r</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::subRand2</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r =(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator * op1 = BinaryOperator::CreateSub(BI-&gt;getOperand(<span class="number">0</span>), r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b-r</span></span><br><span class="line">    BinaryOperator *op2 = BinaryOperator::CreateSub(op1, BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b-r)-c</span></span><br><span class="line">    BinaryOperator *op = BinaryOperator::CreateAdd(op2, r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//((b-r)-c)+r</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(op);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 替换 And 指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substituteAnd</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    <span class="type">int</span> choice=rand()%NUMBER_AND_SUBST;</span><br><span class="line">    <span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            andSubstitute(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            andSubstituteRand(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 与替换：a = b &amp; c -&gt; a = (b ^ ~c) &amp; b</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::andSubstitute</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~c</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateXor(BI-&gt;getOperand(<span class="number">0</span>),opt1,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b^~c</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateAnd(BI-&gt;getOperand(<span class="number">0</span>),opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b^~c)&amp;b</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 与替换：a = b &amp; c -&gt; a = ~(~b | ~c) &amp; (r | ~r)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::andSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r=(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~c</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateOr(opt1,opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b | ~c</span></span><br><span class="line">    BinaryOperator *opt4=BinaryOperator::CreateNot(opt3,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~(~b | ~c)</span></span><br><span class="line">    BinaryOperator *opt5=BinaryOperator::CreateNot(r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~r</span></span><br><span class="line">    BinaryOperator *opt6=BinaryOperator::CreateOr(r,opt5,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//r | ~r</span></span><br><span class="line">    BinaryOperator *opt7=BinaryOperator::CreateAnd(opt6,opt4,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~(~b | ~c)&amp;(r | ~r)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt7);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换 Or 指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substituteOr</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    <span class="type">int</span> choice=rand()%NUMBER_OR_SUBST;</span><br><span class="line">    <span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            orSubstitute(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            orSubstituteRand(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或替换：a = b | c -&gt; a = (b &amp; c) | (b ^ c)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::orSubstitute</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateAnd(BI-&gt;getOperand(<span class="number">0</span>),BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b&amp;c</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateXor(BI-&gt;getOperand(<span class="number">0</span>),BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b^c</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateOr(opt1,opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(b&amp;c)|(b^c)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或替换：a = b | c -&gt; a = ~(~b &amp; ~c) &amp; (r | ~r)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::orSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r=(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~c</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateAnd(opt1,opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b&amp;~c</span></span><br><span class="line">    BinaryOperator *opt4=BinaryOperator::CreateNot(opt3,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~(~b&amp;~c)</span></span><br><span class="line">    BinaryOperator *opt5=BinaryOperator::CreateNot(r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~r</span></span><br><span class="line">    BinaryOperator *opt6=BinaryOperator::CreateOr(r,opt5,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//r|~r</span></span><br><span class="line">    BinaryOperator *opt7=BinaryOperator::CreateAnd(opt6,opt4,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~(~b &amp; ~c) &amp; (r | ~r)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt7);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换 Xor 指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::substituteXor</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    <span class="type">int</span> choice=rand()%NUMBER_XOR_SUBST;</span><br><span class="line">    <span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            xorSubstitute(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            xorSubstituteRand(BI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 异或替换：a = b ^ c -&gt; a = ~b &amp; c | b &amp; ~c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::xorSubstitute</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~c</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateAnd(BI-&gt;getOperand(<span class="number">1</span>),opt1,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b&amp;~c</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b</span></span><br><span class="line">    BinaryOperator *opt4=BinaryOperator::CreateAnd(BI-&gt;getOperand(<span class="number">0</span>),opt3,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b&amp;c</span></span><br><span class="line">    BinaryOperator *opt5=BinaryOperator::CreateOr(opt4,opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b&amp;c|b&amp;~c</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt5);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 异或替换：a = b ^ c -&gt; (b ^ r) ^ (c ^ r) &lt;=&gt; (~b &amp; r | b &amp; ~r) ^ (~c &amp; r | c &amp; ~r)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Substitution::xorSubstituteRand</span><span class="params">(BinaryOperator *BI)</span> &#123;</span><br><span class="line">    ConstantInt *r=(ConstantInt*)CONST(BI-&gt;getType(),rand());</span><br><span class="line">    <span class="comment">//r</span></span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b</span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateAnd(r,opt1,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b&amp;r</span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateNot(r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~r</span></span><br><span class="line">    BinaryOperator *opt4=BinaryOperator::CreateAnd(opt3,BI-&gt;getOperand(<span class="number">0</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//b&amp;~r</span></span><br><span class="line">    BinaryOperator *opt5=BinaryOperator::CreateOr(opt4,opt2,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//~b&amp;r|b&amp;r</span></span><br><span class="line">    BinaryOperator *opt6=BinaryOperator::CreateNot(BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    BinaryOperator *opt7=BinaryOperator::CreateAnd(r,opt6,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    BinaryOperator *opt8=BinaryOperator::CreateNot(r,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    BinaryOperator *opt9=BinaryOperator::CreateAnd(opt8,BI-&gt;getOperand(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    BinaryOperator *opt10=BinaryOperator::CreateOr(opt7,opt9,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    BinaryOperator *opt11=BinaryOperator::CreateXor(opt10,opt5,<span class="string">&quot;&quot;</span>,BI);</span><br><span class="line">    <span class="comment">//(~b&amp;r|b&amp;~r)^(~c&amp;r|c&amp;~r)</span></span><br><span class="line">    BI-&gt;replaceAllUsesWith(opt11);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> Substitution::ID=<span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> RegisterPass&lt;Substitution&gt; <span class="title function_">X</span><span class="params">(<span class="string">&quot;sub&quot;</span>,<span class="string">&quot;Replace a operator with equivalent instructions&quot;</span>)</span>; </span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="/../img/OLLVM%E6%8C%87%E4%BB%A4%E6%9B%BF%E4%BB%A3/%E6%95%88%E6%9E%9C.png" alt="效果"></p><p>感觉就汇编多了点东西，伪代码直接被ida修正了，可能是源文件的问题。。。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OLLVM-指令替代&quot;&gt;&lt;a href=&quot;#OLLVM-指令替代&quot; class=&quot;headerlink&quot; title=&quot;OLLVM-指令替代&quot;&gt;&lt;/a&gt;OLLVM-指令替代&lt;/h1&gt;&lt;p&gt;(建议结合代码后的注释食用!)&lt;/p&gt;
&lt;p&gt;例如a+b&amp;#x3D;a-(-</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>OLLVM-虚假控制流</title>
    <link href="https://straw-233.github.io/2024/03/17/OLLVM-%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/"/>
    <id>https://straw-233.github.io/2024/03/17/OLLVM-%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/</id>
    <published>2024-03-17T11:41:18.729Z</published>
    <updated>2024-03-17T11:46:47.153Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OLLVM-虚假控制流"><a href="#OLLVM-虚假控制流" class="headerlink" title="OLLVM-虚假控制流"></a>OLLVM-虚假控制流</h1><p>建议结合代码后的注释食用！</p><p><img src="/../img/%E6%81%B6%E5%BF%83%E6%A3%89.gif" alt="恶心棉"></p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/%E8%99%9A%E6%8E%A70.png" alt="虚控0"></p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="第一步：基本块拆分"><a href="#第一步：基本块拆分" class="headerlink" title="第一步：基本块拆分"></a>第一步：基本块拆分</h3><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/%E8%99%9A%E6%8E%A71.png" alt="虚控1"></p><h3 id="第二步：基本块克隆"><a href="#第二步：基本块克隆" class="headerlink" title="第二步：基本块克隆"></a>第二步：基本块克隆</h3><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/%E8%99%9A%E6%8E%A72.png" alt="虚控2"></p><h3 id="第三步：构造虚假跳转"><a href="#第三步：构造虚假跳转" class="headerlink" title="第三步：构造虚假跳转"></a>第三步：构造虚假跳转</h3><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/%E8%99%9A%E6%8E%A73.png" alt="虚控3"></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>BogusControlFlow.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/CommandLine.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/ValueMapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Cloning.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Module.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SplitBasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span> </span></span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>; </span><br><span class="line">using namespace llvm;</span><br><span class="line"><span class="comment">//混淆次数</span></span><br><span class="line"><span class="type">static</span> cl::opt&lt;<span class="type">int</span>&gt; <span class="title function_">obfuTimes</span><span class="params">(<span class="string">&quot;bcf_loop&quot;</span>,cl::init(<span class="number">1</span>),cl::desc(<span class="string">&quot;Obfucase a function &lt;bcf_loop&gt; time().&quot;</span>))</span>;</span><br><span class="line">namespace&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BogusControlFlow</span> :</span> public FunctionPass&#123;</span><br><span class="line">        public:</span><br><span class="line">            <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">            BogusControlFlow():FunctionPass(ID)&#123;</span><br><span class="line">                srand(time(<span class="literal">NULL</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">bool</span> <span class="title function_">runOnFunction</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">bogus</span><span class="params">(BasicBlock *BB)</span>;</span><br><span class="line">            Value * <span class="title function_">createBogusCmp</span><span class="params">(BasicBlock *insertAfter)</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">BogusControlFlow::runOnFunction</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    INIT_CONTEXT(F);</span><br><span class="line">    FunctionPass *pass =createSplitBasicBlockPass();</span><br><span class="line">    pass-&gt;runOnFunction(F);</span><br><span class="line">     <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;obfuTimes;i++)&#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;BasicBlock*&gt; origBB;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock&amp; BB:F)&#123;</span><br><span class="line">            origBB.push_back(&amp;BB);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock *BB:origBB)&#123;</span><br><span class="line">            bogus(BB);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">Value *<span class="title function_">BogusControlFlow::createBogusCmp</span><span class="params">(BasicBlock * insertAfter)</span>&#123;</span><br><span class="line">    <span class="comment">//构建虚假跳转</span></span><br><span class="line">    Module *M=insertAfter-&gt;getModule();</span><br><span class="line">    GlobalVariable *xptr= new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::CommonLinkage,CONST_I32(<span class="number">0</span>),<span class="string">&quot;x&quot;</span>);  </span><br><span class="line">    <span class="comment">//设置 x 初始值为 0;</span></span><br><span class="line">    GlobalVariable *yptr= new GlobalVariable(*M,TYPE_I32,<span class="literal">false</span>,GlobalValue::CommonLinkage,CONST_I32(<span class="number">0</span>),<span class="string">&quot;y&quot;</span>);  </span><br><span class="line">    <span class="comment">//设置 y 初始值为 0;</span></span><br><span class="line">    LoadInst *x=new LoadInst(TYPE_I32,xptr,<span class="string">&quot;&quot;</span>,insertAfter); </span><br><span class="line">    <span class="comment">//全局变量不能直接使用，用load来读取</span></span><br><span class="line">    LoadInst *y=new LoadInst(TYPE_I32,yptr,<span class="string">&quot;&quot;</span>,insertAfter); </span><br><span class="line">    ICmpInst *cmp1=new ICmpInst(*insertAfter,CmpInst::ICMP_SLT,y,CONST_I32(<span class="number">10</span>));<span class="comment">//y&lt;10</span></span><br><span class="line">    BinaryOperator *opt1=BinaryOperator::CreateAdd(x,CONST_I32(<span class="number">1</span>),<span class="string">&quot;&quot;</span>,insertAfter);<span class="comment">//x+1   </span></span><br><span class="line">    BinaryOperator *opt2=BinaryOperator::CreateMul(x,opt1,<span class="string">&quot;&quot;</span>,insertAfter); <span class="comment">//x*(x+1)  </span></span><br><span class="line">    BinaryOperator *opt3=BinaryOperator::CreateSRem(opt2,CONST_I32(<span class="number">2</span>),<span class="string">&quot;&quot;</span>,insertAfter);<span class="comment">//x*(x+1)%2   </span></span><br><span class="line">    ICmpInst *cmp2=new ICmpInst(*insertAfter,CmpInst::ICMP_EQ,opt3,CONST_I32(<span class="number">0</span>));<span class="comment">//x*(x+1)%2==0</span></span><br><span class="line">    <span class="keyword">return</span> BinaryOperator::CreateOr(cmp1,cmp2,<span class="string">&quot;&quot;</span>,insertAfter);</span><br><span class="line">    <span class="comment">//创建了if((y&lt;10||x*(x+1)%2==0)) 等价于if(true)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">BogusControlFlow::bogus</span><span class="params">(BasicBlock *entryBB)</span>&#123;</span><br><span class="line">    <span class="comment">//第一步，将基本快拆分成entryBB,bodyBB,endBB</span></span><br><span class="line">    BasicBlock *bodyBB=entryBB-&gt;splitBasicBlock(entryBB-&gt;getFirstNonPHI(),<span class="string">&quot;BodyBB&quot;</span>);</span><br><span class="line">    BasicBlock *endBB=bodyBB-&gt;splitBasicBlock(bodyBB-&gt;getTerminator(),<span class="string">&quot;endBB&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二步，对中间的基本块 BodyBB 进行克隆，得到cloneBB</span></span><br><span class="line">    BasicBlock *cloneBB=createCloneBasicBlock(bodyBB);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第三部 构建虚假跳转</span></span><br><span class="line">    <span class="comment">//1.将entryBB,bodyBB,cloneBB末尾的绝对跳转移除</span></span><br><span class="line">    entryBB-&gt;getTerminator()-&gt;eraseFromParent();    </span><br><span class="line">    bodyBB-&gt;getTerminator()-&gt;eraseFromParent();    </span><br><span class="line">    cloneBB-&gt;getTerminator()-&gt;eraseFromParent();</span><br><span class="line">    <span class="comment">//2.在entryBB和bodyBB的末尾插入条件恒为真的虚假比较指令</span></span><br><span class="line">    Value *cond1 =createBogusCmp(entryBB);</span><br><span class="line">    Value *cond2 =createBogusCmp(bodyBB); </span><br><span class="line">    <span class="comment">//3.将entryBB到bodyBB的绝对跳转改为条件跳转</span></span><br><span class="line">    BranchInst::Create(bodyBB,cloneBB,cond1,entryBB);</span><br><span class="line">    <span class="comment">//4.将bodyBB到endBB的绝对跳转改为条件跳转</span></span><br><span class="line">    BranchInst::Create(endBB,cloneBB,cond2,bodyBB);</span><br><span class="line">    <span class="comment">//5.添加bodyBB.clone到bodyBB的绝对跳转</span></span><br><span class="line">    BranchInst::Create(bodyBB,cloneBB);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> BogusControlFlow::ID=<span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> RegisterPass&lt;BogusControlFlow&gt; <span class="title function_">X</span><span class="params">(<span class="string">&quot;bcf&quot;</span>,<span class="string">&quot;My control bogus control flattening obfuscation&quot;</span>)</span>;</span><br><span class="line"><span class="comment">//向LLVM注册我们的pass    其中X()中的第一个参数是指定LLVM Pass的参数 ，这样再使用opt加载这个so文件的时候，用这个参数来指定用哪个Pass来优化，第二个参数就是对Pass的描述。</span></span><br></pre></td></tr></table></figure><p>Utils.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Local.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/ValueMapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Cloning.h&quot;</span></span></span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line">using namespace llvm;</span><br><span class="line">LLVMContext *CONTEXT=nullptr;</span><br><span class="line"><span class="comment">//第五步 修复PHI指令和逃逸变量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">llvm::fixStack</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;PHINode*&gt; origPHI;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Instruction*&gt; origReg;</span><br><span class="line">    BasicBlock &amp;entryBB=F.getEntryBlock();</span><br><span class="line">    <span class="keyword">for</span>(BasicBlock &amp;BB:F)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Instruction &amp;I:BB)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(PHINode *PN=dyn_cast&lt;PHINode&gt;(&amp;I))&#123;</span><br><span class="line">                origPHI.push_back(PN);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!(isa&lt;AllocaInst&gt;(&amp;I)&amp;&amp; I.getParent()==&amp;entryBB)&amp;&amp; I.isUsedOutsideOfBlock(&amp;BB))&#123;<span class="comment">//判断是不是逃逸变量(除了通过Alloc，并且定义在入口块的，都要处理)</span></span><br><span class="line">                origReg.push_back(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(PHINode *PN:origPHI)&#123;</span><br><span class="line">        DemotePHIToStack(PN,entryBB.getTerminator());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(Instruction *I:origReg)&#123;</span><br><span class="line">        DemoteRegToStack(*I,entryBB.getTerminator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基本块克隆</span></span><br><span class="line">BasicBlock * <span class="title function_">llvm::createCloneBasicBlock</span><span class="params">(BasicBlock *BB)</span>&#123;</span><br><span class="line">    <span class="comment">//修复逃逸变量</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Instruction*&gt; origReg;</span><br><span class="line">    BasicBlock &amp;entryBB=BB-&gt;getParent()-&gt;getEntryBlock();</span><br><span class="line">        <span class="keyword">for</span> (Instruction &amp;I:*BB)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!(isa&lt;AllocaInst&gt;(&amp;I)&amp;&amp; I.getParent()==&amp;entryBB)&amp;&amp; I.isUsedOutsideOfBlock(BB))&#123;<span class="comment">//判断是不是逃逸变量(除了通过Alloc，并且定义在入口块的，都要处理)</span></span><br><span class="line">                origReg.push_back(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">for</span>(Instruction *I:origReg)&#123;</span><br><span class="line">        DemoteRegToStack(*I,entryBB.getTerminator());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ValueToValueMapTy VMap;  <span class="comment">//变量的映射表</span></span><br><span class="line">    BasicBlock *cloneBB=CloneBasicBlock(BB,VMap,<span class="string">&quot;cloneBB&quot;</span>,BB-&gt;getParent());</span><br><span class="line">    <span class="keyword">for</span>(Instruction &amp;I:*cloneBB)&#123;  </span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;I.getNumOperands();i++)&#123; <span class="comment">//遍历操作数不能用for:each ，要用for循环</span></span><br><span class="line">            Value *V=MapValue(I.getOperand(i),VMap);</span><br><span class="line">            <span class="keyword">if</span>(V)&#123;<span class="comment">//判断映射是否成功</span></span><br><span class="line">                I.setOperand(i,V);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cloneBB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opt -load ../Build/LLVMObfuscator.so -bcf -S -enable-new-pm=0 IR/TestProgram.ll -o IR/TestProgram_bcf.ll</span><br><span class="line"># opt -load ../Build/LLVMObfuscator.so -bcf -bcf_loop 2 -S -enable-new-pm=0 IR/TestProgram.ll -o IR/TestProgram_bcf.ll</span><br><span class="line">#多次混淆</span><br><span class="line">clang  IR/TestProgram_bcf.ll -o Bin/TestProgram_bcf</span><br></pre></td></tr></table></figure><p>用以下指令将其进行编译</p><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/dm1.png" alt="dm1"></p><p>得到一个还行的173行的代码，用D810跑一下还能看</p><p>再试着进行混淆2次</p><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/dm2.png" alt="dm2"></p><p>已经变成了一坨763行代码的粑粑，比一次混淆的文件大了一倍（感觉真实情况不会这么搞，太冗长了）</p><p>欣赏一下流程图（）</p><p><img src="/../img/OLLVM%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81/pic.png" alt="pic"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OLLVM-虚假控制流&quot;&gt;&lt;a href=&quot;#OLLVM-虚假控制流&quot; class=&quot;headerlink&quot; title=&quot;OLLVM-虚假控制流&quot;&gt;&lt;/a&gt;OLLVM-虚假控制流&lt;/h1&gt;&lt;p&gt;建议结合代码后的注释食用！&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/..</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>OLLVM-控制流平坦化</title>
    <link href="https://straw-233.github.io/2024/03/15/OLLVM-%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/"/>
    <id>https://straw-233.github.io/2024/03/15/OLLVM-%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/</id>
    <published>2024-03-15T13:06:43.121Z</published>
    <updated>2024-03-15T13:13:29.829Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OLLVM-控制流平坦化"><a href="#OLLVM-控制流平坦化" class="headerlink" title="OLLVM-控制流平坦化"></a>OLLVM-控制流平坦化</h1><p>建议结合代码后的注释食用！</p><p><img src="/../img/%E7%82%B8%E6%AF%9B%E8%8A%99.jpg" alt="炸毛芙"></p><h4 id="第一步：保存基本块"><a href="#第一步：保存基本块" class="headerlink" title="第一步：保存基本块"></a>第一步：保存基本块</h4><p><img src="/../img/OLLVM%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/%E6%8E%A7%E5%88%B6%E6%B5%811.png" alt="控制流1"></p><h4 id="第二步：创建分发块和返回块"><a href="#第二步：创建分发块和返回块" class="headerlink" title="第二步：创建分发块和返回块"></a>第二步：创建分发块和返回块</h4><p><img src="/../img/OLLVM%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/%E6%8E%A7%E5%88%B6%E6%B5%812.png" alt="控制流2"></p><h4 id="第三步：实现分发块调度"><a href="#第三步：实现分发块调度" class="headerlink" title="第三步：实现分发块调度"></a>第三步：实现分发块调度</h4><p><img src="/../img/OLLVM%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/%E6%8E%A7%E5%88%B6%E6%B5%813.png" alt="控制流3"></p><h4 id="第四步：实现调度变量的自动调整"><a href="#第四步：实现调度变量的自动调整" class="headerlink" title="第四步：实现调度变量的自动调整"></a>第四步：实现调度变量的自动调整</h4><p><img src="/../img/OLLVM%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/%E6%8E%A7%E5%88%B6%E6%B5%814.png" alt="控制流4"></p><h4 id="第五步：修复PHI指令和逃逸变量"><a href="#第五步：修复PHI指令和逃逸变量" class="headerlink" title="第五步：修复PHI指令和逃逸变量"></a>第五步：修复PHI指令和逃逸变量</h4><p><img src="/../img/OLLVM%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/%E6%8E%A7%E5%88%B6%E6%B5%815.png" alt="控制流5"></p><h4 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4><p>FLattening.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/CommandLine.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Local.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SplitBasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line">using namespace llvm;</span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line">namespace&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Flattening</span> :</span>public FunctionPass&#123;</span><br><span class="line">        public :</span><br><span class="line">            <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">            </span><br><span class="line">            Flattening():FunctionPass(ID)&#123;</span><br><span class="line">                srand(time(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">void</span> <span class="title function_">flatten</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line">            <span class="type">bool</span> <span class="title function_">runOnFunction</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">Flattening::runOnFunction</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    INIT_CONTEXT(F);</span><br><span class="line">    FunctionPass * pass =createSplitBasicBlockPass();</span><br><span class="line">    pass-&gt;runOnFunction(F);</span><br><span class="line">    flatten(F);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Flattening::flatten</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    <span class="comment">//第一步,保存除了入口块的基本块</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;BasicBlock*&gt; origBB;<span class="comment">//创建一个容器</span></span><br><span class="line">    <span class="keyword">for</span>(BasicBlock&amp; BB:F)&#123;</span><br><span class="line">        origBB.push_back(&amp;BB);</span><br><span class="line">    &#125;<span class="comment">//保存所有基本快</span></span><br><span class="line">    origBB.erase(origBB.begin());<span class="comment">//移除第一个基本块</span></span><br><span class="line">    BasicBlock &amp;entryBlock=F.getEntryBlock();<span class="comment">//获取入口块</span></span><br><span class="line">    <span class="keyword">if</span>(BranchInst *br=dyn_cast&lt;BranchInst&gt;(entryBlock.getTerminator()))&#123;</span><br><span class="line">        <span class="keyword">if</span>(br-&gt;isConditional())&#123;<span class="comment">//判断是不是条件跳转</span></span><br><span class="line">            origBB.insert(origBB.begin(),entryBlock.splitBasicBlock(br));<span class="comment">//是条件跳转，单独拎出来作为新的基本块</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第二步，创建分发块和返回块</span></span><br><span class="line">    BasicBlock *dispatchBB=BasicBlock::Create(*CONTEXT,<span class="string">&quot;dispatchBB&quot;</span>,&amp;F,&amp;entryBlock);<span class="comment">//创建分发块</span></span><br><span class="line">    BasicBlock *retBB=BasicBlock::Create(*CONTEXT,<span class="string">&quot;retBB&quot;</span>,&amp;F,&amp;entryBlock);<span class="comment">//创建返回块</span></span><br><span class="line">    entryBlock.moveBefore(dispatchBB);<span class="comment">//移动入口块到最前面</span></span><br><span class="line">    entryBlock.getTerminator()-&gt;eraseFromParent();<span class="comment">//踢掉入口块原来的跳转</span></span><br><span class="line">    BranchInst::Create(dispatchBB,&amp;entryBlock);<span class="comment">//入口块绝对跳转到分发快</span></span><br><span class="line">    BranchInst::Create(dispatchBB,retBB);<span class="comment">//返回块到分发块</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//第三部，实现分发块的调度功能</span></span><br><span class="line">    <span class="type">int</span> randNumcase=rand();<span class="comment">//rand参数</span></span><br><span class="line">    AllocaInst * swVarPtr =new AllocaInst(TYPE_I32,<span class="number">0</span>,<span class="string">&quot;swVar.ptr&quot;</span>,entryBlock.getTerminator());<span class="comment">//入口块创建alloca指令，插入到入口块终结指令前</span></span><br><span class="line">    new StoreInst(CONST_I32(randNumcase),swVarPtr,entryBlock.getTerminator());<span class="comment">//对switch变量进行初始化</span></span><br><span class="line">    LoadInst *swVar=new LoadInst(TYPE_I32,swVarPtr,<span class="string">&quot;swVAR&quot;</span>,dispatchBB);<span class="comment">//添加switch指令</span></span><br><span class="line">    BasicBlock *defaultBB = BasicBlock::Create(*CONTEXT,<span class="string">&quot;defaultBB&quot;</span>,&amp;F,retBB);<span class="comment">//创建一个返回块前的基本块</span></span><br><span class="line">    BranchInst::Create(retBB,defaultBB);  <span class="comment">//基本块肯定要有一条终结指令，所以这里随便添加一条跳转指令</span></span><br><span class="line">    SwitchInst *swInst=SwitchInst::Create(swVar,defaultBB,<span class="number">0</span>,dispatchBB);<span class="comment">//插入到分发块的后面</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//为每个基本块分配随机的case值</span></span><br><span class="line">    <span class="keyword">for</span>(BasicBlock *BB:origBB)&#123;</span><br><span class="line">        BB-&gt;moveBefore(retBB);<span class="comment">//移动到返回块前面</span></span><br><span class="line">        swInst-&gt;addCase(CONST_I32(randNumcase),BB);<span class="comment">//保存随机数</span></span><br><span class="line">        randNumcase=rand();<span class="comment">//重新生成随机数</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第四步 实现调度变量自动调整</span></span><br><span class="line">    <span class="keyword">for</span>(BasicBlock *BB:origBB)&#123;</span><br><span class="line">        <span class="keyword">if</span>(BB-&gt;getTerminator()-&gt;getNumSuccessors()==<span class="number">0</span>)&#123;<span class="comment">//如果这个基本块的最后一条指令是返回指令(没有后继快)</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(BB-&gt;getTerminator()-&gt;getNumSuccessors()==<span class="number">1</span>)&#123;<span class="comment">//如果这个基本块还有一个后继块(即为绝对跳转) </span></span><br><span class="line">            ConstantInt *numcase = swInst-&gt;findCaseDest(BB-&gt;getTerminator()-&gt;getSuccessor(<span class="number">0</span>));<span class="comment">//找到对应的case值</span></span><br><span class="line">            new StoreInst(numcase,swVarPtr,BB-&gt;getTerminator());<span class="comment">//修改swicth中的参数，修改为对应case</span></span><br><span class="line">            BB-&gt;getTerminator()-&gt;eraseFromParent();<span class="comment">//原先的跳转删除</span></span><br><span class="line">            BranchInst::Create(retBB,BB);<span class="comment">//添加跳转</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(BB-&gt;getTerminator()-&gt;getNumSuccessors()==<span class="number">2</span>)&#123; <span class="comment">//有两个后继块</span></span><br><span class="line">             ConstantInt *numcase1 = swInst-&gt;findCaseDest(BB-&gt;getTerminator()-&gt;getSuccessor(<span class="number">0</span>));</span><br><span class="line">             ConstantInt *numcase2 = swInst-&gt;findCaseDest(BB-&gt;getTerminator()-&gt;getSuccessor(<span class="number">1</span>));<span class="comment">//全找了</span></span><br><span class="line">             BranchInst *br1=cast&lt;BranchInst&gt;(BB-&gt;getTerminator()); <span class="comment">//两个分支也有可能是switch指令，但是在混淆前，使用LLVM IR指令 (使用自带的 LowerSwitch的LLVM Pass)，将switch替换成了branch，所以这里最后一条指令只能是branch</span></span><br><span class="line">             SelectInst *sel=SelectInst::Create(br1-&gt;getCondition(),numcase1,numcase2,<span class="string">&quot;&quot;</span>,BB-&gt;getTerminator());<span class="comment">//三元运算符，找到对应的case</span></span><br><span class="line">             new StoreInst(sel,swVarPtr,BB-&gt;getTerminator());<span class="comment">//保存在switch变量</span></span><br><span class="line">            BB-&gt;getTerminator()-&gt;eraseFromParent(); <span class="comment">//原先的跳转删除</span></span><br><span class="line">             BranchInst::Create(retBB,BB);<span class="comment">//添加</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第五步 修复 phi指令和逃逸变量</span></span><br><span class="line">    fixStack(F);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> Flattening::ID=<span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> RegisterPass&lt;Flattening&gt;X(<span class="string">&quot;fla&quot;</span>,<span class="string">&quot;My control flow flattening obfuscation&quot;</span>);</span><br></pre></td></tr></table></figure><p>Utils.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Instructions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Local.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/ValueMapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/Cloning.h&quot;</span></span></span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line">using namespace llvm;</span><br><span class="line">LLVMContext *CONTEXT=nullptr;</span><br><span class="line"><span class="comment">//第五步 修复PHI指令和逃逸变量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">llvm::fixStack</span><span class="params">(Function &amp;F)</span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;PHINode*&gt; origPHI;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Instruction*&gt; origReg;</span><br><span class="line">    BasicBlock &amp;entryBB=F.getEntryBlock();</span><br><span class="line">    <span class="keyword">for</span>(BasicBlock &amp;BB:F)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Instruction &amp;I:BB)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(PHINode *PN=dyn_cast&lt;PHINode&gt;(&amp;I))&#123;</span><br><span class="line">                origPHI.push_back(PN);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!(isa&lt;AllocaInst&gt;(&amp;I)&amp;&amp; I.getParent()==&amp;entryBB)&amp;&amp; I.isUsedOutsideOfBlock(&amp;BB))&#123;<span class="comment">//判断是不是逃逸变量(除了通过Alloc，并且定义在入口块的，都要处理)</span></span><br><span class="line">                origReg.push_back(&amp;I);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(PHINode *PN:origPHI)&#123;</span><br><span class="line">        DemotePHIToStack(PN,entryBB.getTerminator());<span class="comment">//修复PHI指令</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(Instruction *I:origReg)&#123;</span><br><span class="line">        DemoteRegToStack(*I,entryBB.getTerminator());<span class="comment">//修复逃逸变量</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Utils.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _UTILS_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _UTILS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CONTEXT(X) CONTEXT = &amp;X.getContext()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TYPE_I64 Type::getInt64Ty(*CONTEXT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TYPE_I32 Type::getInt32Ty(*CONTEXT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TYPE_I8 Type::getInt8Ty(*CONTEXT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_TYPE(X) TYPE::getInt(X) Ty(*CONTEXT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONST_I64(V) ConstantInt::get(TYPE_I64, V, false)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONST_I32(V) ConstantInt::get(TYPE_I32, V, false)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONST_I8(V) ConstantInt::get(TYPE_I8, V, false)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONST(T, V) ConstantInt::get(T, V)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RANDOM(X) (cryptoutils-&gt;get_uint8_t() % 100 &lt; X)</span></span><br><span class="line"><span class="keyword">extern</span> llvm::LLVMContext *CONTEXT;</span><br><span class="line"></span><br><span class="line">namespace llvm&#123;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">fixStack</span><span class="params">(Function &amp;F)</span>;</span><br><span class="line">    BasicBlock* <span class="title function_">createCloneBasicBlock</span><span class="params">(BasicBlock *BB)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OLLVM-控制流平坦化&quot;&gt;&lt;a href=&quot;#OLLVM-控制流平坦化&quot; class=&quot;headerlink&quot; title=&quot;OLLVM-控制流平坦化&quot;&gt;&lt;/a&gt;OLLVM-控制流平坦化&lt;/h1&gt;&lt;p&gt;建议结合代码后的注释食用！&lt;/p&gt;
&lt;p&gt;&lt;img src=</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>llvm IR常用指令二</title>
    <link href="https://straw-233.github.io/2024/02/29/llvm%20IR%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%BA%8C/"/>
    <id>https://straw-233.github.io/2024/02/29/llvm%20IR%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%BA%8C/</id>
    <published>2024-02-29T13:00:58.816Z</published>
    <updated>2024-02-29T13:02:59.516Z</updated>
    
    <content type="html"><![CDATA[<h1 id="llvm-IR常用指令二"><a href="#llvm-IR常用指令二" class="headerlink" title="llvm IR常用指令二"></a>llvm IR常用指令二</h1><h3 id="内存访问和寻址操作"><a href="#内存访问和寻址操作" class="headerlink" title="内存访问和寻址操作"></a>内存访问和寻址操作</h3><h4 id="alloca指令"><a href="#alloca指令" class="headerlink" title="alloca指令"></a>alloca指令</h4><p>&lt; result&gt;&#x3D;alloca &lt; type&gt; [,&lt; ty&gt; &lt; NumElements&gt;] [, align &lt; alignment&gt;];</p><p>分配sizeof(type)*NumElements字节的内存，分配的地址与alignment对齐</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%ptr = alloca i32                  ;分配4字节的内存并返回i32类型的指针</span><br><span class="line">%ptr = alloca i32,i32 4            ;分配4*4字节的内存并返回i32类型的指针</span><br><span class="line">%ptr = alloca i32,i32 4,align 1024 ;分配4*4字节的内存并返回i32类型的指针，分配地址与1024对齐</span><br><span class="line">%ptr = alloca i32,align 1024       ;分配4字节的内存并返回i32类型的指针，分配地址与1024对齐</span><br></pre></td></tr></table></figure><h4 id="store指令"><a href="#store指令" class="headerlink" title="store指令"></a>store指令</h4><p>store &lt; ty&gt; &lt; value&gt;,&lt; ty&gt;* &lt; pointer&gt;;向特定类型指针指向的内存存储相同类型的数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%ptr = alloca i32</span><br><span class="line">store i32 3, i32* %ptr</span><br></pre></td></tr></table></figure><h4 id="load指令"><a href="#load指令" class="headerlink" title="load指令"></a>load指令</h4><p>&lt; result&gt; &#x3D; load &lt; ty&gt;, &lt; ty&gt;* &lt; pointer&gt;;从特定类型的指针指向的内存中读取特定类型的数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%ptr = alloca i32</span><br><span class="line">store i32 3, i32* %ptr</span><br><span class="line">%value = load i32,i32* %ptr</span><br></pre></td></tr></table></figure><h3 id="类型转换指令"><a href="#类型转换指令" class="headerlink" title="类型转换指令"></a>类型转换指令</h3><h4 id="trunc-to指令"><a href="#trunc-to指令" class="headerlink" title="trunc..to指令"></a>trunc..to指令</h4><p>&lt; result&gt; &#x3D; trunc &lt; ty&gt; &lt; value&gt; to &lt; ty2&gt;;将ty类型变量截断为ty2类型的变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%X = trunc i32 257 to i8                      ;i8:1</span><br><span class="line">%Y = trunc i32 123 to i1                      ;i1:true</span><br><span class="line">%Z = trunc i32 122 to i1                      ;i1:false</span><br><span class="line">%W = trunc &lt;2 x i16&gt; &lt;i16 8,i16 7&gt;to&lt;2 x i8&gt;  ;&lt;i8 8,i8 7&gt;</span><br></pre></td></tr></table></figure><h4 id="zext-to指令"><a href="#zext-to指令" class="headerlink" title="zext..to指令"></a>zext..to指令</h4><p>&lt; result&gt; &#x3D; zext &lt; ty&gt; &lt; value&gt; to &lt; ty2&gt;;将ty类型变量拓展为ty2类型的变量，强制转换</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%X = zext i32 257 to i64                       ;i64:257</span><br><span class="line">%Y = zext i1 true to i32                       ;i32:1</span><br><span class="line">%Z = zext &lt;2 x i16&gt; &lt;i16 8,i16 7&gt; to &lt;2 x i32&gt; ;&lt;i32 8,i32 7&gt;</span><br></pre></td></tr></table></figure><h4 id="sext-to指令"><a href="#sext-to指令" class="headerlink" title="sext..to指令"></a>sext..to指令</h4><p>&lt; result&gt;&#x3D; sext &lt; ty&gt; &lt; value&gt; to &lt; ty2&gt;;将ty类型变量拓展为ty2类型的变量，复制符号位</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%X = sext i8 -1 to i64                         ;i64:-1</span><br><span class="line">%Y = sext i1 true to i32                       ;i32:-1</span><br><span class="line">%Z = sext &lt;2 x i16&gt; &lt;i16 8,i16 7&gt; to &lt;2 x i32&gt; ;&lt;i32 8,i32 7&gt;</span><br></pre></td></tr></table></figure><h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><h4 id="phi指令"><a href="#phi指令" class="headerlink" title="phi指令"></a>phi指令</h4><p>由静态单赋值引起的SSA问题，引入phi函数解决</p><p><img src="/../img/llvm2.png" alt="llvm2"></p><p>&lt; result&gt; &#x3D; phi &lt; ty&gt; [ &lt; val0&gt;,&lt; label0&gt;], … ;如果前驱快为label0，则result&#x3D;val0…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Loop:     ; Infinite loop that counts from 0 on up...</span><br><span class="line">%indvar = phi i32[ 0, %LoopHeader ],[ %nextindvar, %Loop ]</span><br><span class="line">%nextindvar = add i32 %indvar,1</span><br><span class="line">br label %Loop   ;phi指令实现for循环</span><br></pre></td></tr></table></figure><h4 id="select指令"><a href="#select指令" class="headerlink" title="select指令"></a>select指令</h4><p>三元运算符</p><p>&lt; result&gt; &#x3D; select i1 &lt; cond&gt;,&lt; ty&gt; &lt; vall&gt;,&lt; ty&gt; &lt; val2&gt;; 如果条件cond成立</p><p>result&#x3D;vall,否则 result&#x3D;val2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%X = select i1 true,i8 17,i8 42    ;i8:17</span><br><span class="line">%X = select i1 flase,i8 17,i8 42   ;i8:42</span><br></pre></td></tr></table></figure><h4 id="call指令"><a href="#call指令" class="headerlink" title="call指令"></a>call指令</h4><p>&lt; result&gt; &#x3D; call &lt; ty&gt;|&lt; fnty&gt; &lt; fnptrval&gt;(&lt; function args&gt;); 调用函数,可以传递参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%retval = call i32 @test(i32 %argc)                  ;调用test函数，参数为i32类型，返回值为i32类型</span><br><span class="line">call i32 (i8*, ...)* @printf(i8* %msg, i32 12,i8 42) ;调用printf函数，参数可变</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;llvm-IR常用指令二&quot;&gt;&lt;a href=&quot;#llvm-IR常用指令二&quot; class=&quot;headerlink&quot; title=&quot;llvm IR常用指令二&quot;&gt;&lt;/a&gt;llvm IR常用指令二&lt;/h1&gt;&lt;h3 id=&quot;内存访问和寻址操作&quot;&gt;&lt;a href=&quot;#内存访问</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>llvm IR常用指令一</title>
    <link href="https://straw-233.github.io/2024/02/28/llvm%20IR%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%B8%80/"/>
    <id>https://straw-233.github.io/2024/02/28/llvm%20IR%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%B8%80/</id>
    <published>2024-02-28T13:26:52.873Z</published>
    <updated>2024-02-29T06:39:56.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="llvm-IR常用指令一"><a href="#llvm-IR常用指令一" class="headerlink" title="llvm IR常用指令一"></a>llvm IR常用指令一</h1><h3 id="终结指令"><a href="#终结指令" class="headerlink" title="终结指令"></a>终结指令</h3><h4 id="ret指令"><a href="#ret指令" class="headerlink" title="ret指令"></a>ret指令</h4><p>ret &lt; type&gt;  &lt; value&gt;;返回特定类型返回值的return指令</p><p>ret void;无返回值的return指令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Test:</span><br><span class="line">ret i32 5;返回整数5</span><br><span class="line">ret void;返回无符号</span><br><span class="line">ret &#123; i32 , i8 &#125; &#123; i32 4 , i8 2 &#125;;返回结构体</span><br></pre></td></tr></table></figure><h4 id="br指令"><a href="#br指令" class="headerlink" title="br指令"></a>br指令</h4><p>br i1 &lt; cond&gt;,label &lt; iftrue&gt;,label &lt; iffalse&gt;;有条件跳转</p><p>br label &lt; dest&gt;;无条件分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Test:</span><br><span class="line">%cond = icmp eq i32 %al,%b</span><br><span class="line">br il %cond,label %IfEqual,label %IfUnequal</span><br><span class="line">IfEqual:</span><br><span class="line">ret i32 1</span><br><span class="line">IfUnequal:</span><br><span class="line">ret i32 0</span><br></pre></td></tr></table></figure><h4 id="icmp指令"><a href="#icmp指令" class="headerlink" title="icmp指令"></a>icmp指令</h4><p>&lt; result&gt; &#x3D; icmp  &lt; cond&gt;  &lt; ty&gt;  &lt; op1&gt;  &lt; op2&gt;;比较两个ty类型的数是否满足条件cond</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Test:</span><br><span class="line">&lt;result&gt; = icmp eq i32 4,5      ;false eq=equal</span><br><span class="line">&lt;result&gt; = icmp ne float* %X %X ;false ne=not equal</span><br><span class="line">&lt;result&gt; = icmp ult i16 4, 5    ;true ult=unsigned less than</span><br><span class="line">&lt;result&gt; = icmp sgt i16 4, 5    ;false sgt=signed greater than</span><br><span class="line">&lt;result&gt; = icmp ule i16 -4, 5   ;false ule=unsigned less or equal</span><br><span class="line">&lt;result&gt; = icmp sge i16 4, 5    ;false sge=signed greater or equal</span><br></pre></td></tr></table></figure><h4 id="fcmp指令"><a href="#fcmp指令" class="headerlink" title="fcmp指令"></a>fcmp指令</h4><p>&lt; result&gt;&#x3D; fcmp &lt; cond&gt;  &lt; ty&gt;  &lt; op1&gt;  &lt; op2&gt;;比较两个浮点数是否满足条件cond</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Test:</span><br><span class="line">&lt;result&gt; = fcmp oeq float 4.0,5.0   ;false oeq=order and equal</span><br><span class="line">&lt;result&gt; = fcmp one float 4.0,5.0   ;true </span><br><span class="line">&lt;result&gt; = fcmp olt float 4.0,5.0   ;true</span><br><span class="line">&lt;result&gt; = fcmp ueq double 1.0,2.0  ;false</span><br></pre></td></tr></table></figure><h4 id="switch指令"><a href="#switch指令" class="headerlink" title="switch指令"></a>switch指令</h4><p>switch &lt; intty&gt; &lt; value&gt;, label &lt; defaultdest&gt; [ &lt; intty&gt;  &lt; val&gt;,label  &lt; dest&gt;…]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Test:</span><br><span class="line">%Val = zext i1 %value to i32</span><br><span class="line">switch i32 %Val,label %truedest[ i32 0,label %falsedest ];与条件跳转等效</span><br><span class="line">switch i32 0,label %dest[ ];与非条件跳转等效</span><br><span class="line">switch i32 %Val,label %otherwise [ i32 0, label %onzero</span><br><span class="line">                                   i32 1, label %onone</span><br><span class="line">                                   i32 2, label %ontwo];三条跳转</span><br></pre></td></tr></table></figure><h3 id="二元运算"><a href="#二元运算" class="headerlink" title="二元运算"></a>二元运算</h3><h4 id="add指令"><a href="#add指令" class="headerlink" title="add指令"></a>add指令</h4><p>&lt; result&gt; &#x3D; add &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt;=add i32 4,%var;4+%var</span><br></pre></td></tr></table></figure><h4 id="sub指令"><a href="#sub指令" class="headerlink" title="sub指令"></a>sub指令</h4><p>&lt; result&gt; &#x3D; sub &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;</p><h4 id="mul指令"><a href="#mul指令" class="headerlink" title="mul指令"></a>mul指令</h4><p>&lt; result&gt; &#x3D; mul &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;</p><h4 id="udiv指令"><a href="#udiv指令" class="headerlink" title="udiv指令"></a>udiv指令</h4><p>&lt; result&gt; &#x3D; udiv &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;;无符号整除</p><p>&lt; result&gt; &#x3D; udiv exact  &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;;如果结果不是整数会报错</p><h4 id="sdiv指令"><a href="#sdiv指令" class="headerlink" title="sdiv指令"></a>sdiv指令</h4><p>&lt; result&gt; &#x3D; sdiv &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;;有符号整除</p><p>&lt; result&gt; &#x3D; sdiv exact  &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;;如果结果不是整数会报错</p><h4 id="urem指令"><a href="#urem指令" class="headerlink" title="urem指令"></a>urem指令</h4><p>&lt; result&gt; &#x3D; urem &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；无符号取余</p><h4 id="srem指令"><a href="#srem指令" class="headerlink" title="srem指令"></a>srem指令</h4><p>&lt; result&gt; &#x3D; srem &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；有 符号取余</p><h3 id="按位二元运算"><a href="#按位二元运算" class="headerlink" title="按位二元运算"></a>按位二元运算</h3><h4 id="shl指令"><a href="#shl指令" class="headerlink" title="shl指令"></a>shl指令</h4><p>&lt; result&gt; &#x3D; shl &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数左移op1&lt;&lt;op2</p><h4 id="lshr指令"><a href="#lshr指令" class="headerlink" title="lshr指令"></a>lshr指令</h4><p>&lt; result&gt; &#x3D; lshr &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数逻辑右移，会变为无符号类型</p><h4 id="ashr指令"><a href="#ashr指令" class="headerlink" title="ashr指令"></a>ashr指令</h4><p>&lt; result&gt; &#x3D; ashr &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数算数右移</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Difference:</span><br><span class="line">&lt;result&gt;=lshr i8 -2,1  ;result=0x7F</span><br><span class="line">&lt;result&gt;=ashr i8 -2,1  ;result=-1</span><br></pre></td></tr></table></figure><h4 id="and指令"><a href="#and指令" class="headerlink" title="and指令"></a>and指令</h4><p>&lt; result&gt; &#x3D; and &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数按位与</p><h4 id="or指令"><a href="#or指令" class="headerlink" title="or指令"></a>or指令</h4><p>&lt; result&gt; &#x3D; or &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数按位或</p><h4 id="xor指令"><a href="#xor指令" class="headerlink" title="xor指令"></a>xor指令</h4><p>&lt; result&gt; &#x3D; ashr &lt; ty&gt;  &lt; op1&gt;, &lt; op2&gt;；整数按位异或</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;llvm-IR常用指令一&quot;&gt;&lt;a href=&quot;#llvm-IR常用指令一&quot; class=&quot;headerlink&quot; title=&quot;llvm IR常用指令一&quot;&gt;&lt;/a&gt;llvm IR常用指令一&lt;/h1&gt;&lt;h3 id=&quot;终结指令&quot;&gt;&lt;a href=&quot;#终结指令&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>java学习（2）</title>
    <link href="https://straw-233.github.io/2023/12/19/java%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89/"/>
    <id>https://straw-233.github.io/2023/12/19/java%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89/</id>
    <published>2023-12-19T13:19:08.557Z</published>
    <updated>2023-12-19T13:18:39.716Z</updated>
    
    <content type="html"><![CDATA[<h1 id="java学习（2）"><a href="#java学习（2）" class="headerlink" title="java学习（2）"></a>java学习（2）</h1><h5 id="外置类"><a href="#外置类" class="headerlink" title="外置类"></a>外置类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> </span><br><span class="line">    &#123;</span><br><span class="line">    Student s=<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;straw&quot;</span>,<span class="number">20</span>);</span><br><span class="line">    System.out.println(s.getAge());</span><br><span class="line">    System.out.println(s.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(age);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name,<span class="type">int</span> age)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.age=age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">20</span><br><span class="line">straw</span><br></pre></td></tr></table></figure><h5 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span>[] arr=&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">        String str=arrToString(arr);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">arrToString</span><span class="params">(<span class="type">int</span>[] arr)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(arr==<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(arr.length==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;[]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String result= <span class="string">&quot;[&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length-<span class="number">1</span>; i++) </span><br><span class="line">        &#123;</span><br><span class="line">            result+=arr[i]+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result=result+arr[arr.length-<span class="number">1</span>]+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1,2,3]</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;java学习（2）&quot;&gt;&lt;a href=&quot;#java学习（2）&quot; class=&quot;headerlink&quot; title=&quot;java学习（2）&quot;&gt;&lt;/a&gt;java学习（2）&lt;/h1&gt;&lt;h5 id=&quot;外置类&quot;&gt;&lt;a href=&quot;#外置类&quot; class=&quot;headerlink</summary>
      
    
    
    
    
  </entry>
  
</feed>
